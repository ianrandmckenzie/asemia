const D="TypographicTinkerer";const x="compositions";let b=null;async function C(){return new Promise((t,a)=>{const e=indexedDB.open(D,1);e.onerror=()=>a(e.error),e.onsuccess=()=>{b=e.result,t(b)},e.onupgradeneeded=n=>{if(b=n.target.result,!b.objectStoreNames.contains(x)){const o=b.createObjectStore(x,{keyPath:"id",autoIncrement:!0});o.createIndex("name","name",{unique:!1}),o.createIndex("created","created",{unique:!1})}}})}async function B(t){return b||await C(),new Promise((a,e)=>{const o=b.transaction([x],"readwrite").objectStore(x),d={...t,saved:new Date().toISOString()},i=o.add(d);i.onsuccess=()=>{console.log("Composition saved to browser:",d.metadata.name),p(`"${d.metadata.name}" saved to browser`,"success"),a(i.result)},i.onerror=()=>{console.error("Failed to save composition:",i.error),p("Failed to save composition","error"),e(i.error)}})}async function O(t){const a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n;const d=`${t.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;o.download=d,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log("Composition downloaded:",t.metadata.name),p(`"${t.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await F(d)}async function F(t){try{const a=await fetch("./archive/manifest.json");let e;a.ok?e=await a.json():e={files:[],lastUpdated:new Date().toISOString().split("T")[0]},e.files.includes(t)||(e.files.push(t),e.files.sort()),e.lastUpdated=new Date().toISOString().split("T")[0];const n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),d=URL.createObjectURL(o),i=document.createElement("a");i.href=d,i.download="manifest.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(d),console.log("📋 Updated manifest downloaded with",e.files.length,"files"),p("Updated manifest.json also downloaded","info")}catch(a){console.warn("Could not generate updated manifest:",a)}}async function v(){return b||await C(),new Promise((t,a)=>{const o=b.transaction([x],"readonly").objectStore(x).getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>a(o.error)})}async function k(t){return b||await C(),new Promise((a,e)=>{const d=b.transaction([x],"readwrite").objectStore(x).delete(t);d.onsuccess=()=>{console.log("Composition deleted from browser:",t),a()},d.onerror=()=>e(d.error)})}function j(t){return{metadata:{name:t||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:E("serifsGrid","serifs"),joins:E("joinsGrid","joins")}}}function E(t,a){const e=document.getElementById(t),n=[];console.log(`Extracting data from ${t}:`,e);for(let o=0;o<e.children.length;o++){const d=e.children[o],i=d.querySelectorAll("img"),r=d.querySelectorAll("svg"),u=d.querySelectorAll('[data-textured="true"]');i.forEach(s=>{if(s.src){const m=s.src,l=m.split("/"),c=l[l.length-1].replace(".svg",""),g=l[l.length-2],y=l[l.length-3];console.log(`Found img in cell ${o}:`,{srcPath:m,fileName:c,angleKey:g,category:y}),n.push({index:o,category:y,angleKey:g,shapeName:c,imagePath:`./assets/shapes/${y}/${g}/${c}.svg`})}}),r.forEach(s=>{console.log(`Found svg in cell ${o}:`,s);const m=s.getAttribute("data-category"),l=s.getAttribute("data-angle-key"),c=s.getAttribute("data-shape-name");m&&l&&c&&n.push({index:o,category:m,angleKey:l,shapeName:c,imagePath:`./assets/shapes/${m}/${l}/${c}.svg`})}),u.forEach(s=>{console.log(`Found textured element in cell ${o}:`,s);const m=s.dataset.category,l=s.dataset.angleKey,c=s.dataset.shapeName,g=s.dataset.textureId;m&&l&&c&&g&&n.push({index:o,category:m,angleKey:l,shapeName:c,imagePath:`./assets/shapes/${m}/${l}/${c}.svg`,texture:{id:g,applied:!0}})})}return console.log(`Extracted ${n.length} shapes from ${t}`),{gridType:a,gridSize:a==="serifs"?5:4,shapes:n}}function M(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=A,t.click()}function A(t){const a=t.target.files[0];if(!a)return;const e=new FileReader;e.onload=function(n){var o;try{const d=JSON.parse(n.target.result);N(d),console.log("Composition loaded from file:",((o=d.metadata)==null?void 0:o.name)||"Unknown")}catch(d){alert("Error loading file: Invalid JSON format"),console.error("Load error:",d)}},e.readAsText(a)}function N(t){var e,n,o;console.log("Loading composition:",t),L(),(e=t.grids)!=null&&e.serifs&&(console.log("Loading serifs grid with",t.grids.serifs.shapes.length,"shapes"),S("serifsGrid",t.grids.serifs)),(n=t.grids)!=null&&n.joins&&(console.log("Loading joins grid with",t.grids.joins.shapes.length,"shapes"),S("joinsGrid",t.grids.joins));const a=((o=t.metadata)==null?void 0:o.name)||"Composition";p(`"${a}" loaded successfully`,"success")}function S(t,a){const e=document.getElementById(t),n={};a.shapes.forEach(o=>{n[o.index]||(n[o.index]=[]),n[o.index].push(o)}),Object.keys(n).forEach(o=>{const d=e.children[o];if(!d)return;n[o].forEach((r,u)=>{var m,l,c;const s={category:r.category,angleKey:r.angleKey,shape:{shape_name:r.shapeName},imagePath:r.imagePath};if((c=(l=(m=window.rulesData)==null?void 0:m.shapes)==null?void 0:l[r.category])!=null&&c[r.angleKey]){const g=window.rulesData.shapes[r.category][r.angleKey].find(y=>y.shape_name===r.shapeName);if(g)if(s.shape=g,window.placeShapeInCell){const y=u>0;if(window.placeShapeInCell(d,s,y),r.texture&&r.texture.applied&&r.texture.id)if(window.texturesData&&window.applyTextureToShape){const f=window.texturesData.textures.find(h=>h.id===r.texture.id);if(f){const h=d.querySelector(`svg[data-shape-name="${r.shapeName}"]`);if(h){const w=window.applyTextureToShape(h,f);w&&w!==h&&(h.parentNode.replaceChild(w,h),console.log(`Applied texture "${f.name}" to shape "${r.shapeName}"`))}else console.warn("Could not find placed SVG to apply texture")}else console.warn(`Texture not found: ${r.texture.id}`)}else console.warn("Texture system not available")}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",r.shapeName)}else console.warn("Category/angleKey not found in rulesData:",r.category,r.angleKey)})})}function L(){const t=document.getElementById("serifsGrid"),a=document.getElementById("joinsGrid");for(let e=0;e<t.children.length;e++)t.children[e].innerHTML="";for(let e=0;e<a.children.length;e++)a.children[e].innerHTML="";console.log("All grids cleared"),p("Grids cleared","info")}function p(t,a="info"){const e=document.createElement("div");e.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${a==="success"?"bg-green-500 dark:bg-green-600":a==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}function $(t,a,e){const n=document.createElement("div");n.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${t}</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4";const r=document.createElement("input");r.type="text",r.placeholder=a,r.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",r.value="",i.appendChild(r);const u=document.createElement("div");u.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const s=document.createElement("button");s.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",s.textContent="Cancel",s.onclick=()=>document.body.removeChild(n);const m=document.createElement("button");m.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",m.textContent="Save";const l=()=>{const c=r.value.trim();c?(document.body.removeChild(n),e(c)):(r.focus(),r.className=r.className+" border-red-500",setTimeout(()=>{r.className=r.className.replace(" border-red-500","")},2e3))};m.onclick=l,r.onkeydown=c=>{c.key==="Enter"?l():c.key==="Escape"&&document.body.removeChild(n)},u.appendChild(s),u.appendChild(m),o.appendChild(d),o.appendChild(i),o.appendChild(u),n.appendChild(o),document.body.appendChild(n),setTimeout(()=>r.focus(),100),n.onclick=c=>{c.target===n&&document.body.removeChild(n)}}async function U(){$("Save Composition","Enter composition name...",async t=>{const a=j(t);try{await B(a)}catch(e){console.error("Save failed:",e),p("Failed to save composition","error")}})}async function G(){$("Save to Computer","Enter composition name...",async t=>{const a=j(t);await O(a)})}async function T(){try{const t=await v();if(t.length===0){p("No saved compositions found in browser","info");return}P(t)}catch(t){console.error("Failed to load compositions:",t),p("Failed to load compositions from browser","error")}}function K(t,a,e){const n=document.createElement("div");n.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4",i.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${t.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const u=document.createElement("button");u.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",u.textContent="Cancel",u.onclick=()=>document.body.removeChild(n);const s=document.createElement("button");s.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",s.textContent="Delete",s.onclick=async()=>{try{await k(t.id),p(`"${t.metadata.name}" deleted`,"success"),document.body.removeChild(n),e()}catch(l){console.error("Delete failed:",l),p("Failed to delete composition","error")}},r.appendChild(u),r.appendChild(s),o.appendChild(d),o.appendChild(i),o.appendChild(r),n.appendChild(o),document.body.appendChild(n),n.onclick=l=>{l.target===n&&document.body.removeChild(n)};const m=l=>{l.key==="Escape"&&(document.body.removeChild(n),document.removeEventListener("keydown",m))};document.addEventListener("keydown",m)}function P(t){const a=document.createElement("div");a.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const o=document.createElement("div");o.className="max-h-64 overflow-y-auto px-6 py-4",t.forEach((r,u)=>{const s=document.createElement("div");s.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const m=new Date(r.saved||r.metadata.created).toLocaleDateString(),l=document.createElement("div");l.className="flex items-center justify-between";const c=document.createElement("button");c.className="flex-1 text-left",c.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${r.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${m}</div>
    `,c.onclick=()=>{N(r),document.body.removeChild(a)};const g=document.createElement("button");g.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",g.innerHTML="🗑️",g.title="Delete composition",g.onclick=y=>{y.stopPropagation(),K(r,a,()=>{document.body.removeChild(a),T()})},l.appendChild(c),l.appendChild(g),s.appendChild(l),o.appendChild(s)});const d=document.createElement("div");d.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(a),d.appendChild(i),e.appendChild(n),e.appendChild(o),e.appendChild(d),a.appendChild(e),document.body.appendChild(a),a.onclick=r=>{r.target===a&&document.body.removeChild(a)}}async function H(){try{if((await v()).length===0){p("No saved compositions found in browser","info");return}const a=document.createElement("div");a.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const o=document.createElement("div");o.className="max-h-64 overflow-y-auto px-6 py-4";const d=async()=>{const u=await v();if(o.innerHTML="",u.length===0){o.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}u.forEach(s=>{const m=document.createElement("div");m.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const l=new Date(s.saved||s.metadata.created).toLocaleDateString(),c=document.createElement("div");c.className="flex items-center justify-between";const g=document.createElement("div");g.className="flex-1",g.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${s.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${l}</div>
        `;const y=document.createElement("div");y.className="flex gap-2 ml-3";const f=document.createElement("button");f.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",f.textContent="Load",f.onclick=()=>{N(s),document.body.removeChild(a)};const h=document.createElement("button");h.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",h.textContent="Delete",h.onclick=async()=>{if(confirm(`Delete "${s.metadata.name}"?`))try{await k(s.id),p(`"${s.metadata.name}" deleted`,"success"),d()}catch(w){console.error("Delete failed:",w),p("Failed to delete composition","error")}},y.appendChild(f),y.appendChild(h),c.appendChild(g),c.appendChild(y),m.appendChild(c),o.appendChild(m)})};await d();const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const r=document.createElement("button");r.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",r.textContent="Close",r.onclick=()=>document.body.removeChild(a),i.appendChild(r),e.appendChild(n),e.appendChild(o),e.appendChild(i),a.appendChild(e),document.body.appendChild(a),a.onclick=u=>{u.target===a&&document.body.removeChild(a)}}catch(t){console.error("Failed to load compositions:",t),p("Failed to load compositions from browser","error")}}function R(){M()}document.addEventListener("DOMContentLoaded",()=>{C().catch(console.error),window.saveComposition=U,window.saveCompositionToComputer=G,window.loadComposition=R,window.loadFromBrowser=T,window.manageCompositions=H,window.clearAllGrids=L,window.getAllCompositions=v,window.deleteFromBrowser=k,window.showNotification=p,console.log("Storage functionality initialized")});console.log("Storage module loaded");
