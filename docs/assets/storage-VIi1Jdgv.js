const ie={"7xl":.6,"6xl":.5,"5xl":.4,"4xl":.3,"3xl":.25,"2xl":.2,xl:.167,lg:.15,base:.133,sm:.117,xs:.1};let X="7xl";async function Z(){if(!document.getElementById("mobileSerifTab")){console.log("Mobile builder not needed on this page (no shape tabs found)");return}if(!window.rulesData){console.warn("rulesData not available yet, waiting..."),setTimeout(Z,50);return}Se(),Ne(),Ie(),le(),window.addEventListener("resize",le),P("serifs"),console.log("Mobile builder initialized")}function Se(){const e=document.getElementById("mobileSerifTab"),t=document.getElementById("mobileBodiesTab"),o=document.getElementById("mobileJoinsTab"),s=document.getElementById("mobileTexturesTab");e&&(K("serifs","mobileSerifShapes"),K("bodies","mobileBodiesShapes"),K("joins","mobileJoinsShapes"),Ce("mobileTexturesShapes"),e.addEventListener("click",()=>P("serifs")),t.addEventListener("click",()=>P("bodies")),o.addEventListener("click",()=>P("joins")),s.addEventListener("click",()=>P("textures")))}function K(e,t){var a;const o=document.getElementById(t);if(!o||!((a=window.rulesData)!=null&&a.shapes))return;const s=e.charAt(0).toUpperCase()+e.slice(1);o.innerHTML=`
    <button id="mobile${s}EraseBtn" class="mobile-shape-btn flex-shrink-0">
      <img src="/assets/icons/erase.svg" alt="Erase ${s}" class="w-6 h-6 dark:invert">
    </button>
  `;const r=window.rulesData.shapes[e];r&&Object.keys(r).forEach(i=>{if(i==="grid")return;r[i].forEach(l=>{const d=Te(e,i,l);o.appendChild(d)})})}function Ce(e){var o;const t=document.getElementById(e);!t||!((o=window.texturesData)!=null&&o.textures)||(t.innerHTML="",window.texturesData.textures.forEach(s=>{const r=Le(s);t.appendChild(r)}))}function Le(e){const t=document.createElement("button");t.className="mobile-shape-btn overflow-hidden",t.dataset.category="textures",t.dataset.textureId=e.id;const o=document.createElement("img");return o.src=`/assets/textures/${e.filename}`,o.alt=e.name,o.className="h-full w-auto object-contain pointer-events-none",t.appendChild(o),t.addEventListener("click",()=>{Be(t,e)}),t}function Be(e,t){typeof O=="function"&&O(),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(s=>{s.classList.remove("selected")}),e.classList.add("selected");const o=document.getElementById("mobileTexturesTab");if(o){const s=o.querySelector(".flex.flex-col");if(s){const r=s.querySelector("svg, img");if(r){const a=document.createElement("img");a.src=`/assets/textures/${t.filename}`,a.alt=t.name,a.className="h-6 w-6 object-cover rounded",r.replaceWith(a)}}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function Te(e,t,o){var a;const s=document.createElement("button");s.className="mobile-shape-btn",s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name;const r=(a=window.SVGUtils)==null?void 0:a.createSVGElement(e,t,o.shape_name,"h-8 w-auto object-contain pointer-events-none");return r?s.appendChild(r):s.textContent=o.shape_name.substring(0,2),s.addEventListener("click",()=>{je(s,e,t,o)}),s}function je(e,t,o,s){typeof O=="function"&&O(),window.clearPendingPlacement&&window.clearPendingPlacement(),document.querySelectorAll(".mobile-shape-btn.selected").forEach(a=>{a.dataset.textureId||a.classList.remove("selected")}),document.querySelectorAll(".shape-selected").forEach(a=>{a.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),e.classList.add("selected");const r={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`};window.setSelectedShape&&window.setSelectedShape(r),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}let Y=null;function P(e){const t={serifs:document.getElementById("mobileSerifTab"),bodies:document.getElementById("mobileBodiesTab"),joins:document.getElementById("mobileJoinsTab"),textures:document.getElementById("mobileTexturesTab")},o={serifs:document.getElementById("mobileSerifShapes"),bodies:document.getElementById("mobileBodiesShapes"),joins:document.getElementById("mobileJoinsShapes"),textures:document.getElementById("mobileTexturesShapes")},s=document.getElementById("mobileShapeSelectorWrapper");if(window.clearPendingPlacement&&window.clearPendingPlacement(),O(),Y===e){s&&s.classList.add("hidden"),Object.keys(t).forEach(r=>{t[r]&&(t[r].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Object.keys(o).forEach(r=>{o[r]&&o[r].classList.add("hidden")}),Y=null;return}Object.keys(o).forEach(r=>{o[r]&&o[r].classList.add("hidden")}),s&&s.classList.remove("hidden"),o[e]&&o[e].classList.remove("hidden"),Object.keys(t).forEach(r=>{t[r]&&(r===e?t[r].className="mobile-tab flex-1 py-3 px-2 bg-white dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700":t[r].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Y=e,window.setCurrentTab&&(e==="bodies"||e==="serifs"?window.setCurrentTab("bodies"):e==="joins"&&window.setCurrentTab("joins")),window.updateGridLayers&&window.updateGridLayers()}function Ne(){const e=document.getElementById("mobileSaveMenuBtn"),t=document.getElementById("mobileSizeBtn"),o=document.getElementById("mobilePreviewBtn"),s=document.getElementById("mobileSaveMenu"),r=document.getElementById("mobileSizeMenu"),a=document.getElementById("closeSaveMenu"),i=document.getElementById("closeSizeMenu");if(e&&s&&a&&(e.addEventListener("click",()=>{const n=s.classList.contains("hidden"),l=s.querySelector(".absolute");n?(s.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},200))}),a.addEventListener("click",()=>{const n=s.querySelector(".absolute");s.classList.add("opacity-0"),n.classList.remove("translate-y-0"),n.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}),s.addEventListener("click",n=>{if(n.target===s){const l=s.querySelector(".absolute");s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}})),t&&r&&i&&(t.addEventListener("click",()=>{const n=r.classList.contains("hidden"),l=r.querySelector(".absolute");n?(r.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(r.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},200))}),i.addEventListener("click",()=>{const n=r.querySelector(".absolute");r.classList.add("opacity-0"),n.classList.remove("translate-y-0"),n.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},150)}),r.addEventListener("click",n=>{if(n.target===r){const l=r.querySelector(".absolute");r.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},150)}})),o){let n=!1;o.addEventListener("click",()=>{n=!n,window.setPreviewMode&&window.setPreviewMode(n);const l=o.querySelector("span"),d=document.getElementById("mobilePreviewIcon");n?(o.classList.add("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-gray-600","dark:text-gray-300"),l.classList.add("text-blue-700","dark:text-blue-300")),d&&(d.src="/assets/icons/eye-slash.svg")):(o.classList.remove("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-blue-700","dark:text-blue-300"),l.classList.add("text-gray-600","dark:text-gray-300")),d&&(d.src="/assets/icons/eye.svg"))})}Me()}let E={serifs:!1,bodies:!1,joins:!1};function Me(){const e={serifs:document.getElementById("mobileSerifsEraseBtn"),bodies:document.getElementById("mobileBodiesEraseBtn"),joins:document.getElementById("mobileJoinsEraseBtn")};Object.entries(e).forEach(([t,o])=>{o&&o.addEventListener("click",()=>{E[t]=!E[t],Object.keys(E).forEach(r=>{r!==t&&(E[r]=!1)}),window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight(),window.clearPendingPlacement&&window.clearPendingPlacement(),ge();const s=document.querySelector(".builder-grids-wrapper");if(s){const r=Object.values(E).some(a=>a);s.style.cursor=r?"crosshair":""}})})}function ge(){[{category:"serifs",id:"mobileSerifsEraseBtn"},{category:"bodies",id:"mobileBodiesEraseBtn"},{category:"joins",id:"mobileJoinsEraseBtn"}].forEach(({category:t,id:o})=>{const s=document.getElementById(o);if(!s)return;const r=s.querySelector("img");E[t]?(s.classList.remove("border-gray-300","dark:border-gray-700"),s.classList.add("border-red-500","dark:border-red-400"),s.style.borderWidth="3px",s.style.boxShadow="0 0 0 2px rgb(254 202 202)",r&&(r.src="/assets/icons/erasing.svg")):(s.classList.remove("border-red-500","dark:border-red-400"),s.classList.add("border-gray-300","dark:border-gray-700"),s.style.borderWidth="",s.style.boxShadow="",r&&(r.src="/assets/icons/erase.svg"))})}function O(){E.serifs=!1,E.bodies=!1,E.joins=!1,window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight(),ge();const e=document.querySelector(".builder-grids-wrapper");e&&(e.style.cursor="")}window.isEraseMode=()=>Object.values(E).some(e=>e);window.getMobileEraseCategory=()=>{for(const[e,t]of Object.entries(E))if(t)return e;return null};window.hideMobileSaveMenu=function(){const e=document.getElementById("mobileSaveMenu"),t=e==null?void 0:e.querySelector(".absolute");e&&t&&(e.classList.add("opacity-0"),t.classList.remove("translate-y-0"),t.classList.add("translate-y-full"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("opacity-0")},150))};function Ie(){const e=document.getElementById("mobileSizeButtons");if(!e)return;["7xl","6xl","5xl","4xl","3xl","2xl","xl","lg","base","sm","xs"].forEach(o=>{const s=document.createElement("button");s.className=`px-4 py-3 rounded-lg text-sm font-medium transition-colors ${o===X?"bg-blue-500 text-white":"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"}`,s.textContent=o,s.addEventListener("click",()=>{X=o,fe(o);const r=document.getElementById("mobileSizeMenu"),a=r.querySelector(".absolute");r.classList.add("opacity-0"),a.classList.remove("translate-y-0"),a.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},150),e.querySelectorAll("button").forEach(i=>{i===s?i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white":i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"})}),e.appendChild(s)})}function fe(e){const t=ie[e]||ie["5xl"],o=document.querySelector(".builder-grids-wrapper");o&&(o.style.transform=`scale(${t})`)}function le(){if(window.innerWidth<768)fe(X);else{const t=document.querySelector(".builder-grids-wrapper");t&&(t.style.transform="scale(1)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(Z,100)}):setTimeout(Z,100);let h=null,I=null,p=null,S=null,B="bodies",C=!1,y={serifs:!1,bodies:!1,joins:!1},G=null,$=null,H=null;const _={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function q(){await be(),await ze(),Pe(),Ae(),Je(),Ke(),Ye(),Re(),A(),window.getCellPosition=ee,window.getCellByPosition=U,window.getOccupiedCells=j,window.clearCellHighlights=F,window.placeShapeInCell=se,window.applyPositioning=R,window.applyTextureToShape=we,window.rulesData=h,window.texturesData=I,window.shapeConfig=_,window.getSelectedShape=()=>p,window.setSelectedShape=e=>{p=e},window.getSelectedTexture=()=>S,window.setSelectedTexture=e=>{S=e},window.handleGridCellClick=oe,window.handleGridCellRightClick=re,window.handleGridCellLeave=te,window.clearPendingEraseHighlight=z,window.clearPendingPlacement=D,window.updateSelectedShapeDisplay=W,window.updateGridLayers=A,window.getCurrentTab=()=>B,window.setCurrentTab=e=>{B=e},window.getPreviewMode=()=>C,window.setPreviewMode=e=>{C=e,document.body.classList.toggle("preview-mode",e)},console.log("Builder functions made globally accessible")}async function _e(){await be(),window.getCellPosition=ee,window.getCellByPosition=U,window.getOccupiedCells=j,window.clearCellHighlights=F,window.placeShapeInCell=se,window.applyPositioning=R,window.rulesData=h,window.shapeConfig=_,console.log("Builder core functions initialized")}async function be(){try{h=await(await fetch("./assets/rules.json")).json()}catch(e){console.error("Failed to load rules.json:",e)}}async function ze(){try{I=await(await fetch("./assets/textures/manifest.json")).json()}catch(e){console.error("Failed to load textures manifest.json:",e)}}function Pe(){Ge(),$e()}function Ge(){const e=document.getElementById("serifsGrid");if(e){e.innerHTML="";for(let t=0;t<25;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="serifs",o.dataset.index=t,o.addEventListener("click",oe),o.addEventListener("contextmenu",re),o.addEventListener("mouseenter",pe),o.addEventListener("mouseleave",te),e.appendChild(o)}}}function $e(){const e=document.getElementById("joinsGrid");if(e){e.innerHTML="";for(let t=0;t<16;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="joins",o.dataset.index=t,o.addEventListener("click",oe),o.addEventListener("contextmenu",re),o.addEventListener("mouseenter",pe),o.addEventListener("mouseleave",te),e.appendChild(o)}}}function Ae(){Oe(),qe(),He(),Ue()}function Oe(){var t;const e=document.getElementById("bodiesShapes");if(e){if(e.innerHTML="",!((t=h==null?void 0:h.shapes)!=null&&t.bodies))return;Object.keys(h.shapes.bodies).forEach(o=>{if(o==="grid")return;h.shapes.bodies[o].forEach(r=>{const a=Q("bodies",o,r);e.appendChild(a)})})}}function qe(){var t;const e=document.getElementById("serifsShapes");if(e){if(e.innerHTML="",!((t=h==null?void 0:h.shapes)!=null&&t.serifs))return;Object.keys(h.shapes.serifs).forEach(o=>{if(o==="grid")return;h.shapes.serifs[o].forEach(r=>{const a=Q("serifs",o,r);e.appendChild(a)})})}}function He(){var t;const e=document.getElementById("joinsShapes");if(e){if(e.innerHTML="",!((t=h==null?void 0:h.shapes)!=null&&t.joins))return;Object.keys(h.shapes.joins).forEach(o=>{if(o==="grid")return;h.shapes.joins[o].forEach(r=>{const a=Q("joins",o,r);e.appendChild(a)})})}}function Ue(){const e=document.getElementById("texturesShapes");if(e){if(e.innerHTML="",!(I!=null&&I.textures))return;I.textures.forEach(t=>{const o=De(t);e.appendChild(o)})}}function De(e){const t=document.createElement("button");t.className="w-full aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden bg-white dark:bg-slate-900 flex flex-col items-center justify-center relative";const o=document.createElement("div");o.className="w-full h-3/4 bg-cover bg-center",o.style.backgroundImage=`url('/assets/textures/${e.filename}')`;const s=document.createElement("div");return s.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",s.textContent=e.name,t.appendChild(o),t.appendChild(s),t.addEventListener("click",()=>{typeof T=="function"&&T(),document.querySelectorAll("#texturesShapes button").forEach(r=>{r.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),r.classList.add("border-gray-300","dark:border-gray-600")}),t.classList.remove("border-gray-300","dark:border-gray-600"),t.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),S=e,W()}),t}function Q(e,t,o){const s=document.createElement("button");s.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let r=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(r=window.SVGUtils.createSVGElement(e,t,o.shape_name,"w-8 h-8 object-contain")),r?(r.setAttribute("alt",o.shape_name),s.appendChild(r)):(s.textContent=o.shape_name.substring(0,2),s.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${e}/${t}/${o.shape_name}, using text fallback`)),s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name,s.dataset.cellOrientation=o.cell_orientation,s.addEventListener("click",()=>Ve(s,e,t,o)),s}function Ve(e,t,o,s){typeof T=="function"&&T(),document.querySelectorAll(".shape-selected").forEach(r=>{r.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),e.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),p={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`},W()}function ee(e,t){if(t==="serifs"){const o=Math.floor(e/5),s=e%5;return{row:o,col:s,gridSize:5}}else if(t==="joins"){const o=Math.floor(e/4),s=e%4;return{row:o,col:s,gridSize:4}}}function U(e,t,o){const s=o==="serifs"?5:4;if(e<0||t<0||e>=s||t>=s)return null;const r=e*s+t;return document.getElementById(o+"Grid").children[r]}function j(e,t){const o=e.dataset.grid,s=parseInt(e.dataset.index),r=ee(s,o),a=t.shape.width||1,i=t.shape.height||1,n=[];if(a===2&&i===1){n.push(e);const l=U(r.row,r.col+1,o);l&&n.push(l)}else if(a===1&&i===2){n.push(e);const l=U(r.row+1,r.col,o);l&&n.push(l)}else n.push(e);return n}function pe(e){if(!p)return;const t=e.currentTarget,o=t.dataset.grid,s=h.shapes[p.category].grid;if(o!==s)return;F(),window.innerWidth>=768?j(t,p).forEach(i=>{i&&(i===t?he(i,p):i.classList.add("cell-highlight-preview"))}):j(t,p).forEach(i=>{i&&i.classList.add("cell-highlight")})}function te(e){F()}function he(e,t){const o="absolute shape-preview";let s=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(s=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,o)),s){s.setAttribute("alt",t.shape.shape_name),s.removeAttribute("width"),s.removeAttribute("height");const r=s.getAttribute("viewBox");if(r){const[,,a,i]=r.split(" ").map(Number);s.style.width=`${a}px`,s.style.height=`${i}px`}R(s,t),s.style.opacity="0.6",s.style.pointerEvents="none",e.appendChild(s)}}function F(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid, .cell-highlight-preview").forEach(e=>{e.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid","cell-highlight-preview")}),document.querySelectorAll(".shape-preview").forEach(e=>{e.remove()}),D()}function oe(e){const t=e.currentTarget,o=y.serifs||y.bodies||y.joins;if(window.isEraseMode&&window.isEraseMode()||o){Fe(t);return}if(z(),!p){alert("Please select a shape from the sidebar first");return}const s=t.dataset.grid,r=h.shapes[p.category].grid;if(s!==r){alert(`This shape can only be placed on the ${r} grid`);return}const a=j(t,p);if(a.some(n=>!n)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(t,p)){console.log("Placement blocked by constraints");return}if(window.innerWidth<768){if($===t&&H===p){D(),de(t,p);return}D(),$=t,H=p,a.forEach(n=>{n&&(n===t?(he(n,p),n.classList.add("cell-placement-pending")):n.classList.add("cell-highlight-preview"))});return}de(t,p)}function de(e,t){const o=j(e,t),r=typeof validateShapeConnections=="function"||t.category!=="bodies"&&t.category!=="joins"||t.shape.width>1||t.shape.height>1;r&&o.forEach(a=>{a&&(a.innerHTML="")}),se(e,t,!r)}function Fe(e){let t=null;if(y.serifs?t="serifs":y.bodies?t="bodies":y.joins&&(t="joins"),window.isEraseMode&&window.isEraseMode()){const s=window.getMobileEraseCategory?window.getMobileEraseCategory():null;s&&(t=s)}if(!t)return;if(G===e){e.querySelectorAll("[data-category]").forEach(r=>{r.dataset.category===t&&r.remove()}),e.innerHTML.trim()===""&&(e.innerHTML=""),z();return}z(),e.querySelector(`[data-category="${t}"]`)&&(G=e,e.classList.add("cell-erase-pending"))}function z(){G&&(G.classList.remove("cell-erase-pending"),G=null)}function D(){$&&(j($,H).forEach(t=>{t&&(t.classList.remove("cell-placement-pending","cell-highlight-preview"),t.querySelectorAll(".shape-preview").forEach(s=>s.remove()))}),$=null,H=null)}function Re(){const e={serifs:document.getElementById("serifsEraseBtn"),bodies:document.getElementById("bodiesEraseBtn"),joins:document.getElementById("joinsEraseBtn")};Object.entries(e).forEach(([t,o])=>{o&&o.addEventListener("click",()=>{y[t]=!y[t],Object.keys(y).forEach(r=>{r!==t&&(y[r]=!1)}),z(),ye();const s=document.querySelector(".builder-grids-wrapper");if(s){const r=Object.values(y).some(a=>a);s.style.cursor=r?"crosshair":""}})})}function ye(){[{category:"serifs",id:"serifsEraseBtn"},{category:"bodies",id:"bodiesEraseBtn"},{category:"joins",id:"joinsEraseBtn"}].forEach(({category:t,id:o})=>{const s=document.getElementById(o);if(!s)return;const r=s.querySelector("img");y[t]?(s.classList.remove("border-gray-300","dark:border-gray-700"),s.classList.remove("hover:border-red-500","dark:hover:border-red-400"),s.classList.remove("hover:bg-red-50","dark:hover:bg-red-900/40"),s.classList.add("bg-red-200","border-red-500","dark:bg-red-800/40","dark:border-red-400"),s.classList.add("hover:bg-red-300","dark:hover:bg-red-700/40"),r&&(r.src="/assets/icons/erasing.svg")):(s.classList.remove("bg-red-200","border-red-500","dark:bg-red-800/40","dark:border-red-400"),s.classList.remove("hover:bg-red-300","dark:hover:bg-red-700/40"),s.classList.add("border-gray-300","dark:border-gray-700"),s.classList.add("hover:border-red-500","dark:hover:border-red-400"),s.classList.add("hover:bg-red-50","dark:hover:bg-red-900/40"),r&&(r.src="/assets/icons/erase.svg"))})}window.isDesktopEraseMode=()=>Object.values(y).some(e=>e);window.getActiveEraseCategory=()=>{for(const[e,t]of Object.entries(y))if(t)return e;return null};function We(e,t){const{angleKey:o,shape:s}=t,r=s.width||1,a=s.height||1,i=s.cell_orientation,n=`${r}x${a}`,l=_.positioning.joins[n];if(!l)return;const d=l[o]||l.default,m=i.includes("top")?"top":"bottom",c=d[m],u=c.vertical.split(": ");e.style[u[0]]=u[1];const g=i.includes("right")?"right":"left",b=c.horizontal[g].split(": ");e.style[b[0]]=b[1],e.style.transform=""}function R(e,t){const{category:o,angleKey:s,shape:r}=t,a=r.width||1,i=r.height||1,n=r.cell_orientation.split(" "),l=n[0],d=n[1];if(e.style.transform="",o==="joins"&&(a===2||i===2))return We(e,t);if(o==="joins"&&a===1&&i===1){const c=_.positioning.joins["1x1"][s];if(c){const u=n.includes("top")?"top":"bottom",g=c[u];if(g){const b=g.vertical.split(": ");e.style[b[0]]=b[1];const v=n.includes("right")?"right":"left",f=g.horizontal[v].split(": ");e.style[f[0]]=f[1],e.style.transform="";return}}e.style.top="-5%",e.style.left="-5%",e.style.transform="";return}if(o==="bodies"&&(a===2||i===2)){e.style.top="0",e.style.left="0",e.style.transform="";return}if(o==="serifs"){const m=_.positioning.serifs[s];if(!m)return ce(e,l,d);if(s==="22_5_deg"){const c=r.shape_name;if(m[c]){const f=m[c];f.left&&(e.style.left=f.left),f.right&&(e.style.right=f.right);const x=f.vertical[l];x&&Object.keys(x).forEach(N=>{e.style[N]=x[N]});return}if(r.cell_orientation.includes("top")||r.cell_orientation.includes("bottom")){const f=m.side,x=f[l]||f.default;Object.keys(x).forEach(M=>{M!=="transform"&&(e.style[M]=x[M])});const N=f.horizontal[d];N&&Object.keys(N).forEach(M=>{e.style[M]=N[M]});return}const g=m.regular,b=g.horizontal[d]||g.horizontal.default,v=g.vertical[l];Object.keys(b).forEach(f=>{e.style[f]=b[f]}),v&&Object.keys(v).forEach(f=>{e.style[f]=v[f]});return}if(s==="45_deg"){const c=r.shape_name,u=m[c];if(u){Object.keys(u).forEach(g=>{e.style[g]=u[g]});return}}}ce(e,l,d)}function ce(e,t,o){const s=_.positioning.standard,r=s.vertical[t];r&&Object.keys(r).forEach(i=>{if(i==="transform"){const n=r[i];e.style.transform=n[o]||n.default}else e.style[i]=r[i]});const a=s.horizontal[o];a&&(Object.keys(a).forEach(i=>{e.style[i]=a[i]}),o==="center"&&t!=="center"&&(e.style.transform="translateX(-50%)"))}function se(e,t,o=!1){o||(e.innerHTML="");const s="absolute";let r=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(r=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,s)),!r){console.warn("Could not create SVG for shape:",t);const i=document.createElement("div");i.textContent=t.shape.shape_name,i.className=s+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",e.appendChild(i);return}r.setAttribute("alt",t.shape.shape_name),r.removeAttribute("width"),r.removeAttribute("height");const a=r.getAttribute("viewBox");if(a){const[,,i,n]=a.split(" ").map(Number);r.style.width=`${i}px`,r.style.height=`${n}px`}if(R(r,t),S){const i=we(r,S);e.appendChild(i)}else e.appendChild(r)}function we(e,t){if(!e||!t)return e;const o=e.cloneNode(!0);o.style.top="",o.style.bottom="",o.style.left="",o.style.right="",o.style.transform="",o.style.position="",o.setAttribute("fill","black"),o.setAttribute("stroke","black"),o.querySelectorAll("*[fill], *[stroke]").forEach(l=>{l.getAttribute("fill")&&l.getAttribute("fill")!=="none"&&l.setAttribute("fill","black"),l.getAttribute("stroke")&&l.getAttribute("stroke")!=="none"&&l.setAttribute("stroke","black")});const r=new XMLSerializer().serializeToString(o),i=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(r)))}`,n=document.createElement("div");return n.className="absolute",n.style.width=e.style.width,n.style.height=e.style.height,n.style.top=e.style.top||"",n.style.bottom=e.style.bottom||"",n.style.left=e.style.left||"",n.style.right=e.style.right||"",n.style.transform=e.style.transform||"",n.style.backgroundImage=`url('/assets/textures/${t.filename}')`,n.style.backgroundSize="cover",n.style.backgroundPosition="center",n.style.webkitMaskImage=`url('${i}')`,n.style.maskImage=`url('${i}')`,n.style.webkitMaskSize="100% 100%",n.style.maskSize="100% 100%",n.style.webkitMaskRepeat="no-repeat",n.style.maskRepeat="no-repeat",n.style.webkitMaskPosition="0 0",n.style.maskPosition="0 0",n.dataset.category=e.dataset.category,n.dataset.angleKey=e.dataset.angleKey,n.dataset.shapeName=e.dataset.shapeName,n.dataset.textured="true",n.dataset.textureId=t.id,n}function Je(){const e=document.getElementById("bodiesTab"),t=document.getElementById("joinsTab"),o=document.getElementById("texturesTab"),s=document.getElementById("bodiesContent"),r=document.getElementById("joinsContent"),a=document.getElementById("texturesContent");e&&(e.addEventListener("click",()=>{B="bodies",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",s.classList.remove("hidden"),r.classList.add("hidden"),a.classList.add("hidden"),T(),A()}),t.addEventListener("click",()=>{B="joins",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",r.classList.remove("hidden"),s.classList.add("hidden"),a.classList.add("hidden"),T(),A()}),o.addEventListener("click",()=>{B="textures",o.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",a.classList.remove("hidden"),s.classList.add("hidden"),r.classList.add("hidden"),T(),A()}))}function T(){y.serifs=!1,y.bodies=!1,y.joins=!1,z(),ye();const e=document.querySelector(".builder-grids-wrapper");e&&(e.style.cursor="")}function re(e){e.preventDefault();const t=e.currentTarget;t.innerHTML=""}function W(){const e=document.getElementById("selectedShapeDisplay"),t=document.getElementById("selectedShapeInfo");if(p||S){e.classList.remove("hidden");let o="";p&&(o+=`Shape: ${p.category} > ${p.angleKey} > ${p.shape.shape_name}`),S&&(o&&(o+="<br>"),o+=`Texture: ${S.name}`),t.innerHTML=o}else e.classList.add("hidden")}function Ke(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{p=null,S=null,document.querySelectorAll(".shape-selected").forEach(t=>{t.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),document.querySelectorAll("#texturesShapes button").forEach(t=>{t.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),t.classList.add("border-gray-300","dark:border-gray-600")}),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(t=>{t.classList.remove("selected")}),W()})}function Ye(){const e=document.getElementById("previewToggle");e&&e.addEventListener("change",o=>{C=o.target.checked,document.body.classList.toggle("preview-mode",C)});const t=document.getElementById("desktopPreviewBtn");t&&t.addEventListener("click",()=>{C=!C,document.body.classList.toggle("preview-mode",C);const o=t.querySelector("span"),s=document.getElementById("desktopPreviewIcon");C?(t.classList.add("bg-blue-100","dark:bg-blue-900"),t.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.add("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-gray-700","dark:text-gray-200"),o.classList.add("text-blue-700","dark:text-blue-300")),s&&(s.src="/assets/icons/eye-slash.svg")):(t.classList.remove("bg-blue-100","dark:bg-blue-900"),t.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.remove("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-blue-700","dark:text-blue-300"),o.classList.add("text-gray-700","dark:text-gray-200")),s&&(s.src="/assets/icons/eye.svg"))})}function A(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");e&&(B==="bodies"?(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")):B==="joins"&&(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?q():(document.addEventListener("svgSystemReady",q),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",q),q())},100))});window.initBuilderCore=_e;const Xe="TypographicTinkerer",Ze=1,L="compositions";let k=null;async function J(){return new Promise((e,t)=>{const o=indexedDB.open(Xe,Ze);o.onerror=()=>t(o.error),o.onsuccess=()=>{k=o.result,e(k)},o.onupgradeneeded=s=>{if(k=s.target.result,!k.objectStoreNames.contains(L)){const r=k.createObjectStore(L,{keyPath:"id",autoIncrement:!0});r.createIndex("name","name",{unique:!1}),r.createIndex("created","created",{unique:!1})}}})}async function Qe(e){return k||await J(),new Promise((t,o)=>{const r=k.transaction([L],"readwrite").objectStore(L),a={...e,saved:new Date().toISOString()},i=r.add(a);i.onsuccess=()=>{console.log("Composition saved to browser:",a.metadata.name),w(`"${a.metadata.name}" saved to browser`,"success"),t(i.result)},i.onerror=()=>{console.error("Failed to save composition:",i.error),w("Failed to save composition","error"),o(i.error)}})}async function et(e){const t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(o),r=document.createElement("a");r.href=s;const a=`${e.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;r.download=a,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(s),console.log("Composition downloaded:",e.metadata.name),w(`"${e.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await tt(a)}async function tt(e){try{const t=await fetch("./archive/manifest.json");let o;t.ok?o=await t.json():o={files:[],lastUpdated:new Date().toISOString().split("T")[0]},o.files.includes(e)||(o.files.push(e),o.files.sort()),o.lastUpdated=new Date().toISOString().split("T")[0];const s=JSON.stringify(o,null,2),r=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(r),i=document.createElement("a");i.href=a,i.download="manifest.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(a),console.log("📋 Updated manifest downloaded with",o.files.length,"files"),w("Updated manifest.json also downloaded","info")}catch(t){console.warn("Could not generate updated manifest:",t)}}async function V(){return k||await J(),new Promise((e,t)=>{const r=k.transaction([L],"readonly").objectStore(L).getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>t(r.error)})}async function ne(e){return k||await J(),new Promise((t,o)=>{const a=k.transaction([L],"readwrite").objectStore(L).delete(e);a.onsuccess=()=>{console.log("Composition deleted from browser:",e),t()},a.onerror=()=>o(a.error)})}function ve(e){return{metadata:{name:e||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:ue("serifsGrid","serifs"),joins:ue("joinsGrid","joins")}}}function ue(e,t){const o=document.getElementById(e),s=[];console.log(`Extracting data from ${e}:`,o);for(let r=0;r<o.children.length;r++){const a=o.children[r],i=a.querySelectorAll("img"),n=a.querySelectorAll("svg"),l=a.querySelectorAll('[data-textured="true"]');i.forEach(d=>{if(d.src){const m=d.src,c=m.split("/"),u=c[c.length-1].replace(".svg",""),g=c[c.length-2],b=c[c.length-3];console.log(`Found img in cell ${r}:`,{srcPath:m,fileName:u,angleKey:g,category:b}),s.push({index:r,category:b,angleKey:g,shapeName:u,imagePath:`./assets/shapes/${b}/${g}/${u}.svg`})}}),n.forEach(d=>{console.log(`Found svg in cell ${r}:`,d);const m=d.getAttribute("data-category"),c=d.getAttribute("data-angle-key"),u=d.getAttribute("data-shape-name");m&&c&&u&&s.push({index:r,category:m,angleKey:c,shapeName:u,imagePath:`./assets/shapes/${m}/${c}/${u}.svg`})}),l.forEach(d=>{console.log(`Found textured element in cell ${r}:`,d);const m=d.dataset.category,c=d.dataset.angleKey,u=d.dataset.shapeName,g=d.dataset.textureId;m&&c&&u&&g&&s.push({index:r,category:m,angleKey:c,shapeName:u,imagePath:`./assets/shapes/${m}/${c}/${u}.svg`,texture:{id:g,applied:!0}})})}return console.log(`Extracted ${s.length} shapes from ${e}`),{gridType:t,gridSize:t==="serifs"?5:4,shapes:s}}function ot(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=st,e.click()}function st(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=function(s){var r;try{const a=JSON.parse(s.target.result);ae(a),console.log("Composition loaded from file:",((r=a.metadata)==null?void 0:r.name)||"Unknown")}catch(a){alert("Error loading file: Invalid JSON format"),console.error("Load error:",a)}},o.readAsText(t)}function ae(e){var o,s,r;console.log("Loading composition:",e),xe(),(o=e.grids)!=null&&o.serifs&&(console.log("Loading serifs grid with",e.grids.serifs.shapes.length,"shapes"),me("serifsGrid",e.grids.serifs)),(s=e.grids)!=null&&s.joins&&(console.log("Loading joins grid with",e.grids.joins.shapes.length,"shapes"),me("joinsGrid",e.grids.joins));const t=((r=e.metadata)==null?void 0:r.name)||"Composition";w(`"${t}" loaded successfully`,"success")}function me(e,t){const o=document.getElementById(e),s={};t.shapes.forEach(r=>{s[r.index]||(s[r.index]=[]),s[r.index].push(r)}),Object.keys(s).forEach(r=>{const a=o.children[r];if(!a)return;s[r].forEach((n,l)=>{var m,c,u;const d={category:n.category,angleKey:n.angleKey,shape:{shape_name:n.shapeName},imagePath:n.imagePath};if((u=(c=(m=window.rulesData)==null?void 0:m.shapes)==null?void 0:c[n.category])!=null&&u[n.angleKey]){const g=window.rulesData.shapes[n.category][n.angleKey].find(b=>b.shape_name===n.shapeName);if(g)if(d.shape=g,window.placeShapeInCell){const b=l>0;if(window.placeShapeInCell(a,d,b),n.texture&&n.texture.applied&&n.texture.id)if(window.texturesData&&window.applyTextureToShape){const v=window.texturesData.textures.find(f=>f.id===n.texture.id);if(v){const f=a.querySelector(`svg[data-shape-name="${n.shapeName}"]`);if(f){const x=window.applyTextureToShape(f,v);x&&x!==f&&(f.parentNode.replaceChild(x,f),console.log(`Applied texture "${v.name}" to shape "${n.shapeName}"`))}else console.warn("Could not find placed SVG to apply texture")}else console.warn(`Texture not found: ${n.texture.id}`)}else console.warn("Texture system not available")}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",n.shapeName)}else console.warn("Category/angleKey not found in rulesData:",n.category,n.angleKey)})})}function xe(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");for(let o=0;o<e.children.length;o++)e.children[o].innerHTML="";for(let o=0;o<t.children.length;o++)t.children[o].innerHTML="";console.log("All grids cleared"),w("Grids cleared","info")}function w(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${t==="success"?"bg-green-500 dark:bg-green-600":t==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)}function Ee(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const r=document.createElement("div");r.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const a=document.createElement("div");a.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",a.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${e}</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4";const n=document.createElement("input");n.type="text",n.placeholder=t,n.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",n.value="",i.appendChild(n);const l=document.createElement("div");l.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const d=document.createElement("button");d.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",d.textContent="Cancel",d.onclick=()=>document.body.removeChild(s);const m=document.createElement("button");m.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",m.textContent="Save";const c=()=>{const u=n.value.trim();u?(document.body.removeChild(s),o(u)):(n.focus(),n.className=n.className+" border-red-500",setTimeout(()=>{n.className=n.className.replace(" border-red-500","")},2e3))};m.onclick=c,n.onkeydown=u=>{u.key==="Enter"?c():u.key==="Escape"&&document.body.removeChild(s)},l.appendChild(d),l.appendChild(m),r.appendChild(a),r.appendChild(i),r.appendChild(l),s.appendChild(r),document.body.appendChild(s),setTimeout(()=>n.focus(),100),s.onclick=u=>{u.target===s&&document.body.removeChild(s)}}async function rt(){Ee("Save Composition","Enter composition name...",async e=>{const t=ve(e);try{await Qe(t)}catch(o){console.error("Save failed:",o),w("Failed to save composition","error")}})}async function nt(){Ee("Save to Computer","Enter composition name...",async e=>{const t=ve(e);await et(t)})}async function ke(){try{const e=await V();if(e.length===0){w("No saved compositions found in browser","info");return}it(e)}catch(e){console.error("Failed to load compositions:",e),w("Failed to load compositions from browser","error")}}function at(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const r=document.createElement("div");r.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const a=document.createElement("div");a.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",a.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4",i.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${e.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const n=document.createElement("div");n.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const l=document.createElement("button");l.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",l.textContent="Cancel",l.onclick=()=>document.body.removeChild(s);const d=document.createElement("button");d.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",d.textContent="Delete",d.onclick=async()=>{try{await ne(e.id),w(`"${e.metadata.name}" deleted`,"success"),document.body.removeChild(s),o()}catch(c){console.error("Delete failed:",c),w("Failed to delete composition","error")}},n.appendChild(l),n.appendChild(d),r.appendChild(a),r.appendChild(i),r.appendChild(n),s.appendChild(r),document.body.appendChild(s),s.onclick=c=>{c.target===s&&document.body.removeChild(s)};const m=c=>{c.key==="Escape"&&(document.body.removeChild(s),document.removeEventListener("keydown",m))};document.addEventListener("keydown",m)}function it(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const r=document.createElement("div");r.className="max-h-64 overflow-y-auto px-6 py-4",e.forEach((n,l)=>{const d=document.createElement("div");d.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const m=new Date(n.saved||n.metadata.created).toLocaleDateString(),c=document.createElement("div");c.className="flex items-center justify-between";const u=document.createElement("button");u.className="flex-1 text-left",u.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${n.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${m}</div>
    `,u.onclick=()=>{ae(n),document.body.removeChild(t)};const g=document.createElement("button");g.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",g.innerHTML="🗑️",g.title="Delete composition",g.onclick=b=>{b.stopPropagation(),at(n,t,()=>{document.body.removeChild(t),ke()})},c.appendChild(u),c.appendChild(g),d.appendChild(c),r.appendChild(d)});const a=document.createElement("div");a.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(t),a.appendChild(i),o.appendChild(s),o.appendChild(r),o.appendChild(a),t.appendChild(o),document.body.appendChild(t),t.onclick=n=>{n.target===t&&document.body.removeChild(t)}}async function lt(){try{if((await V()).length===0){w("No saved compositions found in browser","info");return}const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const r=document.createElement("div");r.className="max-h-64 overflow-y-auto px-6 py-4";const a=async()=>{const l=await V();if(r.innerHTML="",l.length===0){r.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}l.forEach(d=>{const m=document.createElement("div");m.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const c=new Date(d.saved||d.metadata.created).toLocaleDateString(),u=document.createElement("div");u.className="flex items-center justify-between";const g=document.createElement("div");g.className="flex-1",g.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${d.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${c}</div>
        `;const b=document.createElement("div");b.className="flex gap-2 ml-3";const v=document.createElement("button");v.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",v.textContent="Load",v.onclick=()=>{ae(d),document.body.removeChild(t)};const f=document.createElement("button");f.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",f.textContent="Delete",f.onclick=async()=>{if(confirm(`Delete "${d.metadata.name}"?`))try{await ne(d.id),w(`"${d.metadata.name}" deleted`,"success"),a()}catch(x){console.error("Delete failed:",x),w("Failed to delete composition","error")}},b.appendChild(v),b.appendChild(f),u.appendChild(g),u.appendChild(b),m.appendChild(u),r.appendChild(m)})};await a();const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const n=document.createElement("button");n.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",n.textContent="Close",n.onclick=()=>document.body.removeChild(t),i.appendChild(n),o.appendChild(s),o.appendChild(r),o.appendChild(i),t.appendChild(o),document.body.appendChild(t),t.onclick=l=>{l.target===t&&document.body.removeChild(t)}}catch(e){console.error("Failed to load compositions:",e),w("Failed to load compositions from browser","error")}}function dt(){ot()}document.addEventListener("DOMContentLoaded",()=>{J().catch(console.error),window.saveComposition=rt,window.saveCompositionToComputer=nt,window.loadComposition=dt,window.loadFromBrowser=ke,window.manageCompositions=lt,window.clearAllGrids=xe,window.getAllCompositions=V,window.deleteFromBrowser=ne,window.showNotification=w,console.log("Storage functionality initialized")});console.log("Storage module loaded");
