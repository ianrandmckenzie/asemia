const T="TypographicTinkerer";const b="compositions";let y=null;async function w(){return new Promise((t,a)=>{const e=indexedDB.open(T,1);e.onerror=()=>a(e.error),e.onsuccess=()=>{y=e.result,t(y)},e.onupgradeneeded=n=>{if(y=n.target.result,!y.objectStoreNames.contains(b)){const o=y.createObjectStore(b,{keyPath:"id",autoIncrement:!0});o.createIndex("name","name",{unique:!1}),o.createIndex("created","created",{unique:!1})}}})}async function $(t){return y||await w(),new Promise((a,e)=>{const o=y.transaction([b],"readwrite").objectStore(b),d={...t,saved:new Date().toISOString()},s=o.add(d);s.onsuccess=()=>{console.log("Composition saved to browser:",d.metadata.name),p(`"${d.metadata.name}" saved to browser`,"success"),a(s.result)},s.onerror=()=>{console.error("Failed to save composition:",s.error),p("Failed to save composition","error"),e(s.error)}})}async function O(t){const a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),n=URL.createObjectURL(e),o=document.createElement("a");o.href=n;const d=`${t.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;o.download=d,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log("Composition downloaded:",t.metadata.name),p(`"${t.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await M(d)}async function M(t){try{const a=await fetch("./archive/manifest.json");let e;a.ok?e=await a.json():e={files:[],lastUpdated:new Date().toISOString().split("T")[0]},e.files.includes(t)||(e.files.push(t),e.files.sort()),e.lastUpdated=new Date().toISOString().split("T")[0];const n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),d=URL.createObjectURL(o),s=document.createElement("a");s.href=d,s.download="manifest.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(d),console.log("📋 Updated manifest downloaded with",e.files.length,"files"),p("Updated manifest.json also downloaded","info")}catch(a){console.warn("Could not generate updated manifest:",a)}}async function v(){return y||await w(),new Promise((t,a)=>{const o=y.transaction([b],"readonly").objectStore(b).getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>a(o.error)})}async function C(t){return y||await w(),new Promise((a,e)=>{const d=y.transaction([b],"readwrite").objectStore(b).delete(t);d.onsuccess=()=>{console.log("Composition deleted from browser:",t),a()},d.onerror=()=>e(d.error)})}function S(t){return{metadata:{name:t||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:E("serifsGrid","serifs"),joins:E("joinsGrid","joins")}}}function E(t,a){const e=document.getElementById(t),n=[];console.log(`Extracting data from ${t}:`,e);for(let o=0;o<e.children.length;o++){const d=e.children[o],s=d.querySelectorAll("img"),r=d.querySelectorAll("svg");s.forEach(m=>{if(m.src){const c=m.src,l=c.split("/"),i=l[l.length-1].replace(".svg",""),g=l[l.length-2],u=l[l.length-3];console.log(`Found img in cell ${o}:`,{srcPath:c,fileName:i,angleKey:g,category:u}),n.push({index:o,category:u,angleKey:g,shapeName:i,imagePath:`./assets/shapes/${u}/${g}/${i}.svg`})}}),r.forEach(m=>{console.log(`Found svg in cell ${o}:`,m);const c=m.getAttribute("data-category"),l=m.getAttribute("data-angle-key"),i=m.getAttribute("data-shape-name");c&&l&&i&&n.push({index:o,category:c,angleKey:l,shapeName:i,imagePath:`./assets/shapes/${c}/${l}/${i}.svg`})})}return console.log(`Extracted ${n.length} shapes from ${t}`),{gridType:a,gridSize:a==="serifs"?5:4,shapes:n}}function F(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=U,t.click()}function U(t){const a=t.target.files[0];if(!a)return;const e=new FileReader;e.onload=function(n){var o;try{const d=JSON.parse(n.target.result);k(d),console.log("Composition loaded from file:",((o=d.metadata)==null?void 0:o.name)||"Unknown")}catch(d){alert("Error loading file: Invalid JSON format"),console.error("Load error:",d)}},e.readAsText(a)}function k(t){var e,n,o;console.log("Loading composition:",t),j(),(e=t.grids)!=null&&e.serifs&&(console.log("Loading serifs grid with",t.grids.serifs.shapes.length,"shapes"),N("serifsGrid",t.grids.serifs)),(n=t.grids)!=null&&n.joins&&(console.log("Loading joins grid with",t.grids.joins.shapes.length,"shapes"),N("joinsGrid",t.grids.joins));const a=((o=t.metadata)==null?void 0:o.name)||"Composition";p(`"${a}" loaded successfully`,"success")}function N(t,a){const e=document.getElementById(t),n={};a.shapes.forEach(o=>{n[o.index]||(n[o.index]=[]),n[o.index].push(o)}),Object.keys(n).forEach(o=>{const d=e.children[o];if(!d)return;n[o].forEach((r,m)=>{var l,i,g;const c={category:r.category,angleKey:r.angleKey,shape:{shape_name:r.shapeName},imagePath:r.imagePath};if((g=(i=(l=window.rulesData)==null?void 0:l.shapes)==null?void 0:i[r.category])!=null&&g[r.angleKey]){const u=window.rulesData.shapes[r.category][r.angleKey].find(h=>h.shape_name===r.shapeName);if(u)if(c.shape=u,window.placeShapeInCell){const h=m>0;window.placeShapeInCell(d,c,h)}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",r.shapeName)}else console.warn("Category/angleKey not found in rulesData:",r.category,r.angleKey)})})}function j(){const t=document.getElementById("serifsGrid"),a=document.getElementById("joinsGrid");for(let e=0;e<t.children.length;e++)t.children[e].innerHTML="";for(let e=0;e<a.children.length;e++)a.children[e].innerHTML="";console.log("All grids cleared"),p("Grids cleared","info")}function p(t,a="info"){const e=document.createElement("div");e.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${a==="success"?"bg-green-500 dark:bg-green-600":a==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}function L(t,a,e){const n=document.createElement("div");n.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${t}</h3>
  `;const s=document.createElement("div");s.className="px-6 py-4";const r=document.createElement("input");r.type="text",r.placeholder=a,r.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",r.value="",s.appendChild(r);const m=document.createElement("div");m.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const c=document.createElement("button");c.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",c.textContent="Cancel",c.onclick=()=>document.body.removeChild(n);const l=document.createElement("button");l.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",l.textContent="Save";const i=()=>{const g=r.value.trim();g?(document.body.removeChild(n),e(g)):(r.focus(),r.className=r.className+" border-red-500",setTimeout(()=>{r.className=r.className.replace(" border-red-500","")},2e3))};l.onclick=i,r.onkeydown=g=>{g.key==="Enter"?i():g.key==="Escape"&&document.body.removeChild(n)},m.appendChild(c),m.appendChild(l),o.appendChild(d),o.appendChild(s),o.appendChild(m),n.appendChild(o),document.body.appendChild(n),setTimeout(()=>r.focus(),100),n.onclick=g=>{g.target===n&&document.body.removeChild(n)}}async function A(){L("Save Composition","Enter composition name...",async t=>{const a=S(t);try{await $(a)}catch(e){console.error("Save failed:",e),p("Failed to save composition","error")}})}async function G(){L("Save to Computer","Enter composition name...",async t=>{const a=S(t);await O(a)})}async function D(){try{const t=await v();if(t.length===0){p("No saved compositions found in browser","info");return}P(t)}catch(t){console.error("Failed to load compositions:",t),p("Failed to load compositions from browser","error")}}function H(t,a,e){const n=document.createElement("div");n.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const s=document.createElement("div");s.className="px-6 py-4",s.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${t.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const m=document.createElement("button");m.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",m.textContent="Cancel",m.onclick=()=>document.body.removeChild(n);const c=document.createElement("button");c.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",c.textContent="Delete",c.onclick=async()=>{try{await C(t.id),p(`"${t.metadata.name}" deleted`,"success"),document.body.removeChild(n),e()}catch(i){console.error("Delete failed:",i),p("Failed to delete composition","error")}},r.appendChild(m),r.appendChild(c),o.appendChild(d),o.appendChild(s),o.appendChild(r),n.appendChild(o),document.body.appendChild(n),n.onclick=i=>{i.target===n&&document.body.removeChild(n)};const l=i=>{i.key==="Escape"&&(document.body.removeChild(n),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l)}function P(t){const a=document.createElement("div");a.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const o=document.createElement("div");o.className="max-h-64 overflow-y-auto px-6 py-4",t.forEach((r,m)=>{const c=document.createElement("div");c.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const l=new Date(r.saved||r.metadata.created).toLocaleDateString(),i=document.createElement("div");i.className="flex items-center justify-between";const g=document.createElement("button");g.className="flex-1 text-left",g.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${r.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${l}</div>
    `,g.onclick=()=>{k(r),document.body.removeChild(a)};const u=document.createElement("button");u.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",u.innerHTML="🗑️",u.title="Delete composition",u.onclick=h=>{h.stopPropagation(),H(r,a,()=>{document.body.removeChild(a),D()})},i.appendChild(g),i.appendChild(u),c.appendChild(i),o.appendChild(c)});const d=document.createElement("div");d.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const s=document.createElement("button");s.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",s.textContent="Cancel",s.onclick=()=>document.body.removeChild(a),d.appendChild(s),e.appendChild(n),e.appendChild(o),e.appendChild(d),a.appendChild(e),document.body.appendChild(a),a.onclick=r=>{r.target===a&&document.body.removeChild(a)}}async function R(){try{if((await v()).length===0){p("No saved compositions found in browser","info");return}const a=document.createElement("div");a.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const o=document.createElement("div");o.className="max-h-64 overflow-y-auto px-6 py-4";const d=async()=>{const m=await v();if(o.innerHTML="",m.length===0){o.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}m.forEach(c=>{const l=document.createElement("div");l.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const i=new Date(c.saved||c.metadata.created).toLocaleDateString(),g=document.createElement("div");g.className="flex items-center justify-between";const u=document.createElement("div");u.className="flex-1",u.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${c.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${i}</div>
        `;const h=document.createElement("div");h.className="flex gap-2 ml-3";const f=document.createElement("button");f.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",f.textContent="Load",f.onclick=()=>{k(c),document.body.removeChild(a)};const x=document.createElement("button");x.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",x.textContent="Delete",x.onclick=async()=>{if(confirm(`Delete "${c.metadata.name}"?`))try{await C(c.id),p(`"${c.metadata.name}" deleted`,"success"),d()}catch(B){console.error("Delete failed:",B),p("Failed to delete composition","error")}},h.appendChild(f),h.appendChild(x),g.appendChild(u),g.appendChild(h),l.appendChild(g),o.appendChild(l)})};await d();const s=document.createElement("div");s.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const r=document.createElement("button");r.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",r.textContent="Close",r.onclick=()=>document.body.removeChild(a),s.appendChild(r),e.appendChild(n),e.appendChild(o),e.appendChild(s),a.appendChild(e),document.body.appendChild(a),a.onclick=m=>{m.target===a&&document.body.removeChild(a)}}catch(t){console.error("Failed to load compositions:",t),p("Failed to load compositions from browser","error")}}function K(){F()}document.addEventListener("DOMContentLoaded",()=>{w().catch(console.error),window.saveComposition=A,window.saveCompositionToComputer=G,window.loadComposition=K,window.loadFromBrowser=D,window.manageCompositions=R,window.clearAllGrids=j,window.getAllCompositions=v,window.deleteFromBrowser=C,window.showNotification=p,console.log("Storage functionality initialized")});console.log("Storage module loaded");
