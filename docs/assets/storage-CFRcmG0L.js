const oe={"7xl":.6,"6xl":.5,"5xl":.4,"4xl":.3,"3xl":.25,"2xl":.2,xl:.167,lg:.15,base:.133,sm:.117,xs:.1};let R="7xl";async function K(){if(!document.getElementById("mobileSerifTab")){console.log("Mobile builder not needed on this page (no shape tabs found)");return}if(!window.rulesData){console.warn("rulesData not available yet, waiting..."),setTimeout(K,50);return}be(),xe(),Se(),se(),window.addEventListener("resize",se),M("serifs"),console.log("Mobile builder initialized")}function be(){const e=document.getElementById("mobileSerifTab"),t=document.getElementById("mobileBodiesTab"),o=document.getElementById("mobileJoinsTab"),s=document.getElementById("mobileTexturesTab");e&&(V("serifs","mobileSerifShapes"),V("bodies","mobileBodiesShapes"),V("joins","mobileJoinsShapes"),he("mobileTexturesShapes"),e.addEventListener("click",()=>M("serifs")),t.addEventListener("click",()=>M("bodies")),o.addEventListener("click",()=>M("joins")),s.addEventListener("click",()=>M("textures")))}function V(e,t){var a;const o=document.getElementById(t);if(!o||!((a=window.rulesData)!=null&&a.shapes))return;o.innerHTML="";const s=window.rulesData.shapes[e];s&&Object.keys(s).forEach(n=>{if(n==="grid")return;s[n].forEach(r=>{const d=ve(e,n,r);o.appendChild(d)})})}function he(e){var o;const t=document.getElementById(e);!t||!((o=window.texturesData)!=null&&o.textures)||(t.innerHTML="",window.texturesData.textures.forEach(s=>{const a=fe(s);t.appendChild(a)}))}function fe(e){const t=document.createElement("button");t.className="mobile-shape-btn overflow-hidden",t.dataset.category="textures",t.dataset.textureId=e.id;const o=document.createElement("img");return o.src=`/assets/textures/${e.filename}`,o.alt=e.name,o.className="h-full w-auto object-contain pointer-events-none",t.appendChild(o),t.addEventListener("click",()=>{ye(t,e)}),t}function ye(e,t){document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(s=>{s.classList.remove("selected")}),e.classList.add("selected");const o=document.getElementById("mobileTexturesTab");if(o){const s=o.querySelector(".flex.flex-col");if(s){const a=s.querySelector("svg, img");if(a){const n=document.createElement("img");n.src=`/assets/textures/${t.filename}`,n.alt=t.name,n.className="h-6 w-6 object-cover rounded",a.replaceWith(n)}}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function ve(e,t,o){var n;const s=document.createElement("button");s.className="mobile-shape-btn",s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name;const a=(n=window.SVGUtils)==null?void 0:n.createSVGElement(e,t,o.shape_name,"h-8 w-auto object-contain pointer-events-none");return a?s.appendChild(a):s.textContent=o.shape_name.substring(0,2),s.addEventListener("click",()=>{we(s,e,t,o)}),s}function we(e,t,o,s){document.querySelectorAll(".mobile-shape-btn.selected").forEach(n=>{n.dataset.textureId||n.classList.remove("selected")}),document.querySelectorAll(".shape-selected").forEach(n=>{n.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),e.classList.add("selected");const a={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`};window.setSelectedShape&&window.setSelectedShape(a),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}let F=null;function M(e){const t={serifs:document.getElementById("mobileSerifTab"),bodies:document.getElementById("mobileBodiesTab"),joins:document.getElementById("mobileJoinsTab"),textures:document.getElementById("mobileTexturesTab")},o={serifs:document.getElementById("mobileSerifShapes"),bodies:document.getElementById("mobileBodiesShapes"),joins:document.getElementById("mobileJoinsShapes"),textures:document.getElementById("mobileTexturesShapes")},s=document.getElementById("mobileShapeSelectorWrapper");if(F===e){s&&s.classList.add("hidden"),Object.keys(t).forEach(a=>{t[a]&&(t[a].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Object.keys(o).forEach(a=>{o[a]&&o[a].classList.add("hidden")}),F=null;return}Object.keys(o).forEach(a=>{o[a]&&o[a].classList.add("hidden")}),s&&s.classList.remove("hidden"),o[e]&&o[e].classList.remove("hidden"),Object.keys(t).forEach(a=>{t[a]&&(a===e?t[a].className="mobile-tab flex-1 py-3 px-2 bg-white dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700":t[a].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),F=e,window.setCurrentTab&&(e==="bodies"||e==="serifs"?window.setCurrentTab("bodies"):e==="joins"&&window.setCurrentTab("joins")),window.updateGridLayers&&window.updateGridLayers()}function xe(){const e=document.getElementById("mobileSaveMenuBtn"),t=document.getElementById("mobileSizeBtn"),o=document.getElementById("mobilePreviewBtn"),s=document.getElementById("mobileSaveMenu"),a=document.getElementById("mobileSizeMenu"),n=document.getElementById("closeSaveMenu"),i=document.getElementById("closeSizeMenu");if(e&&s&&n&&(e.addEventListener("click",()=>{const d=s.classList.contains("hidden"),l=s.querySelector(".absolute");d?(s.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},200))}),n.addEventListener("click",()=>{const d=s.querySelector(".absolute");s.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}),s.addEventListener("click",d=>{if(d.target===s){const l=s.querySelector(".absolute");s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}})),t&&a&&i&&(t.addEventListener("click",()=>{const d=a.classList.contains("hidden"),l=a.querySelector(".absolute");d?(a.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(a.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{a.classList.add("hidden"),a.classList.remove("opacity-0")},200))}),i.addEventListener("click",()=>{const d=a.querySelector(".absolute");a.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{a.classList.add("hidden"),a.classList.remove("opacity-0")},150)}),a.addEventListener("click",d=>{if(d.target===a){const l=a.querySelector(".absolute");a.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{a.classList.add("hidden"),a.classList.remove("opacity-0")},150)}})),o){let d=!1;o.addEventListener("click",()=>{d=!d,window.setPreviewMode&&window.setPreviewMode(d);const l=o.querySelector("span"),u=document.getElementById("mobilePreviewIcon");d?(o.classList.add("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-gray-600","dark:text-gray-300"),l.classList.add("text-blue-700","dark:text-blue-300")),u&&(u.src="/assets/icons/eye-slash.svg")):(o.classList.remove("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-blue-700","dark:text-blue-300"),l.classList.add("text-gray-600","dark:text-gray-300")),u&&(u.src="/assets/icons/eye.svg"))})}const r=document.getElementById("mobileEraseBtn");r&&ke(r)}let _=!1;function ke(e){e.addEventListener("click",()=>{_=!_,window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight();const t=e.querySelector("span"),o=document.getElementById("mobileEraseIcon");_?(e.classList.add("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-gray-600","dark:text-gray-300"),t.classList.add("text-red-700","dark:text-red-300")),o&&(o.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-600","dark:text-gray-300")),o&&(o.src="/assets/icons/erase.svg"));const s=document.querySelector(".builder-grids-wrapper");s&&(_?s.style.cursor="crosshair":s.style.cursor="")})}window.isEraseMode=()=>_;window.hideMobileSaveMenu=function(){const e=document.getElementById("mobileSaveMenu"),t=e==null?void 0:e.querySelector(".absolute");e&&t&&(e.classList.add("opacity-0"),t.classList.remove("translate-y-0"),t.classList.add("translate-y-full"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("opacity-0")},150))};function Se(){const e=document.getElementById("mobileSizeButtons");if(!e)return;["7xl","6xl","5xl","4xl","3xl","2xl","xl","lg","base","sm","xs"].forEach(o=>{const s=document.createElement("button");s.className=`px-4 py-3 rounded-lg text-sm font-medium transition-colors ${o===R?"bg-blue-500 text-white":"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"}`,s.textContent=o,s.addEventListener("click",()=>{R=o,ie(o);const a=document.getElementById("mobileSizeMenu"),n=a.querySelector(".absolute");a.classList.add("opacity-0"),n.classList.remove("translate-y-0"),n.classList.add("translate-y-full"),setTimeout(()=>{a.classList.add("hidden"),a.classList.remove("opacity-0")},150),e.querySelectorAll("button").forEach(i=>{i===s?i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white":i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"})}),e.appendChild(s)})}function ie(e){const t=oe[e]||oe["5xl"],o=document.querySelector(".builder-grids-wrapper");o&&(o.style.transform=`scale(${t})`)}function se(){if(window.innerWidth<768)ie(R);else{const t=document.querySelector(".builder-grids-wrapper");t&&(t.style.transform="scale(1)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(K,100)}):setTimeout(K,100);let f=null,T=null,h=null,k=null,L="bodies",S=!1,N=!1,I=null;const j={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function A(){await le(),await Le(),Ce(),Ne(),Oe(),He(),De(),Pe(),z(),window.getCellPosition=J,window.getCellByPosition=P,window.getOccupiedCells=G,window.clearCellHighlights=O,window.placeShapeInCell=Z,window.applyPositioning=H,window.applyTextureToShape=ce,window.rulesData=f,window.texturesData=T,window.shapeConfig=j,window.getSelectedShape=()=>h,window.setSelectedShape=e=>{h=e},window.getSelectedTexture=()=>k,window.setSelectedTexture=e=>{k=e},window.handleGridCellClick=X,window.handleGridCellRightClick=Q,window.handleGridCellLeave=Y,window.clearPendingEraseHighlight=$,window.updateSelectedShapeDisplay=D,window.updateGridLayers=z,window.getCurrentTab=()=>L,window.setCurrentTab=e=>{L=e},window.getPreviewMode=()=>S,window.setPreviewMode=e=>{S=e,document.body.classList.toggle("preview-mode",e)},console.log("Builder functions made globally accessible")}async function Ee(){await le(),window.getCellPosition=J,window.getCellByPosition=P,window.getOccupiedCells=G,window.clearCellHighlights=O,window.placeShapeInCell=Z,window.applyPositioning=H,window.rulesData=f,window.shapeConfig=j,console.log("Builder core functions initialized")}async function le(){try{f=await(await fetch("./assets/rules.json")).json()}catch(e){console.error("Failed to load rules.json:",e)}}async function Le(){try{T=await(await fetch("./assets/textures/manifest.json")).json()}catch(e){console.error("Failed to load textures manifest.json:",e)}}function Ce(){Be(),Te()}function Be(){const e=document.getElementById("serifsGrid");if(e){e.innerHTML="";for(let t=0;t<25;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="serifs",o.dataset.index=t,o.addEventListener("click",X),o.addEventListener("contextmenu",Q),o.addEventListener("mouseenter",de),o.addEventListener("mouseleave",Y),e.appendChild(o)}}}function Te(){const e=document.getElementById("joinsGrid");if(e){e.innerHTML="";for(let t=0;t<16;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="joins",o.dataset.index=t,o.addEventListener("click",X),o.addEventListener("contextmenu",Q),o.addEventListener("mouseenter",de),o.addEventListener("mouseleave",Y),e.appendChild(o)}}}function Ne(){je(),Me(),_e(),Ie()}function je(){var t;const e=document.getElementById("bodiesShapes");if(e){if(e.innerHTML="",!((t=f==null?void 0:f.shapes)!=null&&t.bodies))return;Object.keys(f.shapes.bodies).forEach(o=>{if(o==="grid")return;f.shapes.bodies[o].forEach(a=>{const n=W("bodies",o,a);e.appendChild(n)})})}}function Me(){var t;const e=document.getElementById("serifsShapes");if(e){if(e.innerHTML="",!((t=f==null?void 0:f.shapes)!=null&&t.serifs))return;Object.keys(f.shapes.serifs).forEach(o=>{if(o==="grid")return;f.shapes.serifs[o].forEach(a=>{const n=W("serifs",o,a);e.appendChild(n)})})}}function _e(){var t;const e=document.getElementById("joinsShapes");if(e){if(e.innerHTML="",!((t=f==null?void 0:f.shapes)!=null&&t.joins))return;Object.keys(f.shapes.joins).forEach(o=>{if(o==="grid")return;f.shapes.joins[o].forEach(a=>{const n=W("joins",o,a);e.appendChild(n)})})}}function Ie(){const e=document.getElementById("texturesShapes");if(e){if(e.innerHTML="",!(T!=null&&T.textures))return;T.textures.forEach(t=>{const o=ze(t);e.appendChild(o)})}}function ze(e){const t=document.createElement("button");t.className="w-full aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden bg-white dark:bg-slate-900 flex flex-col items-center justify-center relative";const o=document.createElement("div");o.className="w-full h-3/4 bg-cover bg-center",o.style.backgroundImage=`url('/assets/textures/${e.filename}')`;const s=document.createElement("div");return s.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",s.textContent=e.name,t.appendChild(o),t.appendChild(s),t.addEventListener("click",()=>{document.querySelectorAll("#texturesShapes button").forEach(a=>{a.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),a.classList.add("border-gray-300","dark:border-gray-600")}),t.classList.remove("border-gray-300","dark:border-gray-600"),t.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),k=e,D()}),t}function W(e,t,o){const s=document.createElement("button");s.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let a=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(a=window.SVGUtils.createSVGElement(e,t,o.shape_name,"w-8 h-8 object-contain")),a?(a.setAttribute("alt",o.shape_name),s.appendChild(a)):(s.textContent=o.shape_name.substring(0,2),s.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${e}/${t}/${o.shape_name}, using text fallback`)),s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name,s.dataset.cellOrientation=o.cell_orientation,s.addEventListener("click",()=>Ge(s,e,t,o)),s}function Ge(e,t,o,s){document.querySelectorAll(".shape-selected").forEach(a=>{a.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),e.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),h={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`},D()}function J(e,t){if(t==="serifs"){const o=Math.floor(e/5),s=e%5;return{row:o,col:s,gridSize:5}}else if(t==="joins"){const o=Math.floor(e/4),s=e%4;return{row:o,col:s,gridSize:4}}}function P(e,t,o){const s=o==="serifs"?5:4;if(e<0||t<0||e>=s||t>=s)return null;const a=e*s+t;return document.getElementById(o+"Grid").children[a]}function G(e,t){const o=e.dataset.grid,s=parseInt(e.dataset.index),a=J(s,o),n=t.shape.width||1,i=t.shape.height||1,r=[];if(n===2&&i===1){r.push(e);const d=P(a.row,a.col+1,o);d&&r.push(d)}else if(n===1&&i===2){r.push(e);const d=P(a.row+1,a.col,o);d&&r.push(d)}else r.push(e);return r}function de(e){if(!h)return;const t=e.currentTarget,o=t.dataset.grid,s=f.shapes[h.category].grid;if(o!==s)return;O(),window.innerWidth>=768?G(t,h).forEach(i=>{i&&(i===t?$e(i,h):i.classList.add("cell-highlight-preview"))}):G(t,h).forEach(i=>{i&&i.classList.add("cell-highlight")})}function Y(e){O()}function $e(e,t){const o="absolute shape-preview";let s=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(s=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,o)),s){s.setAttribute("alt",t.shape.shape_name),s.removeAttribute("width"),s.removeAttribute("height");const a=s.getAttribute("viewBox");if(a){const[,,n,i]=a.split(" ").map(Number);s.style.width=`${n}px`,s.style.height=`${i}px`}H(s,t),s.style.opacity="0.6",s.style.pointerEvents="none",e.appendChild(s)}}function O(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid, .cell-highlight-preview").forEach(e=>{e.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid","cell-highlight-preview")}),document.querySelectorAll(".shape-preview").forEach(e=>{e.remove()})}function X(e){const t=e.currentTarget;if(window.isEraseMode&&window.isEraseMode()||N){Ae(t);return}if($(),!h){alert("Please select a shape from the sidebar first");return}const o=t.dataset.grid,s=f.shapes[h.category].grid;if(o!==s){alert(`This shape can only be placed on the ${s} grid`);return}const a=G(t,h);if(a.some(r=>!r)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(t,h)){console.log("Placement blocked by constraints");return}const i=typeof validateShapeConnections=="function"||h.category!=="bodies"&&h.category!=="joins"||h.shape.width>1||h.shape.height>1;i&&a.forEach(r=>{r&&(r.innerHTML="")}),Z(t,h,!i)}function Ae(e){if(I===e){e.innerHTML="",$();return}$(),e.innerHTML.trim()!==""&&(I=e,e.classList.add("cell-erase-pending"))}function $(){I&&(I.classList.remove("cell-erase-pending"),I=null)}function Pe(){const e=document.getElementById("desktopEraseBtn");e&&e.addEventListener("click",()=>{N=!N,$();const t=e.querySelector("span"),o=document.getElementById("desktopEraseIcon");N?(e.classList.add("bg-red-100","dark:bg-red-900"),e.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.add("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-gray-700","dark:text-gray-200"),t.classList.add("text-red-700","dark:text-red-300")),o&&(o.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),e.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.remove("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-700","dark:text-gray-200")),o&&(o.src="/assets/icons/erase.svg"));const s=document.querySelector(".builder-grids-wrapper");s&&(N?s.style.cursor="crosshair":s.style.cursor="")})}window.isDesktopEraseMode=()=>N;function qe(e,t){const{angleKey:o,shape:s}=t,a=s.width||1,n=s.height||1,i=s.cell_orientation,r=`${a}x${n}`,d=j.positioning.joins[r];if(!d)return;const l=d[o]||d.default,u=i.includes("top")?"top":"bottom",c=l[u],m=c.vertical.split(": ");e.style[m[0]]=m[1];const g=i.includes("right")?"right":"left",b=c.horizontal[g].split(": ");e.style[b[0]]=b[1],e.style.transform=""}function H(e,t){const{category:o,angleKey:s,shape:a}=t,n=a.width||1,i=a.height||1,r=a.cell_orientation.split(" "),d=r[0],l=r[1];if(e.style.transform="",o==="joins"&&(n===2||i===2))return qe(e,t);if(o==="joins"&&n===1&&i===1){const c=j.positioning.joins["1x1"][s];if(c){const m=r.includes("top")?"top":"bottom",g=c[m];if(g){const b=g.vertical.split(": ");e.style[b[0]]=b[1];const v=r.includes("right")?"right":"left",p=g.horizontal[v].split(": ");e.style[p[0]]=p[1],e.style.transform="";return}}e.style.top="-5%",e.style.left="-5%",e.style.transform="";return}if(o==="bodies"&&(n===2||i===2)){e.style.top="0",e.style.left="0",e.style.transform="";return}if(o==="serifs"){const u=j.positioning.serifs[s];if(!u)return ae(e,d,l);if(s==="22_5_deg"){const c=a.shape_name;if(u[c]){const p=u[c];p.left&&(e.style.left=p.left),p.right&&(e.style.right=p.right);const w=p.vertical[d];w&&Object.keys(w).forEach(C=>{e.style[C]=w[C]});return}if(a.cell_orientation.includes("top")||a.cell_orientation.includes("bottom")){const p=u.side,w=p[d]||p.default;Object.keys(w).forEach(B=>{B!=="transform"&&(e.style[B]=w[B])});const C=p.horizontal[l];C&&Object.keys(C).forEach(B=>{e.style[B]=C[B]});return}const g=u.regular,b=g.horizontal[l]||g.horizontal.default,v=g.vertical[d];Object.keys(b).forEach(p=>{e.style[p]=b[p]}),v&&Object.keys(v).forEach(p=>{e.style[p]=v[p]});return}if(s==="45_deg"){const c=a.shape_name,m=u[c];if(m){Object.keys(m).forEach(g=>{e.style[g]=m[g]});return}}}ae(e,d,l)}function ae(e,t,o){const s=j.positioning.standard,a=s.vertical[t];a&&Object.keys(a).forEach(i=>{if(i==="transform"){const r=a[i];e.style.transform=r[o]||r.default}else e.style[i]=a[i]});const n=s.horizontal[o];n&&(Object.keys(n).forEach(i=>{e.style[i]=n[i]}),o==="center"&&t!=="center"&&(e.style.transform="translateX(-50%)"))}function Z(e,t,o=!1){o||(e.innerHTML="");const s="absolute";let a=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(a=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,s)),!a){console.warn("Could not create SVG for shape:",t);const i=document.createElement("div");i.textContent=t.shape.shape_name,i.className=s+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",e.appendChild(i);return}a.setAttribute("alt",t.shape.shape_name),a.removeAttribute("width"),a.removeAttribute("height");const n=a.getAttribute("viewBox");if(n){const[,,i,r]=n.split(" ").map(Number);a.style.width=`${i}px`,a.style.height=`${r}px`}if(H(a,t),k){const i=ce(a,k);e.appendChild(i)}else e.appendChild(a)}function ce(e,t){if(!e||!t)return e;const o=e.cloneNode(!0);o.style.top="",o.style.bottom="",o.style.left="",o.style.right="",o.style.transform="",o.style.position="",o.setAttribute("fill","black"),o.setAttribute("stroke","black"),o.querySelectorAll("*[fill], *[stroke]").forEach(d=>{d.getAttribute("fill")&&d.getAttribute("fill")!=="none"&&d.setAttribute("fill","black"),d.getAttribute("stroke")&&d.getAttribute("stroke")!=="none"&&d.setAttribute("stroke","black")});const a=new XMLSerializer().serializeToString(o),i=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(a)))}`,r=document.createElement("div");return r.className="absolute",r.style.width=e.style.width,r.style.height=e.style.height,r.style.top=e.style.top||"",r.style.bottom=e.style.bottom||"",r.style.left=e.style.left||"",r.style.right=e.style.right||"",r.style.transform=e.style.transform||"",r.style.backgroundImage=`url('/assets/textures/${t.filename}')`,r.style.backgroundSize="cover",r.style.backgroundPosition="center",r.style.webkitMaskImage=`url('${i}')`,r.style.maskImage=`url('${i}')`,r.style.webkitMaskSize="100% 100%",r.style.maskSize="100% 100%",r.style.webkitMaskRepeat="no-repeat",r.style.maskRepeat="no-repeat",r.style.webkitMaskPosition="0 0",r.style.maskPosition="0 0",r.dataset.category=e.dataset.category,r.dataset.angleKey=e.dataset.angleKey,r.dataset.shapeName=e.dataset.shapeName,r.dataset.textured="true",r.dataset.textureId=t.id,r}function Oe(){const e=document.getElementById("bodiesTab"),t=document.getElementById("joinsTab"),o=document.getElementById("texturesTab"),s=document.getElementById("bodiesContent"),a=document.getElementById("joinsContent"),n=document.getElementById("texturesContent");e&&(e.addEventListener("click",()=>{L="bodies",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",s.classList.remove("hidden"),a.classList.add("hidden"),n.classList.add("hidden"),z()}),t.addEventListener("click",()=>{L="joins",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",a.classList.remove("hidden"),s.classList.add("hidden"),n.classList.add("hidden"),z()}),o.addEventListener("click",()=>{L="textures",o.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",n.classList.remove("hidden"),s.classList.add("hidden"),a.classList.add("hidden"),z()}))}function Q(e){e.preventDefault();const t=e.currentTarget;t.innerHTML=""}function D(){const e=document.getElementById("selectedShapeDisplay"),t=document.getElementById("selectedShapeInfo");if(h||k){e.classList.remove("hidden");let o="";h&&(o+=`Shape: ${h.category} > ${h.angleKey} > ${h.shape.shape_name}`),k&&(o&&(o+="<br>"),o+=`Texture: ${k.name}`),t.innerHTML=o}else e.classList.add("hidden")}function He(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{h=null,k=null,document.querySelectorAll(".shape-selected").forEach(t=>{t.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),document.querySelectorAll("#texturesShapes button").forEach(t=>{t.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),t.classList.add("border-gray-300","dark:border-gray-600")}),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(t=>{t.classList.remove("selected")}),D()})}function De(){const e=document.getElementById("previewToggle");e&&e.addEventListener("change",o=>{S=o.target.checked,document.body.classList.toggle("preview-mode",S)});const t=document.getElementById("desktopPreviewBtn");t&&t.addEventListener("click",()=>{S=!S,document.body.classList.toggle("preview-mode",S);const o=t.querySelector("span"),s=document.getElementById("desktopPreviewIcon");S?(t.classList.add("bg-blue-100","dark:bg-blue-900"),t.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.add("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-gray-700","dark:text-gray-200"),o.classList.add("text-blue-700","dark:text-blue-300")),s&&(s.src="/assets/icons/eye-slash.svg")):(t.classList.remove("bg-blue-100","dark:bg-blue-900"),t.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.remove("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-blue-700","dark:text-blue-300"),o.classList.add("text-gray-700","dark:text-gray-200")),s&&(s.src="/assets/icons/eye.svg"))})}function z(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");e&&(L==="bodies"?(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")):L==="joins"&&(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?A():(document.addEventListener("svgSystemReady",A),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",A),A())},100))});window.initBuilderCore=Ee;const Ue="TypographicTinkerer",Ve=1,E="compositions";let x=null;async function U(){return new Promise((e,t)=>{const o=indexedDB.open(Ue,Ve);o.onerror=()=>t(o.error),o.onsuccess=()=>{x=o.result,e(x)},o.onupgradeneeded=s=>{if(x=s.target.result,!x.objectStoreNames.contains(E)){const a=x.createObjectStore(E,{keyPath:"id",autoIncrement:!0});a.createIndex("name","name",{unique:!1}),a.createIndex("created","created",{unique:!1})}}})}async function Fe(e){return x||await U(),new Promise((t,o)=>{const a=x.transaction([E],"readwrite").objectStore(E),n={...e,saved:new Date().toISOString()},i=a.add(n);i.onsuccess=()=>{console.log("Composition saved to browser:",n.metadata.name),y(`"${n.metadata.name}" saved to browser`,"success"),t(i.result)},i.onerror=()=>{console.error("Failed to save composition:",i.error),y("Failed to save composition","error"),o(i.error)}})}async function Re(e){const t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(o),a=document.createElement("a");a.href=s;const n=`${e.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;a.download=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),console.log("Composition downloaded:",e.metadata.name),y(`"${e.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await Ke(n)}async function Ke(e){try{const t=await fetch("./archive/manifest.json");let o;t.ok?o=await t.json():o={files:[],lastUpdated:new Date().toISOString().split("T")[0]},o.files.includes(e)||(o.files.push(e),o.files.sort()),o.lastUpdated=new Date().toISOString().split("T")[0];const s=JSON.stringify(o,null,2),a=new Blob([s],{type:"application/json"}),n=URL.createObjectURL(a),i=document.createElement("a");i.href=n,i.download="manifest.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n),console.log("📋 Updated manifest downloaded with",o.files.length,"files"),y("Updated manifest.json also downloaded","info")}catch(t){console.warn("Could not generate updated manifest:",t)}}async function q(){return x||await U(),new Promise((e,t)=>{const a=x.transaction([E],"readonly").objectStore(E).getAll();a.onsuccess=()=>e(a.result),a.onerror=()=>t(a.error)})}async function ee(e){return x||await U(),new Promise((t,o)=>{const n=x.transaction([E],"readwrite").objectStore(E).delete(e);n.onsuccess=()=>{console.log("Composition deleted from browser:",e),t()},n.onerror=()=>o(n.error)})}function ue(e){return{metadata:{name:e||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:re("serifsGrid","serifs"),joins:re("joinsGrid","joins")}}}function re(e,t){const o=document.getElementById(e),s=[];console.log(`Extracting data from ${e}:`,o);for(let a=0;a<o.children.length;a++){const n=o.children[a],i=n.querySelectorAll("img"),r=n.querySelectorAll("svg"),d=n.querySelectorAll('[data-textured="true"]');i.forEach(l=>{if(l.src){const u=l.src,c=u.split("/"),m=c[c.length-1].replace(".svg",""),g=c[c.length-2],b=c[c.length-3];console.log(`Found img in cell ${a}:`,{srcPath:u,fileName:m,angleKey:g,category:b}),s.push({index:a,category:b,angleKey:g,shapeName:m,imagePath:`./assets/shapes/${b}/${g}/${m}.svg`})}}),r.forEach(l=>{console.log(`Found svg in cell ${a}:`,l);const u=l.getAttribute("data-category"),c=l.getAttribute("data-angle-key"),m=l.getAttribute("data-shape-name");u&&c&&m&&s.push({index:a,category:u,angleKey:c,shapeName:m,imagePath:`./assets/shapes/${u}/${c}/${m}.svg`})}),d.forEach(l=>{console.log(`Found textured element in cell ${a}:`,l);const u=l.dataset.category,c=l.dataset.angleKey,m=l.dataset.shapeName,g=l.dataset.textureId;u&&c&&m&&g&&s.push({index:a,category:u,angleKey:c,shapeName:m,imagePath:`./assets/shapes/${u}/${c}/${m}.svg`,texture:{id:g,applied:!0}})})}return console.log(`Extracted ${s.length} shapes from ${e}`),{gridType:t,gridSize:t==="serifs"?5:4,shapes:s}}function We(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=Je,e.click()}function Je(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=function(s){var a;try{const n=JSON.parse(s.target.result);te(n),console.log("Composition loaded from file:",((a=n.metadata)==null?void 0:a.name)||"Unknown")}catch(n){alert("Error loading file: Invalid JSON format"),console.error("Load error:",n)}},o.readAsText(t)}function te(e){var o,s,a;console.log("Loading composition:",e),me(),(o=e.grids)!=null&&o.serifs&&(console.log("Loading serifs grid with",e.grids.serifs.shapes.length,"shapes"),ne("serifsGrid",e.grids.serifs)),(s=e.grids)!=null&&s.joins&&(console.log("Loading joins grid with",e.grids.joins.shapes.length,"shapes"),ne("joinsGrid",e.grids.joins));const t=((a=e.metadata)==null?void 0:a.name)||"Composition";y(`"${t}" loaded successfully`,"success")}function ne(e,t){const o=document.getElementById(e),s={};t.shapes.forEach(a=>{s[a.index]||(s[a.index]=[]),s[a.index].push(a)}),Object.keys(s).forEach(a=>{const n=o.children[a];if(!n)return;s[a].forEach((r,d)=>{var u,c,m;const l={category:r.category,angleKey:r.angleKey,shape:{shape_name:r.shapeName},imagePath:r.imagePath};if((m=(c=(u=window.rulesData)==null?void 0:u.shapes)==null?void 0:c[r.category])!=null&&m[r.angleKey]){const g=window.rulesData.shapes[r.category][r.angleKey].find(b=>b.shape_name===r.shapeName);if(g)if(l.shape=g,window.placeShapeInCell){const b=d>0;if(window.placeShapeInCell(n,l,b),r.texture&&r.texture.applied&&r.texture.id)if(window.texturesData&&window.applyTextureToShape){const v=window.texturesData.textures.find(p=>p.id===r.texture.id);if(v){const p=n.querySelector(`svg[data-shape-name="${r.shapeName}"]`);if(p){const w=window.applyTextureToShape(p,v);w&&w!==p&&(p.parentNode.replaceChild(w,p),console.log(`Applied texture "${v.name}" to shape "${r.shapeName}"`))}else console.warn("Could not find placed SVG to apply texture")}else console.warn(`Texture not found: ${r.texture.id}`)}else console.warn("Texture system not available")}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",r.shapeName)}else console.warn("Category/angleKey not found in rulesData:",r.category,r.angleKey)})})}function me(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");for(let o=0;o<e.children.length;o++)e.children[o].innerHTML="";for(let o=0;o<t.children.length;o++)t.children[o].innerHTML="";console.log("All grids cleared"),y("Grids cleared","info")}function y(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${t==="success"?"bg-green-500 dark:bg-green-600":t==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)}function ge(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const a=document.createElement("div");a.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${e}</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4";const r=document.createElement("input");r.type="text",r.placeholder=t,r.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",r.value="",i.appendChild(r);const d=document.createElement("div");d.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const l=document.createElement("button");l.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",l.textContent="Cancel",l.onclick=()=>document.body.removeChild(s);const u=document.createElement("button");u.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",u.textContent="Save";const c=()=>{const m=r.value.trim();m?(document.body.removeChild(s),o(m)):(r.focus(),r.className=r.className+" border-red-500",setTimeout(()=>{r.className=r.className.replace(" border-red-500","")},2e3))};u.onclick=c,r.onkeydown=m=>{m.key==="Enter"?c():m.key==="Escape"&&document.body.removeChild(s)},d.appendChild(l),d.appendChild(u),a.appendChild(n),a.appendChild(i),a.appendChild(d),s.appendChild(a),document.body.appendChild(s),setTimeout(()=>r.focus(),100),s.onclick=m=>{m.target===s&&document.body.removeChild(s)}}async function Ye(){ge("Save Composition","Enter composition name...",async e=>{const t=ue(e);try{await Fe(t)}catch(o){console.error("Save failed:",o),y("Failed to save composition","error")}})}async function Xe(){ge("Save to Computer","Enter composition name...",async e=>{const t=ue(e);await Re(t)})}async function pe(){try{const e=await q();if(e.length===0){y("No saved compositions found in browser","info");return}Qe(e)}catch(e){console.error("Failed to load compositions:",e),y("Failed to load compositions from browser","error")}}function Ze(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const a=document.createElement("div");a.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4",i.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${e.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const d=document.createElement("button");d.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",d.textContent="Cancel",d.onclick=()=>document.body.removeChild(s);const l=document.createElement("button");l.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",l.textContent="Delete",l.onclick=async()=>{try{await ee(e.id),y(`"${e.metadata.name}" deleted`,"success"),document.body.removeChild(s),o()}catch(c){console.error("Delete failed:",c),y("Failed to delete composition","error")}},r.appendChild(d),r.appendChild(l),a.appendChild(n),a.appendChild(i),a.appendChild(r),s.appendChild(a),document.body.appendChild(s),s.onclick=c=>{c.target===s&&document.body.removeChild(s)};const u=c=>{c.key==="Escape"&&(document.body.removeChild(s),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u)}function Qe(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const a=document.createElement("div");a.className="max-h-64 overflow-y-auto px-6 py-4",e.forEach((r,d)=>{const l=document.createElement("div");l.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const u=new Date(r.saved||r.metadata.created).toLocaleDateString(),c=document.createElement("div");c.className="flex items-center justify-between";const m=document.createElement("button");m.className="flex-1 text-left",m.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${r.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${u}</div>
    `,m.onclick=()=>{te(r),document.body.removeChild(t)};const g=document.createElement("button");g.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",g.innerHTML="🗑️",g.title="Delete composition",g.onclick=b=>{b.stopPropagation(),Ze(r,t,()=>{document.body.removeChild(t),pe()})},c.appendChild(m),c.appendChild(g),l.appendChild(c),a.appendChild(l)});const n=document.createElement("div");n.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(t),n.appendChild(i),o.appendChild(s),o.appendChild(a),o.appendChild(n),t.appendChild(o),document.body.appendChild(t),t.onclick=r=>{r.target===t&&document.body.removeChild(t)}}async function et(){try{if((await q()).length===0){y("No saved compositions found in browser","info");return}const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const a=document.createElement("div");a.className="max-h-64 overflow-y-auto px-6 py-4";const n=async()=>{const d=await q();if(a.innerHTML="",d.length===0){a.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}d.forEach(l=>{const u=document.createElement("div");u.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const c=new Date(l.saved||l.metadata.created).toLocaleDateString(),m=document.createElement("div");m.className="flex items-center justify-between";const g=document.createElement("div");g.className="flex-1",g.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${l.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${c}</div>
        `;const b=document.createElement("div");b.className="flex gap-2 ml-3";const v=document.createElement("button");v.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",v.textContent="Load",v.onclick=()=>{te(l),document.body.removeChild(t)};const p=document.createElement("button");p.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",p.textContent="Delete",p.onclick=async()=>{if(confirm(`Delete "${l.metadata.name}"?`))try{await ee(l.id),y(`"${l.metadata.name}" deleted`,"success"),n()}catch(w){console.error("Delete failed:",w),y("Failed to delete composition","error")}},b.appendChild(v),b.appendChild(p),m.appendChild(g),m.appendChild(b),u.appendChild(m),a.appendChild(u)})};await n();const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const r=document.createElement("button");r.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",r.textContent="Close",r.onclick=()=>document.body.removeChild(t),i.appendChild(r),o.appendChild(s),o.appendChild(a),o.appendChild(i),t.appendChild(o),document.body.appendChild(t),t.onclick=d=>{d.target===t&&document.body.removeChild(t)}}catch(e){console.error("Failed to load compositions:",e),y("Failed to load compositions from browser","error")}}function tt(){We()}document.addEventListener("DOMContentLoaded",()=>{U().catch(console.error),window.saveComposition=Ye,window.saveCompositionToComputer=Xe,window.loadComposition=tt,window.loadFromBrowser=pe,window.manageCompositions=et,window.clearAllGrids=me,window.getAllCompositions=q,window.deleteFromBrowser=ee,window.showNotification=y,console.log("Storage functionality initialized")});console.log("Storage module loaded");
