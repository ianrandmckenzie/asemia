const Y={"7xl":.6,"6xl":.5,"5xl":.4,"4xl":.3,"3xl":.25,"2xl":.2,xl:.167,lg:.15,base:.133,sm:.117,xs:.1};let V="7xl";async function O(){if(!document.getElementById("mobileSerifTab")){console.log("Mobile builder not needed on this page (no shape tabs found)");return}if(!window.rulesData){console.warn("rulesData not available yet, waiting..."),setTimeout(O,50);return}se(),le(),ce(),X(),window.addEventListener("resize",X),T("serifs"),console.log("Mobile builder initialized")}function se(){const e=document.getElementById("mobileSerifTab"),t=document.getElementById("mobileBodiesTab"),s=document.getElementById("mobileJoinsTab"),i=document.getElementById("mobileTexturesTab");e&&($("serifs","mobileSerifShapes"),$("bodies","mobileBodiesShapes"),$("joins","mobileJoinsShapes"),ie("mobileTexturesShapes"),e.addEventListener("click",()=>T("serifs")),t.addEventListener("click",()=>T("bodies")),s.addEventListener("click",()=>T("joins")),i.addEventListener("click",()=>T("textures")))}function $(e,t){var o;const s=document.getElementById(t);if(!s||!((o=window.rulesData)!=null&&o.shapes))return;s.innerHTML="";const i=window.rulesData.shapes[e];i&&Object.keys(i).forEach(r=>{if(r==="grid")return;i[r].forEach(a=>{const l=ae(e,r,a);s.appendChild(l)})})}function ie(e){var s;const t=document.getElementById(e);!t||!((s=window.texturesData)!=null&&s.textures)||(t.innerHTML="",window.texturesData.textures.forEach(i=>{const o=oe(i);t.appendChild(o)}))}function oe(e){const t=document.createElement("button");t.className="mobile-shape-btn overflow-hidden",t.dataset.category="textures",t.dataset.textureId=e.id;const s=document.createElement("img");return s.src=`/assets/textures/${e.filename}`,s.alt=e.name,s.className="h-full w-auto object-contain pointer-events-none",t.appendChild(s),t.addEventListener("click",()=>{re(t,e)}),t}function re(e,t){document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(i=>{i.classList.remove("selected")}),e.classList.add("selected");const s=document.getElementById("mobileTexturesTab");if(s){const i=s.querySelector(".flex.flex-col");if(i){const o=i.querySelector("svg, img");if(o){const r=document.createElement("img");r.src=`/assets/textures/${t.filename}`,r.alt=t.name,r.className="h-6 w-6 object-cover rounded",o.replaceWith(r)}}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function ae(e,t,s){var r;const i=document.createElement("button");i.className="mobile-shape-btn",i.dataset.category=e,i.dataset.angleKey=t,i.dataset.shapeName=s.shape_name;const o=(r=window.SVGUtils)==null?void 0:r.createSVGElement(e,t,s.shape_name,"h-8 w-auto object-contain pointer-events-none");return o?i.appendChild(o):i.textContent=s.shape_name.substring(0,2),i.addEventListener("click",()=>{ne(i,e,t,s)}),i}function ne(e,t,s,i){document.querySelectorAll(".mobile-shape-btn.selected").forEach(r=>{r.dataset.textureId||r.classList.remove("selected")}),document.querySelectorAll(".shape-selected").forEach(r=>{r.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),e.classList.add("selected");const o={category:t,angleKey:s,shape:i,imagePath:`./assets/shapes/${t}/${s}/${i.shape_name}.svg`};window.setSelectedShape&&window.setSelectedShape(o),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}let H=null;function T(e){const t={serifs:document.getElementById("mobileSerifTab"),bodies:document.getElementById("mobileBodiesTab"),joins:document.getElementById("mobileJoinsTab"),textures:document.getElementById("mobileTexturesTab")},s={serifs:document.getElementById("mobileSerifShapes"),bodies:document.getElementById("mobileBodiesShapes"),joins:document.getElementById("mobileJoinsShapes"),textures:document.getElementById("mobileTexturesShapes")},i=document.getElementById("mobileShapeSelectorWrapper");if(H===e){i&&i.classList.add("hidden"),Object.keys(t).forEach(o=>{t[o]&&(t[o].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Object.keys(s).forEach(o=>{s[o]&&s[o].classList.add("hidden")}),H=null;return}Object.keys(s).forEach(o=>{s[o]&&s[o].classList.add("hidden")}),i&&i.classList.remove("hidden"),s[e]&&s[e].classList.remove("hidden"),Object.keys(t).forEach(o=>{t[o]&&(o===e?t[o].className="mobile-tab flex-1 py-3 px-2 bg-white dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700":t[o].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),H=e,window.setCurrentTab&&(e==="bodies"||e==="serifs"?window.setCurrentTab("bodies"):e==="joins"&&window.setCurrentTab("joins")),window.updateGridLayers&&window.updateGridLayers()}function le(){const e=document.getElementById("mobileSaveMenuBtn"),t=document.getElementById("mobileSizeBtn"),s=document.getElementById("mobilePreviewBtn"),i=document.getElementById("mobileSaveMenu"),o=document.getElementById("mobileSizeMenu"),r=document.getElementById("closeSaveMenu"),n=document.getElementById("closeSizeMenu");if(e&&i&&r&&(e.addEventListener("click",()=>{const l=i.classList.contains("hidden"),d=i.querySelector(".absolute");l?(i.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{d.classList.remove("translate-y-full"),d.classList.add("translate-y-0")})})):(i.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("opacity-0")},200))}),r.addEventListener("click",()=>{const l=i.querySelector(".absolute");i.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("opacity-0")},150)}),i.addEventListener("click",l=>{if(l.target===i){const d=i.querySelector(".absolute");i.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{i.classList.add("hidden"),i.classList.remove("opacity-0")},150)}})),t&&o&&n&&(t.addEventListener("click",()=>{const l=o.classList.contains("hidden"),d=o.querySelector(".absolute");l?(o.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{d.classList.remove("translate-y-full"),d.classList.add("translate-y-0")})})):(o.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{o.classList.add("hidden"),o.classList.remove("opacity-0")},200))}),n.addEventListener("click",()=>{const l=o.querySelector(".absolute");o.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{o.classList.add("hidden"),o.classList.remove("opacity-0")},150)}),o.addEventListener("click",l=>{if(l.target===o){const d=o.querySelector(".absolute");o.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{o.classList.add("hidden"),o.classList.remove("opacity-0")},150)}})),s){let l=!1;s.addEventListener("click",()=>{l=!l,window.setPreviewMode&&window.setPreviewMode(l);const d=s.querySelector("span"),f=document.getElementById("mobilePreviewIcon");l?(s.classList.add("bg-blue-100","dark:bg-blue-900"),d&&(d.classList.remove("text-gray-600","dark:text-gray-300"),d.classList.add("text-blue-700","dark:text-blue-300")),f&&(f.src="/assets/icons/eye-slash.svg")):(s.classList.remove("bg-blue-100","dark:bg-blue-900"),d&&(d.classList.remove("text-blue-700","dark:text-blue-300"),d.classList.add("text-gray-600","dark:text-gray-300")),f&&(f.src="/assets/icons/eye.svg"))})}const a=document.getElementById("mobileEraseBtn");a&&de(a)}let I=!1;function de(e){e.addEventListener("click",()=>{I=!I,window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight();const t=e.querySelector("span"),s=document.getElementById("mobileEraseIcon");I?(e.classList.add("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-gray-600","dark:text-gray-300"),t.classList.add("text-red-700","dark:text-red-300")),s&&(s.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-600","dark:text-gray-300")),s&&(s.src="/assets/icons/erase.svg"));const i=document.querySelector(".builder-grids-wrapper");i&&(I?i.style.cursor="crosshair":i.style.cursor="")})}window.isEraseMode=()=>I;window.hideMobileSaveMenu=function(){const e=document.getElementById("mobileSaveMenu"),t=e==null?void 0:e.querySelector(".absolute");e&&t&&(e.classList.add("opacity-0"),t.classList.remove("translate-y-0"),t.classList.add("translate-y-full"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("opacity-0")},150))};function ce(){const e=document.getElementById("mobileSizeButtons");if(!e)return;["7xl","6xl","5xl","4xl","3xl","2xl","xl","lg","base","sm","xs"].forEach(s=>{const i=document.createElement("button");i.className=`px-4 py-3 rounded-lg text-sm font-medium transition-colors ${s===V?"bg-blue-500 text-white":"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"}`,i.textContent=s,i.addEventListener("click",()=>{V=s,Q(s);const o=document.getElementById("mobileSizeMenu"),r=o.querySelector(".absolute");o.classList.add("opacity-0"),r.classList.remove("translate-y-0"),r.classList.add("translate-y-full"),setTimeout(()=>{o.classList.add("hidden"),o.classList.remove("opacity-0")},150),e.querySelectorAll("button").forEach(n=>{n===i?n.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white":n.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"})}),e.appendChild(i)})}function Q(e){const t=Y[e]||Y["5xl"],s=document.querySelector(".builder-grids-wrapper");s&&(s.style.transform=`scale(${t})`)}function X(){if(window.innerWidth<768)Q(V);else{const t=document.querySelector(".builder-grids-wrapper");t&&(t.style.transform="scale(1)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(O,100)}):setTimeout(O,100);let u=null,k=null,c=null,p=null,w="bodies",v=!1,E=!1,_=null;const C={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function G(){await K(),await ge(),fe(),he(),Be(),Te(),Ie(),Ee(),M(),window.getCellPosition=R,window.getCellByPosition=N,window.getOccupiedCells=z,window.clearCellHighlights=q,window.placeShapeInCell=D,window.applyPositioning=A,window.applyTextureToShape=te,window.rulesData=u,window.texturesData=k,window.shapeConfig=C,window.getSelectedShape=()=>c,window.setSelectedShape=e=>{c=e},window.getSelectedTexture=()=>p,window.setSelectedTexture=e=>{p=e},window.handleGridCellClick=J,window.handleGridCellRightClick=F,window.handleGridCellLeave=W,window.clearPendingEraseHighlight=j,window.updateSelectedShapeDisplay=P,window.updateGridLayers=M,window.getCurrentTab=()=>w,window.setCurrentTab=e=>{w=e},window.getPreviewMode=()=>v,window.setPreviewMode=e=>{v=e,document.body.classList.toggle("preview-mode",e)},console.log("Builder functions made globally accessible")}async function ue(){await K(),window.getCellPosition=R,window.getCellByPosition=N,window.getOccupiedCells=z,window.clearCellHighlights=q,window.placeShapeInCell=D,window.applyPositioning=A,window.rulesData=u,window.shapeConfig=C,console.log("Builder core functions initialized")}async function K(){try{u=await(await fetch("./assets/rules.json")).json()}catch(e){console.error("Failed to load rules.json:",e)}}async function ge(){try{k=await(await fetch("./assets/textures/manifest.json")).json()}catch(e){console.error("Failed to load textures manifest.json:",e)}}function fe(){be(),me()}function be(){const e=document.getElementById("serifsGrid");if(e){e.innerHTML="";for(let t=0;t<25;t++){const s=document.createElement("div");s.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",s.dataset.grid="serifs",s.dataset.index=t,s.addEventListener("click",J),s.addEventListener("contextmenu",F),s.addEventListener("mouseenter",ee),s.addEventListener("mouseleave",W),e.appendChild(s)}}}function me(){const e=document.getElementById("joinsGrid");if(e){e.innerHTML="";for(let t=0;t<16;t++){const s=document.createElement("div");s.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",s.dataset.grid="joins",s.dataset.index=t,s.addEventListener("click",J),s.addEventListener("contextmenu",F),s.addEventListener("mouseenter",ee),s.addEventListener("mouseleave",W),e.appendChild(s)}}}function he(){pe(),ye(),ve(),we()}function pe(){var t;const e=document.getElementById("bodiesShapes");if(e){if(e.innerHTML="",!((t=u==null?void 0:u.shapes)!=null&&t.bodies))return;Object.keys(u.shapes.bodies).forEach(s=>{if(s==="grid")return;u.shapes.bodies[s].forEach(o=>{const r=U("bodies",s,o);e.appendChild(r)})})}}function ye(){var t;const e=document.getElementById("serifsShapes");if(e){if(e.innerHTML="",!((t=u==null?void 0:u.shapes)!=null&&t.serifs))return;Object.keys(u.shapes.serifs).forEach(s=>{if(s==="grid")return;u.shapes.serifs[s].forEach(o=>{const r=U("serifs",s,o);e.appendChild(r)})})}}function ve(){var t;const e=document.getElementById("joinsShapes");if(e){if(e.innerHTML="",!((t=u==null?void 0:u.shapes)!=null&&t.joins))return;Object.keys(u.shapes.joins).forEach(s=>{if(s==="grid")return;u.shapes.joins[s].forEach(o=>{const r=U("joins",s,o);e.appendChild(r)})})}}function we(){const e=document.getElementById("texturesShapes");if(e){if(e.innerHTML="",!(k!=null&&k.textures))return;k.textures.forEach(t=>{const s=xe(t);e.appendChild(s)})}}function xe(e){const t=document.createElement("button");t.className="w-full aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden bg-white dark:bg-slate-900 flex flex-col items-center justify-center relative";const s=document.createElement("div");s.className="w-full h-3/4 bg-cover bg-center",s.style.backgroundImage=`url('/assets/textures/${e.filename}')`;const i=document.createElement("div");return i.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",i.textContent=e.name,t.appendChild(s),t.appendChild(i),t.addEventListener("click",()=>{document.querySelectorAll("#texturesShapes button").forEach(o=>{o.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),o.classList.add("border-gray-300","dark:border-gray-600")}),t.classList.remove("border-gray-300","dark:border-gray-600"),t.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),p=e,P()}),t}function U(e,t,s){const i=document.createElement("button");i.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let o=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(o=window.SVGUtils.createSVGElement(e,t,s.shape_name,"w-8 h-8 object-contain")),o?(o.setAttribute("alt",s.shape_name),i.appendChild(o)):(i.textContent=s.shape_name.substring(0,2),i.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${e}/${t}/${s.shape_name}, using text fallback`)),i.dataset.category=e,i.dataset.angleKey=t,i.dataset.shapeName=s.shape_name,i.dataset.cellOrientation=s.cell_orientation,i.addEventListener("click",()=>Le(i,e,t,s)),i}function Le(e,t,s,i){document.querySelectorAll(".shape-selected").forEach(o=>{o.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),e.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),c={category:t,angleKey:s,shape:i,imagePath:`./assets/shapes/${t}/${s}/${i.shape_name}.svg`},P()}function R(e,t){if(t==="serifs"){const s=Math.floor(e/5),i=e%5;return{row:s,col:i,gridSize:5}}else if(t==="joins"){const s=Math.floor(e/4),i=e%4;return{row:s,col:i,gridSize:4}}}function N(e,t,s){const i=s==="serifs"?5:4;if(e<0||t<0||e>=i||t>=i)return null;const o=e*i+t;return document.getElementById(s+"Grid").children[o]}function z(e,t){const s=e.dataset.grid,i=parseInt(e.dataset.index),o=R(i,s),r=t.shape.width||1,n=t.shape.height||1,a=[];if(r===2&&n===1){a.push(e);const l=N(o.row,o.col+1,s);l&&a.push(l)}else if(r===1&&n===2){a.push(e);const l=N(o.row+1,o.col,s);l&&a.push(l)}else a.push(e);return a}function ee(e){if(!c)return;const t=e.currentTarget,s=t.dataset.grid,i=u.shapes[c.category].grid;if(s!==i)return;q(),window.innerWidth>=768?z(t,c).forEach(n=>{n&&(n===t?Se(n,c):n.classList.add("cell-highlight-preview"))}):z(t,c).forEach(n=>{n&&n.classList.add("cell-highlight")})}function W(e){q()}function Se(e,t){const s="absolute shape-preview";let i=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(i=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,s)),i){i.setAttribute("alt",t.shape.shape_name),i.removeAttribute("width"),i.removeAttribute("height");const o=i.getAttribute("viewBox");if(o){const[,,r,n]=o.split(" ").map(Number);i.style.width=`${r}px`,i.style.height=`${n}px`}A(i,t),i.style.opacity="0.6",i.style.pointerEvents="none",e.appendChild(i)}}function q(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid, .cell-highlight-preview").forEach(e=>{e.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid","cell-highlight-preview")}),document.querySelectorAll(".shape-preview").forEach(e=>{e.remove()})}function J(e){const t=e.currentTarget;if(window.isEraseMode&&window.isEraseMode()||E){ke(t);return}if(j(),!c){alert("Please select a shape from the sidebar first");return}const s=t.dataset.grid,i=u.shapes[c.category].grid;if(s!==i){alert(`This shape can only be placed on the ${i} grid`);return}const o=z(t,c);if(o.some(a=>!a)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(t,c)){console.log("Placement blocked by constraints");return}const n=typeof validateShapeConnections=="function"||c.category!=="bodies"&&c.category!=="joins"||c.shape.width>1||c.shape.height>1;n&&o.forEach(a=>{a&&(a.innerHTML="")}),D(t,c,!n)}function ke(e){if(_===e){e.innerHTML="",j();return}j(),e.innerHTML.trim()!==""&&(_=e,e.classList.add("cell-erase-pending"))}function j(){_&&(_.classList.remove("cell-erase-pending"),_=null)}function Ee(){const e=document.getElementById("desktopEraseBtn");e&&e.addEventListener("click",()=>{E=!E,j();const t=e.querySelector("span"),s=document.getElementById("desktopEraseIcon");E?(e.classList.add("bg-red-100","dark:bg-red-900"),e.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.add("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-gray-700","dark:text-gray-200"),t.classList.add("text-red-700","dark:text-red-300")),s&&(s.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),e.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.remove("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-700","dark:text-gray-200")),s&&(s.src="/assets/icons/erase.svg"));const i=document.querySelector(".builder-grids-wrapper");i&&(E?i.style.cursor="crosshair":i.style.cursor="")})}window.isDesktopEraseMode=()=>E;function Ce(e,t){const{angleKey:s,shape:i}=t,o=i.width||1,r=i.height||1,n=i.cell_orientation,a=`${o}x${r}`,l=C.positioning.joins[a];if(!l)return;const d=l[s]||l.default,f=n.includes("top")?"top":"bottom",m=d[f],h=m.vertical.split(": ");e.style[h[0]]=h[1];const b=n.includes("right")?"right":"left",y=m.horizontal[b].split(": ");e.style[y[0]]=y[1],e.style.transform=""}function A(e,t){const{category:s,angleKey:i,shape:o}=t,r=o.width||1,n=o.height||1,a=o.cell_orientation.split(" "),l=a[0],d=a[1];if(e.style.transform="",s==="joins"&&(r===2||n===2))return Ce(e,t);if(s==="joins"&&r===1&&n===1){const m=C.positioning.joins["1x1"][i];if(m){const h=a.includes("top")?"top":"bottom",b=m[h];if(b){const y=b.vertical.split(": ");e.style[y[0]]=y[1];const B=a.includes("right")?"right":"left",g=b.horizontal[B].split(": ");e.style[g[0]]=g[1],e.style.transform="";return}}e.style.top="-5%",e.style.left="-5%",e.style.transform="";return}if(s==="bodies"&&(r===2||n===2)){e.style.top="0",e.style.left="0",e.style.transform="";return}if(s==="serifs"){const f=C.positioning.serifs[i];if(!f)return Z(e,l,d);if(i==="22_5_deg"){const m=o.shape_name;if(f[m]){const g=f[m];g.left&&(e.style.left=g.left),g.right&&(e.style.right=g.right);const x=g.vertical[l];x&&Object.keys(x).forEach(L=>{e.style[L]=x[L]});return}if(o.cell_orientation.includes("top")||o.cell_orientation.includes("bottom")){const g=f.side,x=g[l]||g.default;Object.keys(x).forEach(S=>{S!=="transform"&&(e.style[S]=x[S])});const L=g.horizontal[d];L&&Object.keys(L).forEach(S=>{e.style[S]=L[S]});return}const b=f.regular,y=b.horizontal[d]||b.horizontal.default,B=b.vertical[l];Object.keys(y).forEach(g=>{e.style[g]=y[g]}),B&&Object.keys(B).forEach(g=>{e.style[g]=B[g]});return}if(i==="45_deg"){const m=o.shape_name,h=f[m];if(h){Object.keys(h).forEach(b=>{e.style[b]=h[b]});return}}}Z(e,l,d)}function Z(e,t,s){const i=C.positioning.standard,o=i.vertical[t];o&&Object.keys(o).forEach(n=>{if(n==="transform"){const a=o[n];e.style.transform=a[s]||a.default}else e.style[n]=o[n]});const r=i.horizontal[s];r&&(Object.keys(r).forEach(n=>{e.style[n]=r[n]}),s==="center"&&t!=="center"&&(e.style.transform="translateX(-50%)"))}function D(e,t,s=!1){s||(e.innerHTML="");const i="absolute";let o=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(o=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,i)),!o){console.warn("Could not create SVG for shape:",t);const n=document.createElement("div");n.textContent=t.shape.shape_name,n.className=i+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",e.appendChild(n);return}o.setAttribute("alt",t.shape.shape_name),o.removeAttribute("width"),o.removeAttribute("height");const r=o.getAttribute("viewBox");if(r){const[,,n,a]=r.split(" ").map(Number);o.style.width=`${n}px`,o.style.height=`${a}px`}if(A(o,t),p){const n=te(o,p);e.appendChild(n)}else e.appendChild(o)}function te(e,t){if(!e||!t)return e;const s=e.cloneNode(!0);s.style.top="",s.style.bottom="",s.style.left="",s.style.right="",s.style.transform="",s.style.position="",s.setAttribute("fill","black"),s.setAttribute("stroke","black"),s.querySelectorAll("*[fill], *[stroke]").forEach(l=>{l.getAttribute("fill")&&l.getAttribute("fill")!=="none"&&l.setAttribute("fill","black"),l.getAttribute("stroke")&&l.getAttribute("stroke")!=="none"&&l.setAttribute("stroke","black")});const o=new XMLSerializer().serializeToString(s),n=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(o)))}`,a=document.createElement("div");return a.className="absolute",a.style.width=e.style.width,a.style.height=e.style.height,a.style.top=e.style.top||"",a.style.bottom=e.style.bottom||"",a.style.left=e.style.left||"",a.style.right=e.style.right||"",a.style.transform=e.style.transform||"",a.style.backgroundImage=`url('/assets/textures/${t.filename}')`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",a.style.webkitMaskImage=`url('${n}')`,a.style.maskImage=`url('${n}')`,a.style.webkitMaskSize="100% 100%",a.style.maskSize="100% 100%",a.style.webkitMaskRepeat="no-repeat",a.style.maskRepeat="no-repeat",a.style.webkitMaskPosition="0 0",a.style.maskPosition="0 0",a.dataset.category=e.dataset.category,a.dataset.angleKey=e.dataset.angleKey,a.dataset.shapeName=e.dataset.shapeName,a.dataset.textured="true",a.dataset.textureId=t.id,a}function Be(){const e=document.getElementById("bodiesTab"),t=document.getElementById("joinsTab"),s=document.getElementById("texturesTab"),i=document.getElementById("bodiesContent"),o=document.getElementById("joinsContent"),r=document.getElementById("texturesContent");e&&(e.addEventListener("click",()=>{w="bodies",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",s.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",i.classList.remove("hidden"),o.classList.add("hidden"),r.classList.add("hidden"),M()}),t.addEventListener("click",()=>{w="joins",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",s.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",o.classList.remove("hidden"),i.classList.add("hidden"),r.classList.add("hidden"),M()}),s.addEventListener("click",()=>{w="textures",s.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",r.classList.remove("hidden"),i.classList.add("hidden"),o.classList.add("hidden"),M()}))}function F(e){e.preventDefault();const t=e.currentTarget;t.innerHTML=""}function P(){const e=document.getElementById("selectedShapeDisplay"),t=document.getElementById("selectedShapeInfo");if(c||p){e.classList.remove("hidden");let s="";c&&(s+=`Shape: ${c.category} > ${c.angleKey} > ${c.shape.shape_name}`),p&&(s&&(s+="<br>"),s+=`Texture: ${p.name}`),t.innerHTML=s}else e.classList.add("hidden")}function Te(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{c=null,p=null,document.querySelectorAll(".shape-selected").forEach(t=>{t.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),document.querySelectorAll("#texturesShapes button").forEach(t=>{t.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),t.classList.add("border-gray-300","dark:border-gray-600")}),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(t=>{t.classList.remove("selected")}),P()})}function Ie(){const e=document.getElementById("previewToggle");e&&e.addEventListener("change",s=>{v=s.target.checked,document.body.classList.toggle("preview-mode",v)});const t=document.getElementById("desktopPreviewBtn");t&&t.addEventListener("click",()=>{v=!v,document.body.classList.toggle("preview-mode",v);const s=t.querySelector("span"),i=document.getElementById("desktopPreviewIcon");v?(t.classList.add("bg-blue-100","dark:bg-blue-900"),t.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.add("hover:bg-blue-200","dark:hover:bg-blue-800"),s&&(s.classList.remove("text-gray-700","dark:text-gray-200"),s.classList.add("text-blue-700","dark:text-blue-300")),i&&(i.src="/assets/icons/eye-slash.svg")):(t.classList.remove("bg-blue-100","dark:bg-blue-900"),t.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.remove("hover:bg-blue-200","dark:hover:bg-blue-800"),s&&(s.classList.remove("text-blue-700","dark:text-blue-300"),s.classList.add("text-gray-700","dark:text-gray-200")),i&&(i.src="/assets/icons/eye.svg"))})}function M(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");e&&(w==="bodies"?(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")):w==="joins"&&(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?G():(document.addEventListener("svgSystemReady",G),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",G),G())},100))});window.initBuilderCore=ue;
