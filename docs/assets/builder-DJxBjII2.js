let a=null,c=null,_="bodies",P=!1;const C={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function E(){await M(),R(),X(),Q(),Z(),D(),k(),window.getCellPosition=G,window.getCellByPosition=x,window.getOccupiedCells=L,window.clearCellHighlights=z,window.placeShapeInCell=V,window.applyPositioning=T,window.rulesData=a,window.shapeConfig=C,window.getSelectedShape=()=>c,window.handleGridCellClick=I,window.handleGridCellRightClick=O,window.handleGridCellLeave=B,console.log("Builder functions made globally accessible")}async function $(){await M(),window.getCellPosition=G,window.getCellByPosition=x,window.getOccupiedCells=L,window.clearCellHighlights=z,window.placeShapeInCell=V,window.applyPositioning=T,window.rulesData=a,window.shapeConfig=C,console.log("Builder core functions initialized")}async function M(){try{a=await(await fetch("./assets/rules.json")).json()}catch(t){console.error("Failed to load rules.json:",t)}}function R(){Y(),A()}function Y(){const t=document.getElementById("serifsGrid");if(t){t.innerHTML="";for(let e=0;e<25;e++){const i=document.createElement("div");i.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",i.dataset.grid="serifs",i.dataset.index=e,i.addEventListener("click",I),i.addEventListener("contextmenu",O),i.addEventListener("mouseenter",N),i.addEventListener("mouseleave",B),t.appendChild(i)}}}function A(){const t=document.getElementById("joinsGrid");if(t){t.innerHTML="";for(let e=0;e<16;e++){const i=document.createElement("div");i.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",i.dataset.grid="joins",i.dataset.index=e,i.addEventListener("click",I),i.addEventListener("contextmenu",O),i.addEventListener("mouseenter",N),i.addEventListener("mouseleave",B),t.appendChild(i)}}}function X(){q(),J(),W()}function q(){var e;const t=document.getElementById("bodiesShapes");if(t){if(t.innerHTML="",!((e=a==null?void 0:a.shapes)!=null&&e.bodies))return;Object.keys(a.shapes.bodies).forEach(i=>{if(i==="grid")return;a.shapes.bodies[i].forEach(n=>{const s=j("bodies",i,n);t.appendChild(s)})})}}function J(){var e;const t=document.getElementById("serifsShapes");if(t){if(t.innerHTML="",!((e=a==null?void 0:a.shapes)!=null&&e.serifs))return;Object.keys(a.shapes.serifs).forEach(i=>{if(i==="grid")return;a.shapes.serifs[i].forEach(n=>{const s=j("serifs",i,n);t.appendChild(s)})})}}function W(){var e;const t=document.getElementById("joinsShapes");if(t){if(t.innerHTML="",!((e=a==null?void 0:a.shapes)!=null&&e.joins))return;Object.keys(a.shapes.joins).forEach(i=>{if(i==="grid")return;a.shapes.joins[i].forEach(n=>{const s=j("joins",i,n);t.appendChild(s)})})}}function j(t,e,i){const o=document.createElement("button");o.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let n=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(n=window.SVGUtils.createSVGElement(t,e,i.shape_name,"w-8 h-8 object-contain")),n?(n.setAttribute("alt",i.shape_name),o.appendChild(n)):(o.textContent=i.shape_name.substring(0,2),o.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${t}/${e}/${i.shape_name}, using text fallback`)),o.dataset.category=t,o.dataset.angleKey=e,o.dataset.shapeName=i.shape_name,o.dataset.cellOrientation=i.cell_orientation,o.addEventListener("click",()=>F(o,t,e,i)),o}function F(t,e,i,o){document.querySelectorAll(".shape-selected").forEach(n=>{n.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),t.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),c={category:e,angleKey:i,shape:o,imagePath:`./assets/shapes/${e}/${i}/${o.shape_name}.svg`},U()}function G(t,e){if(e==="serifs"){const i=Math.floor(t/5),o=t%5;return{row:i,col:o,gridSize:5}}else if(e==="joins"){const i=Math.floor(t/4),o=t%4;return{row:i,col:o,gridSize:4}}}function x(t,e,i){const o=i==="serifs"?5:4;if(t<0||e<0||t>=o||e>=o)return null;const n=t*o+e;return document.getElementById(i+"Grid").children[n]}function L(t,e){const i=t.dataset.grid,o=parseInt(t.dataset.index),n=G(o,i),s=e.shape.width||1,l=e.shape.height||1,r=[];if(s===2&&l===1){r.push(t);const f=x(n.row,n.col+1,i);f&&r.push(f)}else if(s===1&&l===2){r.push(t);const f=x(n.row+1,n.col,i);f&&r.push(f)}else r.push(t);return r}function N(t){if(!c)return;const e=t.currentTarget,i=e.dataset.grid,o=a.shapes[c.category].grid;if(i!==o)return;z(),L(e,c).forEach(s=>{s&&s.classList.add("cell-highlight")})}function B(t){z()}function z(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid").forEach(t=>{t.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid")})}function I(t){if(!c){alert("Please select a shape from the sidebar first");return}const e=t.currentTarget,i=e.dataset.grid,o=a.shapes[c.category].grid;if(i!==o){alert(`This shape can only be placed on the ${o} grid`);return}const n=L(e,c);if(n.some(r=>!r)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(e,c)){console.log("Placement blocked by constraints");return}const l=typeof validateShapeConnections=="function"||c.category!=="bodies"&&c.category!=="joins"||c.shape.width>1||c.shape.height>1;l&&n.forEach(r=>{r&&(r.innerHTML="")}),V(e,c,!l)}function K(t,e){const{angleKey:i,shape:o}=e,n=o.width||1,s=o.height||1,l=o.cell_orientation,r=`${n}x${s}`,f=C.positioning.joins[r];if(!f)return;const b=f[i]||f.default,p=l.includes("top")?"top":"bottom",g=b[p],u=g.vertical.split(": ");t.style[u[0]]=u[1];const h=l.includes("right")?"right":"left",m=g.horizontal[h].split(": ");t.style[m[0]]=m[1],t.style.transform=""}function T(t,e){const{category:i,angleKey:o,shape:n}=e,s=n.width||1,l=n.height||1,r=n.cell_orientation.split(" "),f=r[0],b=r[1];if(t.style.transform="",i==="joins"&&(s===2||l===2))return K(t,e);if(i==="joins"&&s===1&&l===1){const g=C.positioning.joins["1x1"][o];if(g){const u=r.includes("top")?"top":"bottom",h=g[u];if(h){const m=h.vertical.split(": ");t.style[m[0]]=m[1];const S=r.includes("right")?"right":"left",d=h.horizontal[S].split(": ");t.style[d[0]]=d[1],t.style.transform="";return}}t.style.top="-5%",t.style.left="-5%",t.style.transform="";return}if(i==="bodies"&&(s===2||l===2)){t.style.top="0",t.style.left="0",t.style.transform="";return}if(i==="serifs"){const p=C.positioning.serifs[o];if(!p)return H(t,f,b);if(o==="22_5_deg"){const g=n.shape_name;if(p[g]){const d=p[g];d.left&&(t.style.left=d.left),d.right&&(t.style.right=d.right);const y=d.vertical[f];y&&Object.keys(y).forEach(v=>{t.style[v]=y[v]});return}if(n.cell_orientation.includes("top")||n.cell_orientation.includes("bottom")){const d=p.side,y=d[f]||d.default;Object.keys(y).forEach(w=>{w!=="transform"&&(t.style[w]=y[w])});const v=d.horizontal[b];v&&Object.keys(v).forEach(w=>{t.style[w]=v[w]});return}const h=p.regular,m=h.horizontal[b]||h.horizontal.default,S=h.vertical[f];Object.keys(m).forEach(d=>{t.style[d]=m[d]}),S&&Object.keys(S).forEach(d=>{t.style[d]=S[d]});return}if(o==="45_deg"){const g=n.shape_name,u=p[g];if(u){Object.keys(u).forEach(h=>{t.style[h]=u[h]});return}}}H(t,f,b)}function H(t,e,i){const o=C.positioning.standard,n=o.vertical[e];n&&Object.keys(n).forEach(l=>{if(l==="transform"){const r=n[l];t.style.transform=r[i]||r.default}else t.style[l]=n[l]});const s=o.horizontal[i];s&&(Object.keys(s).forEach(l=>{t.style[l]=s[l]}),i==="center"&&e!=="center"&&(t.style.transform="translateX(-50%)"))}function V(t,e,i=!1){i||(t.innerHTML="");const o="absolute";let n=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(n=window.SVGUtils.createSVGElement(e.category,e.angleKey,e.shape.shape_name,o)),!n){console.warn("Could not create SVG for shape:",e);const s=document.createElement("div");s.textContent=e.shape.shape_name,s.className=o+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",s.style.display="flex",s.style.alignItems="center",s.style.justifyContent="center",t.appendChild(s);return}n.setAttribute("alt",e.shape.shape_name),T(n,e),t.appendChild(n)}function Q(){const t=document.getElementById("bodiesTab"),e=document.getElementById("joinsTab"),i=document.getElementById("bodiesContent"),o=document.getElementById("joinsContent");t&&(t.addEventListener("click",()=>{_="bodies",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",i.classList.remove("hidden"),o.classList.add("hidden"),k()}),e.addEventListener("click",()=>{_="joins",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",o.classList.remove("hidden"),i.classList.add("hidden"),k()}))}function O(t){t.preventDefault();const e=t.currentTarget;e.innerHTML=""}function U(){const t=document.getElementById("selectedShapeDisplay"),e=document.getElementById("selectedShapeInfo");c?(t.classList.remove("hidden"),e.textContent=`${c.category} > ${c.angleKey} > ${c.shape.shape_name}`):t.classList.add("hidden")}function Z(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{c=null,document.querySelectorAll(".shape-selected").forEach(e=>{e.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),U()})}function D(){const t=document.getElementById("previewToggle");t&&t.addEventListener("change",e=>{P=e.target.checked,document.body.classList.toggle("preview-mode",P)})}function k(){const t=document.getElementById("serifsGrid"),e=document.getElementById("joinsGrid");t&&(_==="bodies"?(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")):_==="joins"&&(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?E():(document.addEventListener("svgSystemReady",E),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",E),E())},100))});window.initBuilderCore=$;
