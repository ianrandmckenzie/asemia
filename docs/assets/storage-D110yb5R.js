const T="TypographicTinkerer";const b="compositions";let p=null;async function w(){return new Promise((e,n)=>{const o=indexedDB.open(T,1);o.onerror=()=>n(o.error),o.onsuccess=()=>{p=o.result,e(p)},o.onupgradeneeded=t=>{if(p=t.target.result,!p.objectStoreNames.contains(b)){const a=p.createObjectStore(b,{keyPath:"id",autoIncrement:!0});a.createIndex("name","name",{unique:!1}),a.createIndex("created","created",{unique:!1})}}})}async function B(e){return p||await w(),new Promise((n,o)=>{const a=p.transaction([b],"readwrite").objectStore(b),s={...e,saved:new Date().toISOString()},c=a.add(s);c.onsuccess=()=>{console.log("Composition saved to browser:",s.metadata.name),u(`"${s.metadata.name}" saved to browser`,"success"),n(c.result)},c.onerror=()=>{console.error("Failed to save composition:",c.error),u("Failed to save composition","error"),o(c.error)}})}function F(e){const n=JSON.stringify(e,null,2),o=new Blob([n],{type:"application/json"}),t=URL.createObjectURL(o),a=document.createElement("a");a.href=t,a.download=`${e.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(t),console.log("Composition downloaded:",e.metadata.name),u(`"${e.metadata.name}" downloaded`,"success")}async function v(){return p||await w(),new Promise((e,n)=>{const a=p.transaction([b],"readonly").objectStore(b).getAll();a.onsuccess=()=>e(a.result),a.onerror=()=>n(a.error)})}async function C(e){return p||await w(),new Promise((n,o)=>{const s=p.transaction([b],"readwrite").objectStore(b).delete(e);s.onsuccess=()=>{console.log("Composition deleted from browser:",e),n()},s.onerror=()=>o(s.error)})}function S(e){return{metadata:{name:e||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:N("serifsGrid","serifs"),joins:N("joinsGrid","joins")}}}function N(e,n){const o=document.getElementById(e),t=[];console.log(`Extracting data from ${e}:`,o);for(let a=0;a<o.children.length;a++){const s=o.children[a],c=s.querySelector("img"),r=s.querySelector("svg");if(c&&c.src){const i=c.src,d=i.split("/"),l=d[d.length-1].replace(".svg",""),g=d[d.length-2],m=d[d.length-3];console.log(`Found img in cell ${a}:`,{srcPath:i,fileName:l,angleKey:g,category:m}),t.push({index:a,category:m,angleKey:g,shapeName:l,imagePath:`./assets/shapes/${m}/${g}/${l}.svg`})}else if(r){console.log(`Found svg in cell ${a}:`,r);const i=r.getAttribute("data-category"),d=r.getAttribute("data-angle-key"),l=r.getAttribute("data-shape-name");i&&d&&l&&t.push({index:a,category:i,angleKey:d,shapeName:l,imagePath:`./assets/shapes/${i}/${d}/${l}.svg`})}}return console.log(`Extracted ${t.length} shapes from ${e}`),{gridType:n,gridSize:n==="serifs"?5:4,shapes:t}}function M(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=O,e.click()}function O(e){const n=e.target.files[0];if(!n)return;const o=new FileReader;o.onload=function(t){var a;try{const s=JSON.parse(t.target.result);k(s),console.log("Composition loaded from file:",((a=s.metadata)==null?void 0:a.name)||"Unknown")}catch(s){alert("Error loading file: Invalid JSON format"),console.error("Load error:",s)}},o.readAsText(n)}function k(e){var o,t,a;console.log("Loading composition:",e),j(),(o=e.grids)!=null&&o.serifs&&(console.log("Loading serifs grid with",e.grids.serifs.shapes.length,"shapes"),E("serifsGrid",e.grids.serifs)),(t=e.grids)!=null&&t.joins&&(console.log("Loading joins grid with",e.grids.joins.shapes.length,"shapes"),E("joinsGrid",e.grids.joins));const n=((a=e.metadata)==null?void 0:a.name)||"Composition";u(`"${n}" loaded successfully`,"success")}function E(e,n){const o=document.getElementById(e);n.shapes.forEach(t=>{var s,c,r;const a=o.children[t.index];if(a){const i={category:t.category,angleKey:t.angleKey,shape:{shape_name:t.shapeName},imagePath:t.imagePath};if((r=(c=(s=window.rulesData)==null?void 0:s.shapes)==null?void 0:c[t.category])!=null&&r[t.angleKey]){const d=window.rulesData.shapes[t.category][t.angleKey].find(l=>l.shape_name===t.shapeName);d?(i.shape=d,window.placeShapeInCell?window.placeShapeInCell(a,i):console.warn("placeShapeInCell function not available")):console.warn("Shape not found in rulesData:",t.shapeName)}else console.warn("Category/angleKey not found in rulesData:",t.category,t.angleKey)}})}function j(){const e=document.getElementById("serifsGrid"),n=document.getElementById("joinsGrid");for(let o=0;o<e.children.length;o++)e.children[o].innerHTML="";for(let o=0;o<n.children.length;o++)n.children[o].innerHTML="";console.log("All grids cleared"),u("Grids cleared","info")}function u(e,n="info"){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${n==="success"?"bg-green-500 dark:bg-green-600":n==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)}function L(e,n,o){const t=document.createElement("div");t.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const a=document.createElement("div");a.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-sm w-full mx-4";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${e}</h3>
  `;const c=document.createElement("div");c.className="px-6 py-4";const r=document.createElement("input");r.type="text",r.placeholder=n,r.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",r.value="",c.appendChild(r);const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const d=document.createElement("button");d.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",d.textContent="Cancel",d.onclick=()=>document.body.removeChild(t);const l=document.createElement("button");l.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",l.textContent="Save";const g=()=>{const m=r.value.trim();m?(document.body.removeChild(t),o(m)):(r.focus(),r.className=r.className+" border-red-500",setTimeout(()=>{r.className=r.className.replace(" border-red-500","")},2e3))};l.onclick=g,r.onkeydown=m=>{m.key==="Enter"?g():m.key==="Escape"&&document.body.removeChild(t)},i.appendChild(d),i.appendChild(l),a.appendChild(s),a.appendChild(c),a.appendChild(i),t.appendChild(a),document.body.appendChild(t),setTimeout(()=>r.focus(),100),t.onclick=m=>{m.target===t&&document.body.removeChild(t)}}async function A(){L("Save Composition","Enter composition name...",async e=>{const n=S(e);try{await B(n)}catch(o){console.error("Save failed:",o),u("Failed to save composition","error")}})}async function G(){L("Save to Computer","Enter composition name...",e=>{const n=S(e);F(n)})}async function D(){try{const e=await v();if(e.length===0){u("No saved compositions found in browser","info");return}P(e)}catch(e){console.error("Failed to load compositions:",e),u("Failed to load compositions from browser","error")}}function H(e,n,o){const t=document.createElement("div");t.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const a=document.createElement("div");a.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-sm w-full mx-4";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const c=document.createElement("div");c.className="px-6 py-4",c.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${e.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(t);const d=document.createElement("button");d.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",d.textContent="Delete",d.onclick=async()=>{try{await C(e.id),u(`"${e.metadata.name}" deleted`,"success"),document.body.removeChild(t),o()}catch(g){console.error("Delete failed:",g),u("Failed to delete composition","error")}},r.appendChild(i),r.appendChild(d),a.appendChild(s),a.appendChild(c),a.appendChild(r),t.appendChild(a),document.body.appendChild(t),t.onclick=g=>{g.target===t&&document.body.removeChild(t)};const l=g=>{g.key==="Escape"&&(document.body.removeChild(t),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l)}function P(e){const n=document.createElement("div");n.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const t=document.createElement("div");t.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",t.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const a=document.createElement("div");a.className="max-h-64 overflow-y-auto px-6 py-4",e.forEach((r,i)=>{const d=document.createElement("div");d.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const l=new Date(r.saved||r.metadata.created).toLocaleDateString(),g=document.createElement("div");g.className="flex items-center justify-between";const m=document.createElement("button");m.className="flex-1 text-left",m.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${r.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${l}</div>
    `,m.onclick=()=>{k(r),document.body.removeChild(n)};const y=document.createElement("button");y.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",y.innerHTML="ðŸ—‘ï¸",y.title="Delete composition",y.onclick=h=>{h.stopPropagation(),H(r,n,()=>{document.body.removeChild(n),D()})},g.appendChild(m),g.appendChild(y),d.appendChild(g),a.appendChild(d)});const s=document.createElement("div");s.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const c=document.createElement("button");c.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",c.textContent="Cancel",c.onclick=()=>document.body.removeChild(n),s.appendChild(c),o.appendChild(t),o.appendChild(a),o.appendChild(s),n.appendChild(o),document.body.appendChild(n),n.onclick=r=>{r.target===n&&document.body.removeChild(n)}}async function K(){try{if((await v()).length===0){u("No saved compositions found in browser","info");return}const n=document.createElement("div");n.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const t=document.createElement("div");t.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",t.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const a=document.createElement("div");a.className="max-h-64 overflow-y-auto px-6 py-4";const s=async()=>{const i=await v();if(a.innerHTML="",i.length===0){a.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}i.forEach(d=>{const l=document.createElement("div");l.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const g=new Date(d.saved||d.metadata.created).toLocaleDateString(),m=document.createElement("div");m.className="flex items-center justify-between";const y=document.createElement("div");y.className="flex-1",y.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${d.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${g}</div>
        `;const h=document.createElement("div");h.className="flex gap-2 ml-3";const f=document.createElement("button");f.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",f.textContent="Load",f.onclick=()=>{k(d),document.body.removeChild(n)};const x=document.createElement("button");x.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",x.textContent="Delete",x.onclick=async()=>{if(confirm(`Delete "${d.metadata.name}"?`))try{await C(d.id),u(`"${d.metadata.name}" deleted`,"success"),s()}catch($){console.error("Delete failed:",$),u("Failed to delete composition","error")}},h.appendChild(f),h.appendChild(x),m.appendChild(y),m.appendChild(h),l.appendChild(m),a.appendChild(l)})};await s();const c=document.createElement("div");c.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const r=document.createElement("button");r.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",r.textContent="Close",r.onclick=()=>document.body.removeChild(n),c.appendChild(r),o.appendChild(t),o.appendChild(a),o.appendChild(c),n.appendChild(o),document.body.appendChild(n),n.onclick=i=>{i.target===n&&document.body.removeChild(n)}}catch(e){console.error("Failed to load compositions:",e),u("Failed to load compositions from browser","error")}}function q(){M()}document.addEventListener("DOMContentLoaded",()=>{w().catch(console.error),window.saveComposition=A,window.saveCompositionToComputer=G,window.loadComposition=q,window.loadFromBrowser=D,window.manageCompositions=K,window.clearAllGrids=j,window.getAllCompositions=v,window.deleteFromBrowser=C,console.log("Storage functionality initialized")});console.log("Storage module loaded");
