const ae={"7xl":.6,"6xl":.5,"5xl":.4,"4xl":.3,"3xl":.25,"2xl":.2,xl:.167,lg:.15,base:.133,sm:.117,xs:.1};let J="7xl";async function Y(){if(!document.getElementById("mobileSerifTab")){console.log("Mobile builder not needed on this page (no shape tabs found)");return}if(!window.rulesData){console.warn("rulesData not available yet, waiting..."),setTimeout(Y,50);return}ve(),Ce(),Te(),re(),window.addEventListener("resize",re),_("serifs"),console.log("Mobile builder initialized")}function ve(){const e=document.getElementById("mobileSerifTab"),t=document.getElementById("mobileBodiesTab"),o=document.getElementById("mobileJoinsTab"),s=document.getElementById("mobileTexturesTab");e&&(W("serifs","mobileSerifShapes"),W("bodies","mobileBodiesShapes"),W("joins","mobileJoinsShapes"),xe("mobileTexturesShapes"),e.addEventListener("click",()=>_("serifs")),t.addEventListener("click",()=>_("bodies")),o.addEventListener("click",()=>_("joins")),s.addEventListener("click",()=>_("textures")))}function W(e,t){var n;const o=document.getElementById(t);if(!o||!((n=window.rulesData)!=null&&n.shapes))return;o.innerHTML="";const s=window.rulesData.shapes[e];s&&Object.keys(s).forEach(r=>{if(r==="grid")return;s[r].forEach(a=>{const d=Ee(e,r,a);o.appendChild(d)})})}function xe(e){var o;const t=document.getElementById(e);!t||!((o=window.texturesData)!=null&&o.textures)||(t.innerHTML="",window.texturesData.textures.forEach(s=>{const n=ke(s);t.appendChild(n)}))}function ke(e){const t=document.createElement("button");t.className="mobile-shape-btn overflow-hidden",t.dataset.category="textures",t.dataset.textureId=e.id;const o=document.createElement("img");return o.src=`/assets/textures/${e.filename}`,o.alt=e.name,o.className="h-full w-auto object-contain pointer-events-none",t.appendChild(o),t.addEventListener("click",()=>{Se(t,e)}),t}function Se(e,t){document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(s=>{s.classList.remove("selected")}),e.classList.add("selected");const o=document.getElementById("mobileTexturesTab");if(o){const s=o.querySelector(".flex.flex-col");if(s){const n=s.querySelector("svg, img");if(n){const r=document.createElement("img");r.src=`/assets/textures/${t.filename}`,r.alt=t.name,r.className="h-6 w-6 object-cover rounded",n.replaceWith(r)}}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function Ee(e,t,o){var r;const s=document.createElement("button");s.className="mobile-shape-btn",s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name;const n=(r=window.SVGUtils)==null?void 0:r.createSVGElement(e,t,o.shape_name,"h-8 w-auto object-contain pointer-events-none");return n?s.appendChild(n):s.textContent=o.shape_name.substring(0,2),s.addEventListener("click",()=>{Le(s,e,t,o)}),s}function Le(e,t,o,s){window.clearPendingPlacement&&window.clearPendingPlacement(),document.querySelectorAll(".mobile-shape-btn.selected").forEach(r=>{r.dataset.textureId||r.classList.remove("selected")}),document.querySelectorAll(".shape-selected").forEach(r=>{r.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),e.classList.add("selected");const n={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`};window.setSelectedShape&&window.setSelectedShape(n),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}let K=null;function _(e){const t={serifs:document.getElementById("mobileSerifTab"),bodies:document.getElementById("mobileBodiesTab"),joins:document.getElementById("mobileJoinsTab"),textures:document.getElementById("mobileTexturesTab")},o={serifs:document.getElementById("mobileSerifShapes"),bodies:document.getElementById("mobileBodiesShapes"),joins:document.getElementById("mobileJoinsShapes"),textures:document.getElementById("mobileTexturesShapes")},s=document.getElementById("mobileShapeSelectorWrapper");if(window.clearPendingPlacement&&window.clearPendingPlacement(),K===e){s&&s.classList.add("hidden"),Object.keys(t).forEach(n=>{t[n]&&(t[n].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Object.keys(o).forEach(n=>{o[n]&&o[n].classList.add("hidden")}),K=null;return}Object.keys(o).forEach(n=>{o[n]&&o[n].classList.add("hidden")}),s&&s.classList.remove("hidden"),o[e]&&o[e].classList.remove("hidden"),Object.keys(t).forEach(n=>{t[n]&&(n===e?t[n].className="mobile-tab flex-1 py-3 px-2 bg-white dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700":t[n].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),K=e,window.setCurrentTab&&(e==="bodies"||e==="serifs"?window.setCurrentTab("bodies"):e==="joins"&&window.setCurrentTab("joins")),window.updateGridLayers&&window.updateGridLayers()}function Ce(){const e=document.getElementById("mobileSaveMenuBtn"),t=document.getElementById("mobileSizeBtn"),o=document.getElementById("mobilePreviewBtn"),s=document.getElementById("mobileSaveMenu"),n=document.getElementById("mobileSizeMenu"),r=document.getElementById("closeSaveMenu"),i=document.getElementById("closeSizeMenu");if(e&&s&&r&&(e.addEventListener("click",()=>{const d=s.classList.contains("hidden"),l=s.querySelector(".absolute");d?(s.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},200))}),r.addEventListener("click",()=>{const d=s.querySelector(".absolute");s.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}),s.addEventListener("click",d=>{if(d.target===s){const l=s.querySelector(".absolute");s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}})),t&&n&&i&&(t.addEventListener("click",()=>{const d=n.classList.contains("hidden"),l=n.querySelector(".absolute");d?(n.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(n.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{n.classList.add("hidden"),n.classList.remove("opacity-0")},200))}),i.addEventListener("click",()=>{const d=n.querySelector(".absolute");n.classList.add("opacity-0"),d.classList.remove("translate-y-0"),d.classList.add("translate-y-full"),setTimeout(()=>{n.classList.add("hidden"),n.classList.remove("opacity-0")},150)}),n.addEventListener("click",d=>{if(d.target===n){const l=n.querySelector(".absolute");n.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{n.classList.add("hidden"),n.classList.remove("opacity-0")},150)}})),o){let d=!1;o.addEventListener("click",()=>{d=!d,window.setPreviewMode&&window.setPreviewMode(d);const l=o.querySelector("span"),u=document.getElementById("mobilePreviewIcon");d?(o.classList.add("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-gray-600","dark:text-gray-300"),l.classList.add("text-blue-700","dark:text-blue-300")),u&&(u.src="/assets/icons/eye-slash.svg")):(o.classList.remove("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-blue-700","dark:text-blue-300"),l.classList.add("text-gray-600","dark:text-gray-300")),u&&(u.src="/assets/icons/eye.svg"))})}const a=document.getElementById("mobileEraseBtn");a&&Be(a)}let I=!1;function Be(e){e.addEventListener("click",()=>{I=!I,window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight(),window.clearPendingPlacement&&window.clearPendingPlacement();const t=e.querySelector("span"),o=document.getElementById("mobileEraseIcon");I?(e.classList.add("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-gray-600","dark:text-gray-300"),t.classList.add("text-red-700","dark:text-red-300")),o&&(o.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-600","dark:text-gray-300")),o&&(o.src="/assets/icons/erase.svg"));const s=document.querySelector(".builder-grids-wrapper");s&&(I?s.style.cursor="crosshair":s.style.cursor="")})}window.isEraseMode=()=>I;window.hideMobileSaveMenu=function(){const e=document.getElementById("mobileSaveMenu"),t=e==null?void 0:e.querySelector(".absolute");e&&t&&(e.classList.add("opacity-0"),t.classList.remove("translate-y-0"),t.classList.add("translate-y-full"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("opacity-0")},150))};function Te(){const e=document.getElementById("mobileSizeButtons");if(!e)return;["7xl","6xl","5xl","4xl","3xl","2xl","xl","lg","base","sm","xs"].forEach(o=>{const s=document.createElement("button");s.className=`px-4 py-3 rounded-lg text-sm font-medium transition-colors ${o===J?"bg-blue-500 text-white":"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"}`,s.textContent=o,s.addEventListener("click",()=>{J=o,ue(o);const n=document.getElementById("mobileSizeMenu"),r=n.querySelector(".absolute");n.classList.add("opacity-0"),r.classList.remove("translate-y-0"),r.classList.add("translate-y-full"),setTimeout(()=>{n.classList.add("hidden"),n.classList.remove("opacity-0")},150),e.querySelectorAll("button").forEach(i=>{i===s?i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white":i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"})}),e.appendChild(s)})}function ue(e){const t=ae[e]||ae["5xl"],o=document.querySelector(".builder-grids-wrapper");o&&(o.style.transform=`scale(${t})`)}function re(){if(window.innerWidth<768)ue(J);else{const t=document.querySelector(".builder-grids-wrapper");t&&(t.style.transform="scale(1)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(Y,100)}):setTimeout(Y,100);let b=null,N=null,h=null,k=null,L="bodies",S=!1,j=!1,z=null,P=null,q=null;const M={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function A(){await me(),await je(),Me(),ze(),Ve(),Fe(),Re(),Ue(),G(),window.getCellPosition=Z,window.getCellByPosition=O,window.getOccupiedCells=C,window.clearCellHighlights=D,window.placeShapeInCell=te,window.applyPositioning=V,window.applyTextureToShape=fe,window.rulesData=b,window.texturesData=N,window.shapeConfig=M,window.getSelectedShape=()=>h,window.setSelectedShape=e=>{h=e},window.getSelectedTexture=()=>k,window.setSelectedTexture=e=>{k=e},window.handleGridCellClick=ee,window.handleGridCellRightClick=oe,window.handleGridCellLeave=Q,window.clearPendingEraseHighlight=$,window.clearPendingPlacement=H,window.updateSelectedShapeDisplay=F,window.updateGridLayers=G,window.getCurrentTab=()=>L,window.setCurrentTab=e=>{L=e},window.getPreviewMode=()=>S,window.setPreviewMode=e=>{S=e,document.body.classList.toggle("preview-mode",e)},console.log("Builder functions made globally accessible")}async function Ne(){await me(),window.getCellPosition=Z,window.getCellByPosition=O,window.getOccupiedCells=C,window.clearCellHighlights=D,window.placeShapeInCell=te,window.applyPositioning=V,window.rulesData=b,window.shapeConfig=M,console.log("Builder core functions initialized")}async function me(){try{b=await(await fetch("./assets/rules.json")).json()}catch(e){console.error("Failed to load rules.json:",e)}}async function je(){try{N=await(await fetch("./assets/textures/manifest.json")).json()}catch(e){console.error("Failed to load textures manifest.json:",e)}}function Me(){_e(),Ie()}function _e(){const e=document.getElementById("serifsGrid");if(e){e.innerHTML="";for(let t=0;t<25;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="serifs",o.dataset.index=t,o.addEventListener("click",ee),o.addEventListener("contextmenu",oe),o.addEventListener("mouseenter",ge),o.addEventListener("mouseleave",Q),e.appendChild(o)}}}function Ie(){const e=document.getElementById("joinsGrid");if(e){e.innerHTML="";for(let t=0;t<16;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="joins",o.dataset.index=t,o.addEventListener("click",ee),o.addEventListener("contextmenu",oe),o.addEventListener("mouseenter",ge),o.addEventListener("mouseleave",Q),e.appendChild(o)}}}function ze(){Pe(),Ge(),$e(),Ae()}function Pe(){var t;const e=document.getElementById("bodiesShapes");if(e){if(e.innerHTML="",!((t=b==null?void 0:b.shapes)!=null&&t.bodies))return;Object.keys(b.shapes.bodies).forEach(o=>{if(o==="grid")return;b.shapes.bodies[o].forEach(n=>{const r=X("bodies",o,n);e.appendChild(r)})})}}function Ge(){var t;const e=document.getElementById("serifsShapes");if(e){if(e.innerHTML="",!((t=b==null?void 0:b.shapes)!=null&&t.serifs))return;Object.keys(b.shapes.serifs).forEach(o=>{if(o==="grid")return;b.shapes.serifs[o].forEach(n=>{const r=X("serifs",o,n);e.appendChild(r)})})}}function $e(){var t;const e=document.getElementById("joinsShapes");if(e){if(e.innerHTML="",!((t=b==null?void 0:b.shapes)!=null&&t.joins))return;Object.keys(b.shapes.joins).forEach(o=>{if(o==="grid")return;b.shapes.joins[o].forEach(n=>{const r=X("joins",o,n);e.appendChild(r)})})}}function Ae(){const e=document.getElementById("texturesShapes");if(e){if(e.innerHTML="",!(N!=null&&N.textures))return;N.textures.forEach(t=>{const o=qe(t);e.appendChild(o)})}}function qe(e){const t=document.createElement("button");t.className="w-full aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden bg-white dark:bg-slate-900 flex flex-col items-center justify-center relative";const o=document.createElement("div");o.className="w-full h-3/4 bg-cover bg-center",o.style.backgroundImage=`url('/assets/textures/${e.filename}')`;const s=document.createElement("div");return s.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",s.textContent=e.name,t.appendChild(o),t.appendChild(s),t.addEventListener("click",()=>{document.querySelectorAll("#texturesShapes button").forEach(n=>{n.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),n.classList.add("border-gray-300","dark:border-gray-600")}),t.classList.remove("border-gray-300","dark:border-gray-600"),t.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),k=e,F()}),t}function X(e,t,o){const s=document.createElement("button");s.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let n=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(n=window.SVGUtils.createSVGElement(e,t,o.shape_name,"w-8 h-8 object-contain")),n?(n.setAttribute("alt",o.shape_name),s.appendChild(n)):(s.textContent=o.shape_name.substring(0,2),s.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${e}/${t}/${o.shape_name}, using text fallback`)),s.dataset.category=e,s.dataset.angleKey=t,s.dataset.shapeName=o.shape_name,s.dataset.cellOrientation=o.cell_orientation,s.addEventListener("click",()=>Oe(s,e,t,o)),s}function Oe(e,t,o,s){document.querySelectorAll(".shape-selected").forEach(n=>{n.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),e.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),h={category:t,angleKey:o,shape:s,imagePath:`./assets/shapes/${t}/${o}/${s.shape_name}.svg`},F()}function Z(e,t){if(t==="serifs"){const o=Math.floor(e/5),s=e%5;return{row:o,col:s,gridSize:5}}else if(t==="joins"){const o=Math.floor(e/4),s=e%4;return{row:o,col:s,gridSize:4}}}function O(e,t,o){const s=o==="serifs"?5:4;if(e<0||t<0||e>=s||t>=s)return null;const n=e*s+t;return document.getElementById(o+"Grid").children[n]}function C(e,t){const o=e.dataset.grid,s=parseInt(e.dataset.index),n=Z(s,o),r=t.shape.width||1,i=t.shape.height||1,a=[];if(r===2&&i===1){a.push(e);const d=O(n.row,n.col+1,o);d&&a.push(d)}else if(r===1&&i===2){a.push(e);const d=O(n.row+1,n.col,o);d&&a.push(d)}else a.push(e);return a}function ge(e){if(!h)return;const t=e.currentTarget,o=t.dataset.grid,s=b.shapes[h.category].grid;if(o!==s)return;D(),window.innerWidth>=768?C(t,h).forEach(i=>{i&&(i===t?pe(i,h):i.classList.add("cell-highlight-preview"))}):C(t,h).forEach(i=>{i&&i.classList.add("cell-highlight")})}function Q(e){D()}function pe(e,t){const o="absolute shape-preview";let s=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(s=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,o)),s){s.setAttribute("alt",t.shape.shape_name),s.removeAttribute("width"),s.removeAttribute("height");const n=s.getAttribute("viewBox");if(n){const[,,r,i]=n.split(" ").map(Number);s.style.width=`${r}px`,s.style.height=`${i}px`}V(s,t),s.style.opacity="0.6",s.style.pointerEvents="none",e.appendChild(s)}}function D(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid, .cell-highlight-preview").forEach(e=>{e.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid","cell-highlight-preview")}),document.querySelectorAll(".shape-preview").forEach(e=>{e.remove()}),H()}function ee(e){const t=e.currentTarget;if(window.isEraseMode&&window.isEraseMode()||j){He(t);return}if($(),!h){alert("Please select a shape from the sidebar first");return}const o=t.dataset.grid,s=b.shapes[h.category].grid;if(o!==s){alert(`This shape can only be placed on the ${s} grid`);return}const n=C(t,h);if(n.some(i=>!i)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(t,h)){console.log("Placement blocked by constraints");return}if(window.innerWidth<768){if(P===t&&q===h){H(),ie(t,h);return}H(),P=t,q=h,n.forEach(i=>{i&&(i===t?(pe(i,h),i.classList.add("cell-placement-pending")):i.classList.add("cell-highlight-preview"))});return}ie(t,h)}function ie(e,t){const o=C(e,t),n=typeof validateShapeConnections=="function"||t.category!=="bodies"&&t.category!=="joins"||t.shape.width>1||t.shape.height>1;n&&o.forEach(r=>{r&&(r.innerHTML="")}),te(e,t,!n)}function He(e){if(z===e){e.innerHTML="",$();return}$(),e.innerHTML.trim()!==""&&(z=e,e.classList.add("cell-erase-pending"))}function $(){z&&(z.classList.remove("cell-erase-pending"),z=null)}function H(){P&&(C(P,q).forEach(t=>{t&&(t.classList.remove("cell-placement-pending","cell-highlight-preview"),t.querySelectorAll(".shape-preview").forEach(s=>s.remove()))}),P=null,q=null)}function Ue(){const e=document.getElementById("desktopEraseBtn");e&&e.addEventListener("click",()=>{j=!j,$();const t=e.querySelector("span"),o=document.getElementById("desktopEraseIcon");j?(e.classList.add("bg-red-100","dark:bg-red-900"),e.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.add("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-gray-700","dark:text-gray-200"),t.classList.add("text-red-700","dark:text-red-300")),o&&(o.src="/assets/icons/erasing.svg")):(e.classList.remove("bg-red-100","dark:bg-red-900"),e.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),e.classList.remove("hover:bg-red-200","dark:hover:bg-red-800"),t&&(t.classList.remove("text-red-700","dark:text-red-300"),t.classList.add("text-gray-700","dark:text-gray-200")),o&&(o.src="/assets/icons/erase.svg"));const s=document.querySelector(".builder-grids-wrapper");s&&(j?s.style.cursor="crosshair":s.style.cursor="")})}window.isDesktopEraseMode=()=>j;function De(e,t){const{angleKey:o,shape:s}=t,n=s.width||1,r=s.height||1,i=s.cell_orientation,a=`${n}x${r}`,d=M.positioning.joins[a];if(!d)return;const l=d[o]||d.default,u=i.includes("top")?"top":"bottom",c=l[u],m=c.vertical.split(": ");e.style[m[0]]=m[1];const g=i.includes("right")?"right":"left",f=c.horizontal[g].split(": ");e.style[f[0]]=f[1],e.style.transform=""}function V(e,t){const{category:o,angleKey:s,shape:n}=t,r=n.width||1,i=n.height||1,a=n.cell_orientation.split(" "),d=a[0],l=a[1];if(e.style.transform="",o==="joins"&&(r===2||i===2))return De(e,t);if(o==="joins"&&r===1&&i===1){const c=M.positioning.joins["1x1"][s];if(c){const m=a.includes("top")?"top":"bottom",g=c[m];if(g){const f=g.vertical.split(": ");e.style[f[0]]=f[1];const w=a.includes("right")?"right":"left",p=g.horizontal[w].split(": ");e.style[p[0]]=p[1],e.style.transform="";return}}e.style.top="-5%",e.style.left="-5%",e.style.transform="";return}if(o==="bodies"&&(r===2||i===2)){e.style.top="0",e.style.left="0",e.style.transform="";return}if(o==="serifs"){const u=M.positioning.serifs[s];if(!u)return le(e,d,l);if(s==="22_5_deg"){const c=n.shape_name;if(u[c]){const p=u[c];p.left&&(e.style.left=p.left),p.right&&(e.style.right=p.right);const v=p.vertical[d];v&&Object.keys(v).forEach(B=>{e.style[B]=v[B]});return}if(n.cell_orientation.includes("top")||n.cell_orientation.includes("bottom")){const p=u.side,v=p[d]||p.default;Object.keys(v).forEach(T=>{T!=="transform"&&(e.style[T]=v[T])});const B=p.horizontal[l];B&&Object.keys(B).forEach(T=>{e.style[T]=B[T]});return}const g=u.regular,f=g.horizontal[l]||g.horizontal.default,w=g.vertical[d];Object.keys(f).forEach(p=>{e.style[p]=f[p]}),w&&Object.keys(w).forEach(p=>{e.style[p]=w[p]});return}if(s==="45_deg"){const c=n.shape_name,m=u[c];if(m){Object.keys(m).forEach(g=>{e.style[g]=m[g]});return}}}le(e,d,l)}function le(e,t,o){const s=M.positioning.standard,n=s.vertical[t];n&&Object.keys(n).forEach(i=>{if(i==="transform"){const a=n[i];e.style.transform=a[o]||a.default}else e.style[i]=n[i]});const r=s.horizontal[o];r&&(Object.keys(r).forEach(i=>{e.style[i]=r[i]}),o==="center"&&t!=="center"&&(e.style.transform="translateX(-50%)"))}function te(e,t,o=!1){o||(e.innerHTML="");const s="absolute";let n=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(n=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,s)),!n){console.warn("Could not create SVG for shape:",t);const i=document.createElement("div");i.textContent=t.shape.shape_name,i.className=s+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",e.appendChild(i);return}n.setAttribute("alt",t.shape.shape_name),n.removeAttribute("width"),n.removeAttribute("height");const r=n.getAttribute("viewBox");if(r){const[,,i,a]=r.split(" ").map(Number);n.style.width=`${i}px`,n.style.height=`${a}px`}if(V(n,t),k){const i=fe(n,k);e.appendChild(i)}else e.appendChild(n)}function fe(e,t){if(!e||!t)return e;const o=e.cloneNode(!0);o.style.top="",o.style.bottom="",o.style.left="",o.style.right="",o.style.transform="",o.style.position="",o.setAttribute("fill","black"),o.setAttribute("stroke","black"),o.querySelectorAll("*[fill], *[stroke]").forEach(d=>{d.getAttribute("fill")&&d.getAttribute("fill")!=="none"&&d.setAttribute("fill","black"),d.getAttribute("stroke")&&d.getAttribute("stroke")!=="none"&&d.setAttribute("stroke","black")});const n=new XMLSerializer().serializeToString(o),i=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(n)))}`,a=document.createElement("div");return a.className="absolute",a.style.width=e.style.width,a.style.height=e.style.height,a.style.top=e.style.top||"",a.style.bottom=e.style.bottom||"",a.style.left=e.style.left||"",a.style.right=e.style.right||"",a.style.transform=e.style.transform||"",a.style.backgroundImage=`url('/assets/textures/${t.filename}')`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",a.style.webkitMaskImage=`url('${i}')`,a.style.maskImage=`url('${i}')`,a.style.webkitMaskSize="100% 100%",a.style.maskSize="100% 100%",a.style.webkitMaskRepeat="no-repeat",a.style.maskRepeat="no-repeat",a.style.webkitMaskPosition="0 0",a.style.maskPosition="0 0",a.dataset.category=e.dataset.category,a.dataset.angleKey=e.dataset.angleKey,a.dataset.shapeName=e.dataset.shapeName,a.dataset.textured="true",a.dataset.textureId=t.id,a}function Ve(){const e=document.getElementById("bodiesTab"),t=document.getElementById("joinsTab"),o=document.getElementById("texturesTab"),s=document.getElementById("bodiesContent"),n=document.getElementById("joinsContent"),r=document.getElementById("texturesContent");e&&(e.addEventListener("click",()=>{L="bodies",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",s.classList.remove("hidden"),n.classList.add("hidden"),r.classList.add("hidden"),G()}),t.addEventListener("click",()=>{L="joins",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",n.classList.remove("hidden"),s.classList.add("hidden"),r.classList.add("hidden"),G()}),o.addEventListener("click",()=>{L="textures",o.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",r.classList.remove("hidden"),s.classList.add("hidden"),n.classList.add("hidden"),G()}))}function oe(e){e.preventDefault();const t=e.currentTarget;t.innerHTML=""}function F(){const e=document.getElementById("selectedShapeDisplay"),t=document.getElementById("selectedShapeInfo");if(h||k){e.classList.remove("hidden");let o="";h&&(o+=`Shape: ${h.category} > ${h.angleKey} > ${h.shape.shape_name}`),k&&(o&&(o+="<br>"),o+=`Texture: ${k.name}`),t.innerHTML=o}else e.classList.add("hidden")}function Fe(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{h=null,k=null,document.querySelectorAll(".shape-selected").forEach(t=>{t.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),document.querySelectorAll("#texturesShapes button").forEach(t=>{t.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),t.classList.add("border-gray-300","dark:border-gray-600")}),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(t=>{t.classList.remove("selected")}),F()})}function Re(){const e=document.getElementById("previewToggle");e&&e.addEventListener("change",o=>{S=o.target.checked,document.body.classList.toggle("preview-mode",S)});const t=document.getElementById("desktopPreviewBtn");t&&t.addEventListener("click",()=>{S=!S,document.body.classList.toggle("preview-mode",S);const o=t.querySelector("span"),s=document.getElementById("desktopPreviewIcon");S?(t.classList.add("bg-blue-100","dark:bg-blue-900"),t.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.add("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-gray-700","dark:text-gray-200"),o.classList.add("text-blue-700","dark:text-blue-300")),s&&(s.src="/assets/icons/eye-slash.svg")):(t.classList.remove("bg-blue-100","dark:bg-blue-900"),t.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.remove("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-blue-700","dark:text-blue-300"),o.classList.add("text-gray-700","dark:text-gray-200")),s&&(s.src="/assets/icons/eye.svg"))})}function G(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");e&&(L==="bodies"?(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")):L==="joins"&&(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?A():(document.addEventListener("svgSystemReady",A),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",A),A())},100))});window.initBuilderCore=Ne;const We="TypographicTinkerer",Ke=1,E="compositions";let x=null;async function R(){return new Promise((e,t)=>{const o=indexedDB.open(We,Ke);o.onerror=()=>t(o.error),o.onsuccess=()=>{x=o.result,e(x)},o.onupgradeneeded=s=>{if(x=s.target.result,!x.objectStoreNames.contains(E)){const n=x.createObjectStore(E,{keyPath:"id",autoIncrement:!0});n.createIndex("name","name",{unique:!1}),n.createIndex("created","created",{unique:!1})}}})}async function Je(e){return x||await R(),new Promise((t,o)=>{const n=x.transaction([E],"readwrite").objectStore(E),r={...e,saved:new Date().toISOString()},i=n.add(r);i.onsuccess=()=>{console.log("Composition saved to browser:",r.metadata.name),y(`"${r.metadata.name}" saved to browser`,"success"),t(i.result)},i.onerror=()=>{console.error("Failed to save composition:",i.error),y("Failed to save composition","error"),o(i.error)}})}async function Ye(e){const t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(o),n=document.createElement("a");n.href=s;const r=`${e.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;n.download=r,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s),console.log("Composition downloaded:",e.metadata.name),y(`"${e.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await Xe(r)}async function Xe(e){try{const t=await fetch("./archive/manifest.json");let o;t.ok?o=await t.json():o={files:[],lastUpdated:new Date().toISOString().split("T")[0]},o.files.includes(e)||(o.files.push(e),o.files.sort()),o.lastUpdated=new Date().toISOString().split("T")[0];const s=JSON.stringify(o,null,2),n=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(n),i=document.createElement("a");i.href=r,i.download="manifest.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),console.log("ðŸ“‹ Updated manifest downloaded with",o.files.length,"files"),y("Updated manifest.json also downloaded","info")}catch(t){console.warn("Could not generate updated manifest:",t)}}async function U(){return x||await R(),new Promise((e,t)=>{const n=x.transaction([E],"readonly").objectStore(E).getAll();n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)})}async function se(e){return x||await R(),new Promise((t,o)=>{const r=x.transaction([E],"readwrite").objectStore(E).delete(e);r.onsuccess=()=>{console.log("Composition deleted from browser:",e),t()},r.onerror=()=>o(r.error)})}function he(e){return{metadata:{name:e||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:de("serifsGrid","serifs"),joins:de("joinsGrid","joins")}}}function de(e,t){const o=document.getElementById(e),s=[];console.log(`Extracting data from ${e}:`,o);for(let n=0;n<o.children.length;n++){const r=o.children[n],i=r.querySelectorAll("img"),a=r.querySelectorAll("svg"),d=r.querySelectorAll('[data-textured="true"]');i.forEach(l=>{if(l.src){const u=l.src,c=u.split("/"),m=c[c.length-1].replace(".svg",""),g=c[c.length-2],f=c[c.length-3];console.log(`Found img in cell ${n}:`,{srcPath:u,fileName:m,angleKey:g,category:f}),s.push({index:n,category:f,angleKey:g,shapeName:m,imagePath:`./assets/shapes/${f}/${g}/${m}.svg`})}}),a.forEach(l=>{console.log(`Found svg in cell ${n}:`,l);const u=l.getAttribute("data-category"),c=l.getAttribute("data-angle-key"),m=l.getAttribute("data-shape-name");u&&c&&m&&s.push({index:n,category:u,angleKey:c,shapeName:m,imagePath:`./assets/shapes/${u}/${c}/${m}.svg`})}),d.forEach(l=>{console.log(`Found textured element in cell ${n}:`,l);const u=l.dataset.category,c=l.dataset.angleKey,m=l.dataset.shapeName,g=l.dataset.textureId;u&&c&&m&&g&&s.push({index:n,category:u,angleKey:c,shapeName:m,imagePath:`./assets/shapes/${u}/${c}/${m}.svg`,texture:{id:g,applied:!0}})})}return console.log(`Extracted ${s.length} shapes from ${e}`),{gridType:t,gridSize:t==="serifs"?5:4,shapes:s}}function Ze(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=Qe,e.click()}function Qe(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=function(s){var n;try{const r=JSON.parse(s.target.result);ne(r),console.log("Composition loaded from file:",((n=r.metadata)==null?void 0:n.name)||"Unknown")}catch(r){alert("Error loading file: Invalid JSON format"),console.error("Load error:",r)}},o.readAsText(t)}function ne(e){var o,s,n;console.log("Loading composition:",e),be(),(o=e.grids)!=null&&o.serifs&&(console.log("Loading serifs grid with",e.grids.serifs.shapes.length,"shapes"),ce("serifsGrid",e.grids.serifs)),(s=e.grids)!=null&&s.joins&&(console.log("Loading joins grid with",e.grids.joins.shapes.length,"shapes"),ce("joinsGrid",e.grids.joins));const t=((n=e.metadata)==null?void 0:n.name)||"Composition";y(`"${t}" loaded successfully`,"success")}function ce(e,t){const o=document.getElementById(e),s={};t.shapes.forEach(n=>{s[n.index]||(s[n.index]=[]),s[n.index].push(n)}),Object.keys(s).forEach(n=>{const r=o.children[n];if(!r)return;s[n].forEach((a,d)=>{var u,c,m;const l={category:a.category,angleKey:a.angleKey,shape:{shape_name:a.shapeName},imagePath:a.imagePath};if((m=(c=(u=window.rulesData)==null?void 0:u.shapes)==null?void 0:c[a.category])!=null&&m[a.angleKey]){const g=window.rulesData.shapes[a.category][a.angleKey].find(f=>f.shape_name===a.shapeName);if(g)if(l.shape=g,window.placeShapeInCell){const f=d>0;if(window.placeShapeInCell(r,l,f),a.texture&&a.texture.applied&&a.texture.id)if(window.texturesData&&window.applyTextureToShape){const w=window.texturesData.textures.find(p=>p.id===a.texture.id);if(w){const p=r.querySelector(`svg[data-shape-name="${a.shapeName}"]`);if(p){const v=window.applyTextureToShape(p,w);v&&v!==p&&(p.parentNode.replaceChild(v,p),console.log(`Applied texture "${w.name}" to shape "${a.shapeName}"`))}else console.warn("Could not find placed SVG to apply texture")}else console.warn(`Texture not found: ${a.texture.id}`)}else console.warn("Texture system not available")}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",a.shapeName)}else console.warn("Category/angleKey not found in rulesData:",a.category,a.angleKey)})})}function be(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");for(let o=0;o<e.children.length;o++)e.children[o].innerHTML="";for(let o=0;o<t.children.length;o++)t.children[o].innerHTML="";console.log("All grids cleared"),y("Grids cleared","info")}function y(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${t==="success"?"bg-green-500 dark:bg-green-600":t==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)}function ye(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const n=document.createElement("div");n.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const r=document.createElement("div");r.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",r.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${e}</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4";const a=document.createElement("input");a.type="text",a.placeholder=t,a.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",a.value="",i.appendChild(a);const d=document.createElement("div");d.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const l=document.createElement("button");l.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",l.textContent="Cancel",l.onclick=()=>document.body.removeChild(s);const u=document.createElement("button");u.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",u.textContent="Save";const c=()=>{const m=a.value.trim();m?(document.body.removeChild(s),o(m)):(a.focus(),a.className=a.className+" border-red-500",setTimeout(()=>{a.className=a.className.replace(" border-red-500","")},2e3))};u.onclick=c,a.onkeydown=m=>{m.key==="Enter"?c():m.key==="Escape"&&document.body.removeChild(s)},d.appendChild(l),d.appendChild(u),n.appendChild(r),n.appendChild(i),n.appendChild(d),s.appendChild(n),document.body.appendChild(s),setTimeout(()=>a.focus(),100),s.onclick=m=>{m.target===s&&document.body.removeChild(s)}}async function et(){ye("Save Composition","Enter composition name...",async e=>{const t=he(e);try{await Je(t)}catch(o){console.error("Save failed:",o),y("Failed to save composition","error")}})}async function tt(){ye("Save to Computer","Enter composition name...",async e=>{const t=he(e);await Ye(t)})}async function we(){try{const e=await U();if(e.length===0){y("No saved compositions found in browser","info");return}st(e)}catch(e){console.error("Failed to load compositions:",e),y("Failed to load compositions from browser","error")}}function ot(e,t,o){const s=document.createElement("div");s.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const n=document.createElement("div");n.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const r=document.createElement("div");r.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",r.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4",i.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${e.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const a=document.createElement("div");a.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const d=document.createElement("button");d.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",d.textContent="Cancel",d.onclick=()=>document.body.removeChild(s);const l=document.createElement("button");l.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",l.textContent="Delete",l.onclick=async()=>{try{await se(e.id),y(`"${e.metadata.name}" deleted`,"success"),document.body.removeChild(s),o()}catch(c){console.error("Delete failed:",c),y("Failed to delete composition","error")}},a.appendChild(d),a.appendChild(l),n.appendChild(r),n.appendChild(i),n.appendChild(a),s.appendChild(n),document.body.appendChild(s),s.onclick=c=>{c.target===s&&document.body.removeChild(s)};const u=c=>{c.key==="Escape"&&(document.body.removeChild(s),document.removeEventListener("keydown",u))};document.addEventListener("keydown",u)}function st(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const n=document.createElement("div");n.className="max-h-64 overflow-y-auto px-6 py-4",e.forEach((a,d)=>{const l=document.createElement("div");l.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const u=new Date(a.saved||a.metadata.created).toLocaleDateString(),c=document.createElement("div");c.className="flex items-center justify-between";const m=document.createElement("button");m.className="flex-1 text-left",m.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${a.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${u}</div>
    `,m.onclick=()=>{ne(a),document.body.removeChild(t)};const g=document.createElement("button");g.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",g.innerHTML="ðŸ—‘ï¸",g.title="Delete composition",g.onclick=f=>{f.stopPropagation(),ot(a,t,()=>{document.body.removeChild(t),we()})},c.appendChild(m),c.appendChild(g),l.appendChild(c),n.appendChild(l)});const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(t),r.appendChild(i),o.appendChild(s),o.appendChild(n),o.appendChild(r),t.appendChild(o),document.body.appendChild(t),t.onclick=a=>{a.target===t&&document.body.removeChild(t)}}async function nt(){try{if((await U()).length===0){y("No saved compositions found in browser","info");return}const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const s=document.createElement("div");s.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",s.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const n=document.createElement("div");n.className="max-h-64 overflow-y-auto px-6 py-4";const r=async()=>{const d=await U();if(n.innerHTML="",d.length===0){n.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}d.forEach(l=>{const u=document.createElement("div");u.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const c=new Date(l.saved||l.metadata.created).toLocaleDateString(),m=document.createElement("div");m.className="flex items-center justify-between";const g=document.createElement("div");g.className="flex-1",g.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${l.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${c}</div>
        `;const f=document.createElement("div");f.className="flex gap-2 ml-3";const w=document.createElement("button");w.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",w.textContent="Load",w.onclick=()=>{ne(l),document.body.removeChild(t)};const p=document.createElement("button");p.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",p.textContent="Delete",p.onclick=async()=>{if(confirm(`Delete "${l.metadata.name}"?`))try{await se(l.id),y(`"${l.metadata.name}" deleted`,"success"),r()}catch(v){console.error("Delete failed:",v),y("Failed to delete composition","error")}},f.appendChild(w),f.appendChild(p),m.appendChild(g),m.appendChild(f),u.appendChild(m),n.appendChild(u)})};await r();const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const a=document.createElement("button");a.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",a.textContent="Close",a.onclick=()=>document.body.removeChild(t),i.appendChild(a),o.appendChild(s),o.appendChild(n),o.appendChild(i),t.appendChild(o),document.body.appendChild(t),t.onclick=d=>{d.target===t&&document.body.removeChild(t)}}catch(e){console.error("Failed to load compositions:",e),y("Failed to load compositions from browser","error")}}function at(){Ze()}document.addEventListener("DOMContentLoaded",()=>{R().catch(console.error),window.saveComposition=et,window.saveCompositionToComputer=tt,window.loadComposition=at,window.loadFromBrowser=we,window.manageCompositions=nt,window.clearAllGrids=be,window.getAllCompositions=U,window.deleteFromBrowser=se,window.showNotification=y,console.log("Storage functionality initialized")});console.log("Storage module loaded");
