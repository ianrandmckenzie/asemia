const B="TypographicTinkerer";const h="compositions";let p=null;async function w(){return new Promise((t,a)=>{const e=indexedDB.open(B,1);e.onerror=()=>a(e.error),e.onsuccess=()=>{p=e.result,t(p)},e.onupgradeneeded=o=>{if(p=o.target.result,!p.objectStoreNames.contains(h)){const n=p.createObjectStore(h,{keyPath:"id",autoIncrement:!0});n.createIndex("name","name",{unique:!1}),n.createIndex("created","created",{unique:!1})}}})}async function $(t){return p||await w(),new Promise((a,e)=>{const n=p.transaction([h],"readwrite").objectStore(h),d={...t,saved:new Date().toISOString()},s=n.add(d);s.onsuccess=()=>{console.log("Composition saved to browser:",d.metadata.name),u(`"${d.metadata.name}" saved to browser`,"success"),a(s.result)},s.onerror=()=>{console.error("Failed to save composition:",s.error),u("Failed to save composition","error"),e(s.error)}})}async function M(t){const a=JSON.stringify(t,null,2),e=new Blob([a],{type:"application/json"}),o=URL.createObjectURL(e),n=document.createElement("a");n.href=o;const d=`${t.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;n.download=d,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(o),console.log("Composition downloaded:",t.metadata.name),u(`"${t.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await O(d)}async function O(t){try{const a=await fetch("./archive/manifest.json");let e;a.ok?e=await a.json():e={files:[],lastUpdated:new Date().toISOString().split("T")[0]},e.files.includes(t)||(e.files.push(t),e.files.sort()),e.lastUpdated=new Date().toISOString().split("T")[0];const o=JSON.stringify(e,null,2),n=new Blob([o],{type:"application/json"}),d=URL.createObjectURL(n),s=document.createElement("a");s.href=d,s.download="manifest.json",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(d),console.log("📋 Updated manifest downloaded with",e.files.length,"files"),u("Updated manifest.json also downloaded","info")}catch(a){console.warn("Could not generate updated manifest:",a)}}async function v(){return p||await w(),new Promise((t,a)=>{const n=p.transaction([h],"readonly").objectStore(h).getAll();n.onsuccess=()=>t(n.result),n.onerror=()=>a(n.error)})}async function C(t){return p||await w(),new Promise((a,e)=>{const d=p.transaction([h],"readwrite").objectStore(h).delete(t);d.onsuccess=()=>{console.log("Composition deleted from browser:",t),a()},d.onerror=()=>e(d.error)})}function S(t){return{metadata:{name:t||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:N("serifsGrid","serifs"),joins:N("joinsGrid","joins")}}}function N(t,a){const e=document.getElementById(t),o=[];console.log(`Extracting data from ${t}:`,e);for(let n=0;n<e.children.length;n++){const d=e.children[n],s=d.querySelector("img"),r=d.querySelector("svg");if(s&&s.src){const i=s.src,c=i.split("/"),l=c[c.length-1].replace(".svg",""),g=c[c.length-2],m=c[c.length-3];console.log(`Found img in cell ${n}:`,{srcPath:i,fileName:l,angleKey:g,category:m}),o.push({index:n,category:m,angleKey:g,shapeName:l,imagePath:`./assets/shapes/${m}/${g}/${l}.svg`})}else if(r){console.log(`Found svg in cell ${n}:`,r);const i=r.getAttribute("data-category"),c=r.getAttribute("data-angle-key"),l=r.getAttribute("data-shape-name");i&&c&&l&&o.push({index:n,category:i,angleKey:c,shapeName:l,imagePath:`./assets/shapes/${i}/${c}/${l}.svg`})}}return console.log(`Extracted ${o.length} shapes from ${t}`),{gridType:a,gridSize:a==="serifs"?5:4,shapes:o}}function F(){const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=U,t.click()}function U(t){const a=t.target.files[0];if(!a)return;const e=new FileReader;e.onload=function(o){var n;try{const d=JSON.parse(o.target.result);k(d),console.log("Composition loaded from file:",((n=d.metadata)==null?void 0:n.name)||"Unknown")}catch(d){alert("Error loading file: Invalid JSON format"),console.error("Load error:",d)}},e.readAsText(a)}function k(t){var e,o,n;console.log("Loading composition:",t),j(),(e=t.grids)!=null&&e.serifs&&(console.log("Loading serifs grid with",t.grids.serifs.shapes.length,"shapes"),E("serifsGrid",t.grids.serifs)),(o=t.grids)!=null&&o.joins&&(console.log("Loading joins grid with",t.grids.joins.shapes.length,"shapes"),E("joinsGrid",t.grids.joins));const a=((n=t.metadata)==null?void 0:n.name)||"Composition";u(`"${a}" loaded successfully`,"success")}function E(t,a){const e=document.getElementById(t);a.shapes.forEach(o=>{var d,s,r;const n=e.children[o.index];if(n){const i={category:o.category,angleKey:o.angleKey,shape:{shape_name:o.shapeName},imagePath:o.imagePath};if((r=(s=(d=window.rulesData)==null?void 0:d.shapes)==null?void 0:s[o.category])!=null&&r[o.angleKey]){const c=window.rulesData.shapes[o.category][o.angleKey].find(l=>l.shape_name===o.shapeName);c?(i.shape=c,window.placeShapeInCell?window.placeShapeInCell(n,i):console.warn("placeShapeInCell function not available")):console.warn("Shape not found in rulesData:",o.shapeName)}else console.warn("Category/angleKey not found in rulesData:",o.category,o.angleKey)}})}function j(){const t=document.getElementById("serifsGrid"),a=document.getElementById("joinsGrid");for(let e=0;e<t.children.length;e++)t.children[e].innerHTML="";for(let e=0;e<a.children.length;e++)a.children[e].innerHTML="";console.log("All grids cleared"),u("Grids cleared","info")}function u(t,a="info"){const e=document.createElement("div");e.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${a==="success"?"bg-green-500 dark:bg-green-600":a==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,e.textContent=t,document.body.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},3e3)}function L(t,a,e){const o=document.createElement("div");o.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const n=document.createElement("div");n.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${t}</h3>
  `;const s=document.createElement("div");s.className="px-6 py-4";const r=document.createElement("input");r.type="text",r.placeholder=a,r.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",r.value="",s.appendChild(r);const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const c=document.createElement("button");c.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",c.textContent="Cancel",c.onclick=()=>document.body.removeChild(o);const l=document.createElement("button");l.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",l.textContent="Save";const g=()=>{const m=r.value.trim();m?(document.body.removeChild(o),e(m)):(r.focus(),r.className=r.className+" border-red-500",setTimeout(()=>{r.className=r.className.replace(" border-red-500","")},2e3))};l.onclick=g,r.onkeydown=m=>{m.key==="Enter"?g():m.key==="Escape"&&document.body.removeChild(o)},i.appendChild(c),i.appendChild(l),n.appendChild(d),n.appendChild(s),n.appendChild(i),o.appendChild(n),document.body.appendChild(o),setTimeout(()=>r.focus(),100),o.onclick=m=>{m.target===o&&document.body.removeChild(o)}}async function A(){L("Save Composition","Enter composition name...",async t=>{const a=S(t);try{await $(a)}catch(e){console.error("Save failed:",e),u("Failed to save composition","error")}})}async function G(){L("Save to Computer","Enter composition name...",async t=>{const a=S(t);await M(a)})}async function D(){try{const t=await v();if(t.length===0){u("No saved compositions found in browser","info");return}P(t)}catch(t){console.error("Failed to load compositions:",t),u("Failed to load compositions from browser","error")}}function H(t,a,e){const o=document.createElement("div");o.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const n=document.createElement("div");n.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-sm w-full mx-4";const d=document.createElement("div");d.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",d.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const s=document.createElement("div");s.className="px-6 py-4",s.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${t.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const r=document.createElement("div");r.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(o);const c=document.createElement("button");c.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",c.textContent="Delete",c.onclick=async()=>{try{await C(t.id),u(`"${t.metadata.name}" deleted`,"success"),document.body.removeChild(o),e()}catch(g){console.error("Delete failed:",g),u("Failed to delete composition","error")}},r.appendChild(i),r.appendChild(c),n.appendChild(d),n.appendChild(s),n.appendChild(r),o.appendChild(n),document.body.appendChild(o),o.onclick=g=>{g.target===o&&document.body.removeChild(o)};const l=g=>{g.key==="Escape"&&(document.body.removeChild(o),document.removeEventListener("keydown",l))};document.addEventListener("keydown",l)}function P(t){const a=document.createElement("div");a.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const o=document.createElement("div");o.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",o.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const n=document.createElement("div");n.className="max-h-64 overflow-y-auto px-6 py-4",t.forEach((r,i)=>{const c=document.createElement("div");c.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const l=new Date(r.saved||r.metadata.created).toLocaleDateString(),g=document.createElement("div");g.className="flex items-center justify-between";const m=document.createElement("button");m.className="flex-1 text-left",m.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${r.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${l}</div>
    `,m.onclick=()=>{k(r),document.body.removeChild(a)};const y=document.createElement("button");y.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",y.innerHTML="🗑️",y.title="Delete composition",y.onclick=b=>{b.stopPropagation(),H(r,a,()=>{document.body.removeChild(a),D()})},g.appendChild(m),g.appendChild(y),c.appendChild(g),n.appendChild(c)});const d=document.createElement("div");d.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const s=document.createElement("button");s.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",s.textContent="Cancel",s.onclick=()=>document.body.removeChild(a),d.appendChild(s),e.appendChild(o),e.appendChild(n),e.appendChild(d),a.appendChild(e),document.body.appendChild(a),a.onclick=r=>{r.target===a&&document.body.removeChild(a)}}async function R(){try{if((await v()).length===0){u("No saved compositions found in browser","info");return}const a=document.createElement("div");a.className="fixed inset-0 bg-black bg-opacity-50 dark:bg-black dark:bg-opacity-60 z-50 flex items-center justify-center";const e=document.createElement("div");e.className="bg-white dark:bg-slate-900 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const o=document.createElement("div");o.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",o.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const n=document.createElement("div");n.className="max-h-64 overflow-y-auto px-6 py-4";const d=async()=>{const i=await v();if(n.innerHTML="",i.length===0){n.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}i.forEach(c=>{const l=document.createElement("div");l.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const g=new Date(c.saved||c.metadata.created).toLocaleDateString(),m=document.createElement("div");m.className="flex items-center justify-between";const y=document.createElement("div");y.className="flex-1",y.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${c.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${g}</div>
        `;const b=document.createElement("div");b.className="flex gap-2 ml-3";const f=document.createElement("button");f.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",f.textContent="Load",f.onclick=()=>{k(c),document.body.removeChild(a)};const x=document.createElement("button");x.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",x.textContent="Delete",x.onclick=async()=>{if(confirm(`Delete "${c.metadata.name}"?`))try{await C(c.id),u(`"${c.metadata.name}" deleted`,"success"),d()}catch(T){console.error("Delete failed:",T),u("Failed to delete composition","error")}},b.appendChild(f),b.appendChild(x),m.appendChild(y),m.appendChild(b),l.appendChild(m),n.appendChild(l)})};await d();const s=document.createElement("div");s.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const r=document.createElement("button");r.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",r.textContent="Close",r.onclick=()=>document.body.removeChild(a),s.appendChild(r),e.appendChild(o),e.appendChild(n),e.appendChild(s),a.appendChild(e),document.body.appendChild(a),a.onclick=i=>{i.target===a&&document.body.removeChild(a)}}catch(t){console.error("Failed to load compositions:",t),u("Failed to load compositions from browser","error")}}function K(){F()}document.addEventListener("DOMContentLoaded",()=>{w().catch(console.error),window.saveComposition=A,window.saveCompositionToComputer=G,window.loadComposition=K,window.loadFromBrowser=D,window.manageCompositions=R,window.clearAllGrids=j,window.getAllCompositions=v,window.deleteFromBrowser=C,console.log("Storage functionality initialized")});console.log("Storage module loaded");
