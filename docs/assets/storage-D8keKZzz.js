const ie={"7xl":.6,"6xl":.5,"5xl":.4,"4xl":.3,"3xl":.25,"2xl":.2,xl:.167,lg:.15,base:.133,sm:.117,xs:.1};let X="7xl";async function Z(){if(!document.getElementById("mobileSerifTab")){console.log("Mobile builder not needed on this page (no shape tabs found)");return}if(!window.rulesData){console.warn("rulesData not available yet, waiting..."),setTimeout(Z,50);return}Be(),_e(),$e(),de(),window.addEventListener("resize",de),$("serifs"),console.log("Mobile builder initialized")}function Be(){const e=document.getElementById("mobileSerifTab"),t=document.getElementById("mobileBodiesTab"),o=document.getElementById("mobileJoinsTab"),r=document.getElementById("mobileTexturesTab");e&&(J("serifs","mobileSerifShapes"),J("bodies","mobileBodiesShapes"),J("joins","mobileJoinsShapes"),Te("mobileTexturesShapes"),e.addEventListener("click",()=>$("serifs")),t.addEventListener("click",()=>$("bodies")),o.addEventListener("click",()=>$("joins")),r.addEventListener("click",()=>$("textures")))}function J(e,t){var n;const o=document.getElementById(t);if(!o||!((n=window.rulesData)!=null&&n.shapes))return;const r=e.charAt(0).toUpperCase()+e.slice(1);o.innerHTML=`
    <button id="mobile${r}EraseBtn" class="mobile-shape-btn flex-shrink-0">
      <img src="/assets/icons/erase.svg" alt="Erase ${r}" class="w-6 h-6 dark:invert">
    </button>
  `;const s=window.rulesData.shapes[e];s&&Object.keys(s).forEach(i=>{if(i==="grid")return;s[i].forEach(l=>{const d=Ie(e,i,l);o.appendChild(d)})})}function Te(e){var r;const t=document.getElementById(e);if(!t)return;t.innerHTML="";const o=Ne();t.appendChild(o),(r=window.texturesData)!=null&&r.textures&&window.texturesData.textures.forEach(s=>{const n=Me(s);t.appendChild(n)})}function Ne(){const e=document.createElement("div");e.className="flex gap-2 mb-3 pr-2";const t=le("Black","#000000","black");e.appendChild(t);const o=le("White","#FFFFFF","white");e.appendChild(o);const r=je();return e.appendChild(r),e}function le(e,t,o){const r=document.createElement("button");r.className="mobile-shape-btn flex-shrink-0 overflow-hidden flex flex-col",r.dataset.category="textures",r.dataset.colorId=o,r.dataset.colorValue=t;const s=document.createElement("div");s.className="flex-1 w-full",s.style.backgroundColor=t,o==="white"&&(s.style.border="1px solid #d1d5db");const n=document.createElement("div");return n.className="text-[10px] font-medium py-0.5",n.textContent=e,r.appendChild(s),r.appendChild(n),r.addEventListener("click",()=>{fe(r,{type:"color",id:o,name:e,color:t})}),r}function je(){const e=document.createElement("button");e.className="mobile-shape-btn flex-shrink-0 overflow-hidden flex flex-col relative",e.dataset.category="textures",e.type="button";const t=document.createElement("div");t.className="flex-1 w-full relative",t.style.background="linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 25%, #45B7D1 50%, #FFA07A 75%, #98D8C8 100%)";const o=document.createElement("input");o.type="color",o.className="absolute inset-0 w-full h-full opacity-0 cursor-pointer",o.value="#FF6B6B",t.appendChild(o);const r=document.createElement("div");return r.className="text-[10px] font-medium py-0.5",r.textContent="Custom",e.appendChild(t),e.appendChild(r),o.addEventListener("input",s=>{const n=s.target.value;t.style.backgroundColor=n,fe(e,{type:"color",id:"custom",name:"Custom Color",color:n})}),e.addEventListener("click",s=>{s.target!==o&&o.click()}),e}function fe(e,t){typeof N=="function"&&N(),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(r=>{r.classList.remove("selected")}),e.classList.add("selected");const o=document.getElementById("mobileTexturesTab");if(o){const r=o.querySelector(".flex.flex-col");if(r){const s=r.querySelector("svg, img, div.color-indicator"),n=document.createElement("div");n.className="color-indicator h-6 w-6 rounded border border-gray-300 dark:border-gray-600",n.style.backgroundColor=t.color,s&&s.replaceWith(n)}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function Me(e){const t=document.createElement("button");t.className="mobile-shape-btn overflow-hidden",t.dataset.category="textures",t.dataset.textureId=e.id;const o=document.createElement("img");return o.src=`/assets/textures/${e.filename}`,o.alt=e.name,o.className="h-full w-auto object-contain pointer-events-none",t.appendChild(o),t.addEventListener("click",()=>{Ae(t,e)}),t}function Ae(e,t){typeof N=="function"&&N(),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(r=>{r.classList.remove("selected")}),e.classList.add("selected");const o=document.getElementById("mobileTexturesTab");if(o){const r=o.querySelector(".flex.flex-col");if(r){const s=r.querySelector("svg, img");if(s){const n=document.createElement("img");n.src=`/assets/textures/${t.filename}`,n.alt=t.name,n.className="h-6 w-6 object-cover rounded",s.replaceWith(n)}}}window.setSelectedTexture&&window.setSelectedTexture(t),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}function Ie(e,t,o){var n;const r=document.createElement("button");r.className="mobile-shape-btn",r.dataset.category=e,r.dataset.angleKey=t,r.dataset.shapeName=o.shape_name;const s=(n=window.SVGUtils)==null?void 0:n.createSVGElement(e,t,o.shape_name,"h-8 w-auto object-contain pointer-events-none");return s?r.appendChild(s):r.textContent=o.shape_name.substring(0,2),r.addEventListener("click",()=>{Pe(r,e,t,o)}),r}function Pe(e,t,o,r){typeof N=="function"&&N(),window.clearPendingPlacement&&window.clearPendingPlacement(),document.querySelectorAll(".mobile-shape-btn.selected").forEach(n=>{n.dataset.textureId||n.classList.remove("selected")}),document.querySelectorAll(".shape-selected").forEach(n=>{n.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),e.classList.add("selected");const s={category:t,angleKey:o,shape:r,imagePath:`./assets/shapes/${t}/${o}/${r.shape_name}.svg`};window.setSelectedShape&&window.setSelectedShape(s),window.updateSelectedShapeDisplay&&window.updateSelectedShapeDisplay()}let Y=null;function $(e){const t={serifs:document.getElementById("mobileSerifTab"),bodies:document.getElementById("mobileBodiesTab"),joins:document.getElementById("mobileJoinsTab"),textures:document.getElementById("mobileTexturesTab")},o={serifs:document.getElementById("mobileSerifShapes"),bodies:document.getElementById("mobileBodiesShapes"),joins:document.getElementById("mobileJoinsShapes"),textures:document.getElementById("mobileTexturesShapes")},r=document.getElementById("mobileShapeSelectorWrapper");if(window.clearPendingPlacement&&window.clearPendingPlacement(),N(),Y===e){r&&r.classList.add("hidden"),Object.keys(t).forEach(s=>{t[s]&&(t[s].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Object.keys(o).forEach(s=>{o[s]&&o[s].classList.add("hidden")}),Y=null;return}Object.keys(o).forEach(s=>{o[s]&&o[s].classList.add("hidden")}),r&&r.classList.remove("hidden"),o[e]&&o[e].classList.remove("hidden"),Object.keys(t).forEach(s=>{t[s]&&(s===e?t[s].className="mobile-tab flex-1 py-3 px-2 bg-white dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700":t[s].className="mobile-tab flex-1 py-3 px-2 bg-gray-200 dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700")}),Y=e,window.setCurrentTab&&(e==="bodies"||e==="serifs"?window.setCurrentTab("bodies"):e==="joins"&&window.setCurrentTab("joins")),window.updateGridLayers&&window.updateGridLayers()}function _e(){const e=document.getElementById("mobileSaveMenuBtn"),t=document.getElementById("mobileSizeBtn"),o=document.getElementById("mobilePreviewBtn"),r=document.getElementById("mobileSaveMenu"),s=document.getElementById("mobileSizeMenu"),n=document.getElementById("closeSaveMenu"),i=document.getElementById("closeSizeMenu");if(e&&r&&n&&(e.addEventListener("click",()=>{const a=r.classList.contains("hidden"),l=r.querySelector(".absolute");a?(r.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(r.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},200))}),n.addEventListener("click",()=>{const a=r.querySelector(".absolute");r.classList.add("opacity-0"),a.classList.remove("translate-y-0"),a.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},150)}),r.addEventListener("click",a=>{if(a.target===r){const l=r.querySelector(".absolute");r.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{r.classList.add("hidden"),r.classList.remove("opacity-0")},150)}})),t&&s&&i&&(t.addEventListener("click",()=>{const a=s.classList.contains("hidden"),l=s.querySelector(".absolute");a?(s.classList.remove("hidden"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{l.classList.remove("translate-y-full"),l.classList.add("translate-y-0")})})):(s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},200))}),i.addEventListener("click",()=>{const a=s.querySelector(".absolute");s.classList.add("opacity-0"),a.classList.remove("translate-y-0"),a.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}),s.addEventListener("click",a=>{if(a.target===s){const l=s.querySelector(".absolute");s.classList.add("opacity-0"),l.classList.remove("translate-y-0"),l.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150)}})),o){let a=!1;o.addEventListener("click",()=>{a=!a,window.setPreviewMode&&window.setPreviewMode(a);const l=o.querySelector("span"),d=document.getElementById("mobilePreviewIcon");a?(o.classList.add("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-gray-600","dark:text-gray-300"),l.classList.add("text-blue-700","dark:text-blue-300")),d&&(d.src="/assets/icons/eye-slash.svg")):(o.classList.remove("bg-blue-100","dark:bg-blue-900"),l&&(l.classList.remove("text-blue-700","dark:text-blue-300"),l.classList.add("text-gray-600","dark:text-gray-300")),d&&(d.src="/assets/icons/eye.svg"))})}ze()}let k={serifs:!1,bodies:!1,joins:!1};function ze(){const e={serifs:document.getElementById("mobileSerifsEraseBtn"),bodies:document.getElementById("mobileBodiesEraseBtn"),joins:document.getElementById("mobileJoinsEraseBtn")};Object.entries(e).forEach(([t,o])=>{o&&o.addEventListener("click",()=>{k[t]=!k[t],Object.keys(k).forEach(s=>{s!==t&&(k[s]=!1)}),window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight(),window.clearPendingPlacement&&window.clearPendingPlacement(),pe();const r=document.querySelector(".builder-grids-wrapper");if(r){const s=Object.values(k).some(n=>n);r.style.cursor=s?"crosshair":""}})})}function pe(){[{category:"serifs",id:"mobileSerifsEraseBtn"},{category:"bodies",id:"mobileBodiesEraseBtn"},{category:"joins",id:"mobileJoinsEraseBtn"}].forEach(({category:t,id:o})=>{const r=document.getElementById(o);if(!r)return;const s=r.querySelector("img");k[t]?(r.classList.remove("border-gray-300","dark:border-gray-700"),r.classList.add("border-red-500","dark:border-red-400"),r.style.borderWidth="3px",r.style.boxShadow="0 0 0 2px rgb(254 202 202)",s&&(s.src="/assets/icons/erasing.svg")):(r.classList.remove("border-red-500","dark:border-red-400"),r.classList.add("border-gray-300","dark:border-gray-700"),r.style.borderWidth="",r.style.boxShadow="",s&&(s.src="/assets/icons/erase.svg"))})}function N(){k.serifs=!1,k.bodies=!1,k.joins=!1,window.clearPendingEraseHighlight&&window.clearPendingEraseHighlight(),pe();const e=document.querySelector(".builder-grids-wrapper");e&&(e.style.cursor="")}window.isEraseMode=()=>Object.values(k).some(e=>e);window.getMobileEraseCategory=()=>{for(const[e,t]of Object.entries(k))if(t)return e;return null};window.hideMobileSaveMenu=function(){const e=document.getElementById("mobileSaveMenu"),t=e==null?void 0:e.querySelector(".absolute");e&&t&&(e.classList.add("opacity-0"),t.classList.remove("translate-y-0"),t.classList.add("translate-y-full"),setTimeout(()=>{e.classList.add("hidden"),e.classList.remove("opacity-0")},150))};function $e(){const e=document.getElementById("mobileSizeButtons");if(!e)return;["7xl","6xl","5xl","4xl","3xl","2xl","xl","lg","base","sm","xs"].forEach(o=>{const r=document.createElement("button");r.className=`px-4 py-3 rounded-lg text-sm font-medium transition-colors ${o===X?"bg-blue-500 text-white":"bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"}`,r.textContent=o,r.addEventListener("click",()=>{X=o,he(o);const s=document.getElementById("mobileSizeMenu"),n=s.querySelector(".absolute");s.classList.add("opacity-0"),n.classList.remove("translate-y-0"),n.classList.add("translate-y-full"),setTimeout(()=>{s.classList.add("hidden"),s.classList.remove("opacity-0")},150),e.querySelectorAll("button").forEach(i=>{i===r?i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-blue-500 text-white":i.className="px-4 py-3 rounded-lg text-sm font-medium transition-colors bg-gray-100 dark:bg-slate-700 text-gray-700 dark:text-gray-200 hover:bg-gray-200 dark:hover:bg-slate-600"})}),e.appendChild(r)})}function he(e){const t=ie[e]||ie["5xl"],o=document.querySelector(".builder-grids-wrapper");o&&(o.style.transform=`scale(${t})`)}function de(){if(window.innerWidth<768)he(X);else{const t=document.querySelector(".builder-grids-wrapper");t&&(t.style.transform="scale(1)")}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{setTimeout(Z,100)}):setTimeout(Z,100);let y=null,I=null,p=null,C=null,T="bodies",L=!1,w={serifs:!1,bodies:!1,joins:!1},G=null,q=null,H=null;const P={positioning:{joins:{"2x1":{"67_5_deg":{top:{vertical:"bottom: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}},bottom:{vertical:"top: -14%",horizontal:{right:"right: -5%",left:"left: -5%"}}},"112_5_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -27%",left:"right: -27%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}},bottom:{vertical:"top: -15%",horizontal:{right:"left: -15%",left:"right: -15%"}}},default:{top:{vertical:"bottom: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}},bottom:{vertical:"top: 5%",horizontal:{right:"left: -17%",left:"right: -17%"}}}},"1x2":{"67_5_deg":{top:{vertical:"top: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"right: 27%",right:"left: 27%"}}},"112_5_deg":{top:{vertical:"top: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: 27%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"135_deg":{top:{vertical:"bottom: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}},bottom:{vertical:"top: -15%",horizontal:{left:"right: -15%",right:"left: -15%"}}},default:{top:{vertical:"bottom: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}},bottom:{vertical:"top: -17%",horizontal:{left:"right: 5%",right:"left: 5%"}}}},"1x1":{"45_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}},"90_deg":{top:{vertical:"top: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}},bottom:{vertical:"bottom: -5%",horizontal:{left:"left: -5%",right:"right: -5%"}}}}},serifs:{"22_5_deg":{br_to_tl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tr_to_bl:{type:"special",right:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},bl_to_tr:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},tl_to_br:{type:"special",left:"-7%",vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}},side:{type:"side",bottom:{top:"-7%",right:"0",maxHeight:"200%"},top:{bottom:"-7%",left:"0",maxHeight:"200%"},default:{top:"0"},horizontal:{left:{left:"0"},right:{right:"0"},center:{left:"50%",transform:"translateX(-50%)"}}},regular:{type:"regular",horizontal:{right:{left:"-25%",maxWidth:"200%"},left:{right:"-25%",maxWidth:"200%"},default:{left:"0"}},vertical:{top:{top:"0"},bottom:{bottom:"0"},center:{top:"50%",transform:"translateY(-50%)"}}}},"45_deg":{tl_to_br:{right:"0%",top:"0%"},bl_to_tr:{right:"0%",bottom:"0%"},tr_to_bl:{left:"0%",top:"0%"},br_to_tl:{left:"0%",bottom:"0%"},side_tl_to_br:{right:"0%",bottom:"0%"},side_bl_to_tr:{right:"0%",top:"0%"},side_tr_to_bl:{left:"0%",bottom:"0%"},side_br_to_tl:{left:"0%",top:"0%"}}},bodies:{"2x1":{type:"topLeft"},"1x2":{type:"topLeft"},"1x1":{type:"standard"}},standard:{vertical:{top:{top:"0",transform:{center:"translateX(-50%)",default:""}},center:{top:"50%",transform:{center:"translate(-50%, -50%)",default:"translateY(-50%)"}},bottom:{bottom:"0",transform:{center:"translateX(-50%)",default:""}}},horizontal:{left:{left:"0"},center:{left:"50%"},right:{right:"0"}}}}};async function F(){await ye(),await qe(),Oe(),De(),tt(),ot(),rt(),Qe(),O(),window.getCellPosition=ee,window.getCellByPosition=D,window.getOccupiedCells=j,window.clearCellHighlights=R,window.placeShapeInCell=re,window.applyPositioning=W,window.applyTextureToShape=ke,window.rulesData=y,window.texturesData=I,window.shapeConfig=P,window.getSelectedShape=()=>p,window.setSelectedShape=e=>{p=e},window.getSelectedTexture=()=>C,window.setSelectedTexture=e=>{C=e},window.handleGridCellClick=oe,window.handleGridCellRightClick=se,window.handleGridCellLeave=te,window.clearPendingEraseHighlight=_,window.clearPendingPlacement=U,window.updateSelectedShapeDisplay=z,window.updateGridLayers=O,window.getCurrentTab=()=>T,window.setCurrentTab=e=>{T=e},window.getPreviewMode=()=>L,window.setPreviewMode=e=>{L=e,document.body.classList.toggle("preview-mode",e)},console.log("Builder functions made globally accessible")}async function Ge(){await ye(),window.getCellPosition=ee,window.getCellByPosition=D,window.getOccupiedCells=j,window.clearCellHighlights=R,window.placeShapeInCell=re,window.applyPositioning=W,window.rulesData=y,window.shapeConfig=P,console.log("Builder core functions initialized")}async function ye(){try{y=await(await fetch("./assets/rules.json")).json()}catch(e){console.error("Failed to load rules.json:",e)}}async function qe(){try{I=await(await fetch("./assets/textures/manifest.json")).json()}catch(e){console.error("Failed to load textures manifest.json:",e)}}function Oe(){Fe(),He()}function Fe(){const e=document.getElementById("serifsGrid");if(e){e.innerHTML="";for(let t=0;t<25;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="serifs",o.dataset.index=t,o.addEventListener("click",oe),o.addEventListener("contextmenu",se),o.addEventListener("mouseenter",we),o.addEventListener("mouseleave",te),e.appendChild(o)}}}function He(){const e=document.getElementById("joinsGrid");if(e){e.innerHTML="";for(let t=0;t<16;t++){const o=document.createElement("div");o.className="w-[100px] h-[100px] relative cursor-pointer grid-cell",o.dataset.grid="joins",o.dataset.index=t,o.addEventListener("click",oe),o.addEventListener("contextmenu",se),o.addEventListener("mouseenter",we),o.addEventListener("mouseleave",te),e.appendChild(o)}}}function De(){Ue(),Ve(),Re(),We()}function Ue(){var t;const e=document.getElementById("bodiesShapes");if(e){if(e.innerHTML="",!((t=y==null?void 0:y.shapes)!=null&&t.bodies))return;Object.keys(y.shapes.bodies).forEach(o=>{if(o==="grid")return;y.shapes.bodies[o].forEach(s=>{const n=Q("bodies",o,s);e.appendChild(n)})})}}function Ve(){var t;const e=document.getElementById("serifsShapes");if(e){if(e.innerHTML="",!((t=y==null?void 0:y.shapes)!=null&&t.serifs))return;Object.keys(y.shapes.serifs).forEach(o=>{if(o==="grid")return;y.shapes.serifs[o].forEach(s=>{const n=Q("serifs",o,s);e.appendChild(n)})})}}function Re(){var t;const e=document.getElementById("joinsShapes");if(e){if(e.innerHTML="",!((t=y==null?void 0:y.shapes)!=null&&t.joins))return;Object.keys(y.shapes.joins).forEach(o=>{if(o==="grid")return;y.shapes.joins[o].forEach(s=>{const n=Q("joins",o,s);e.appendChild(n)})})}}function We(){const e=document.getElementById("texturesShapes");if(e){e.innerHTML="";const t=Ke();e.appendChild(t);const o=document.createElement("div");if(o.className="col-span-2 h-px bg-gray-300 dark:bg-gray-600 my-2",e.appendChild(o),!(I!=null&&I.textures))return;I.textures.forEach(r=>{const s=Ye(r);e.appendChild(s)})}}function Ke(){const e=document.createElement("div");e.className="col-span-2 grid grid-cols-3 gap-2 mb-2";const t=ce("Black","#000000","black");e.appendChild(t);const o=ce("White","#FFFFFF","white");e.appendChild(o);const r=Je();return e.appendChild(r),e}function ce(e,t,o){const r=document.createElement("button");r.className="aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden flex flex-col items-center justify-center relative",r.dataset.colorId=o,r.dataset.colorValue=t;const s=document.createElement("div");s.className="w-full h-3/4",s.style.backgroundColor=t,o==="white"&&(s.className+=" border border-gray-300 dark:border-gray-600");const n=document.createElement("div");return n.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",n.textContent=e,r.appendChild(s),r.appendChild(n),r.addEventListener("click",()=>{typeof S=="function"&&S(),document.querySelectorAll("#texturesShapes button").forEach(i=>{i.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),i.classList.add("border-gray-300","dark:border-gray-600")}),r.classList.remove("border-gray-300","dark:border-gray-600"),r.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),C={type:"color",id:o,name:e,color:t},z()}),r}function Je(){const e=document.createElement("button");e.className="aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden flex flex-col items-center justify-center relative",e.type="button";const t=document.createElement("div");t.className="w-full h-3/4 relative",t.style.background="linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 25%, #45B7D1 50%, #FFA07A 75%, #98D8C8 100%)";const o=document.createElement("input");o.type="color",o.className="absolute inset-0 w-full h-full opacity-0 cursor-pointer",o.value="#FF6B6B",t.appendChild(o);const r=document.createElement("div");return r.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",r.textContent="Custom",e.appendChild(t),e.appendChild(r),o.addEventListener("input",s=>{const n=s.target.value;t.style.backgroundColor=n,typeof S=="function"&&S(),document.querySelectorAll("#texturesShapes button").forEach(i=>{i.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),i.classList.add("border-gray-300","dark:border-gray-600")}),e.classList.remove("border-gray-300","dark:border-gray-600"),e.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),C={type:"color",id:"custom",name:"Custom Color",color:n},z()}),e.addEventListener("click",s=>{s.target!==o&&o.click()}),e}function Ye(e){const t=document.createElement("button");t.className="w-full aspect-square rounded border-2 border-gray-300 dark:border-gray-600 hover:border-blue-500 dark:hover:border-blue-400 overflow-hidden bg-white dark:bg-slate-900 flex flex-col items-center justify-center relative";const o=document.createElement("div");o.className="w-full h-3/4 bg-cover bg-center",o.style.backgroundImage=`url('/assets/textures/${e.filename}')`;const r=document.createElement("div");return r.className="w-full h-1/4 flex items-center justify-center text-xs font-medium text-gray-700 dark:text-gray-300 px-1 text-center",r.textContent=e.name,t.appendChild(o),t.appendChild(r),t.addEventListener("click",()=>{typeof S=="function"&&S(),document.querySelectorAll("#texturesShapes button").forEach(s=>{s.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),s.classList.add("border-gray-300","dark:border-gray-600")}),t.classList.remove("border-gray-300","dark:border-gray-600"),t.classList.add("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),C=e,z()}),t}function Q(e,t,o){const r=document.createElement("button");r.className="w-12 h-12 border border-gray-300 dark:border-gray-700 rounded hover:border-blue-500 dark:hover:border-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/40 flex items-center justify-center relative shape-button";let s=null;return window.SVGUtils&&window.SVGUtils.createSVGElement&&(s=window.SVGUtils.createSVGElement(e,t,o.shape_name,"w-8 h-8 object-contain")),s?(s.setAttribute("alt",o.shape_name),r.appendChild(s)):(r.textContent=o.shape_name.substring(0,2),r.className+=" text-xs font-mono",console.warn(`Could not create SVG for ${e}/${t}/${o.shape_name}, using text fallback`)),r.dataset.category=e,r.dataset.angleKey=t,r.dataset.shapeName=o.shape_name,r.dataset.cellOrientation=o.cell_orientation,r.addEventListener("click",()=>Xe(r,e,t,o)),r}function Xe(e,t,o,r){typeof S=="function"&&S(),document.querySelectorAll(".shape-selected").forEach(s=>{s.classList.remove("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400")}),e.classList.add("shape-selected","bg-blue-200","border-blue-500","dark:bg-blue-800/40","dark:border-blue-400"),p={category:t,angleKey:o,shape:r,imagePath:`./assets/shapes/${t}/${o}/${r.shape_name}.svg`},z()}function ee(e,t){if(t==="serifs"){const o=Math.floor(e/5),r=e%5;return{row:o,col:r,gridSize:5}}else if(t==="joins"){const o=Math.floor(e/4),r=e%4;return{row:o,col:r,gridSize:4}}}function D(e,t,o){const r=o==="serifs"?5:4;if(e<0||t<0||e>=r||t>=r)return null;const s=e*r+t;return document.getElementById(o+"Grid").children[s]}function j(e,t){const o=e.dataset.grid,r=parseInt(e.dataset.index),s=ee(r,o),n=t.shape.width||1,i=t.shape.height||1,a=[];if(n===2&&i===1){a.push(e);const l=D(s.row,s.col+1,o);l&&a.push(l)}else if(n===1&&i===2){a.push(e);const l=D(s.row+1,s.col,o);l&&a.push(l)}else a.push(e);return a}function we(e){if(!p)return;const t=e.currentTarget,o=t.dataset.grid,r=y.shapes[p.category].grid;if(o!==r)return;R(),window.innerWidth>=768?j(t,p).forEach(i=>{i&&(i===t?ve(i,p):i.classList.add("cell-highlight-preview"))}):j(t,p).forEach(i=>{i&&i.classList.add("cell-highlight")})}function te(e){R()}function ve(e,t){const o="absolute shape-preview";let r=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(r=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,o)),r){r.setAttribute("alt",t.shape.shape_name),r.removeAttribute("width"),r.removeAttribute("height");const s=r.getAttribute("viewBox");if(s){const[,,n,i]=s.split(" ").map(Number);r.style.width=`${n}px`,r.style.height=`${i}px`}W(r,t),r.style.opacity="0.6",r.style.pointerEvents="none",e.appendChild(r)}}function R(){document.querySelectorAll(".cell-highlight, .cell-highlight-valid, .cell-highlight-invalid, .cell-highlight-preview").forEach(e=>{e.classList.remove("cell-highlight","cell-highlight-valid","cell-highlight-invalid","cell-highlight-preview")}),document.querySelectorAll(".shape-preview").forEach(e=>{e.remove()}),U()}function oe(e){const t=e.currentTarget,o=w.serifs||w.bodies||w.joins;if(window.isEraseMode&&window.isEraseMode()||o){Ze(t);return}if(_(),!p){alert("Please select a shape from the sidebar first");return}const r=t.dataset.grid,s=y.shapes[p.category].grid;if(r!==s){alert(`This shape can only be placed on the ${s} grid`);return}const n=j(t,p);if(n.some(a=>!a)){alert("Shape extends beyond grid boundaries");return}if(typeof validateShapeConnections=="function"&&!validateShapeConnections(t,p)){console.log("Placement blocked by constraints");return}if(window.innerWidth<768){if(q===t&&H===p){U(),ue(t,p);return}U(),q=t,H=p,n.forEach(a=>{a&&(a===t?(ve(a,p),a.classList.add("cell-placement-pending")):a.classList.add("cell-highlight-preview"))});return}ue(t,p)}function ue(e,t){const o=j(e,t),s=typeof validateShapeConnections=="function"||t.category!=="bodies"&&t.category!=="joins"||t.shape.width>1||t.shape.height>1;s&&o.forEach(n=>{n&&(n.innerHTML="")}),re(e,t,!s)}function Ze(e){let t=null;if(w.serifs?t="serifs":w.bodies?t="bodies":w.joins&&(t="joins"),window.isEraseMode&&window.isEraseMode()){const r=window.getMobileEraseCategory?window.getMobileEraseCategory():null;r&&(t=r)}if(!t)return;if(G===e){e.querySelectorAll("[data-category]").forEach(s=>{s.dataset.category===t&&s.remove()}),e.innerHTML.trim()===""&&(e.innerHTML=""),_();return}_(),e.querySelector(`[data-category="${t}"]`)&&(G=e,e.classList.add("cell-erase-pending"))}function _(){G&&(G.classList.remove("cell-erase-pending"),G=null)}function U(){q&&(j(q,H).forEach(t=>{t&&(t.classList.remove("cell-placement-pending","cell-highlight-preview"),t.querySelectorAll(".shape-preview").forEach(r=>r.remove()))}),q=null,H=null)}function Qe(){const e={serifs:document.getElementById("serifsEraseBtn"),bodies:document.getElementById("bodiesEraseBtn"),joins:document.getElementById("joinsEraseBtn")};Object.entries(e).forEach(([t,o])=>{o&&o.addEventListener("click",()=>{w[t]=!w[t],Object.keys(w).forEach(s=>{s!==t&&(w[s]=!1)}),_(),xe();const r=document.querySelector(".builder-grids-wrapper");if(r){const s=Object.values(w).some(n=>n);r.style.cursor=s?"crosshair":""}})})}function xe(){[{category:"serifs",id:"serifsEraseBtn"},{category:"bodies",id:"bodiesEraseBtn"},{category:"joins",id:"joinsEraseBtn"}].forEach(({category:t,id:o})=>{const r=document.getElementById(o);if(!r)return;const s=r.querySelector("img");w[t]?(r.classList.remove("border-gray-300","dark:border-gray-700"),r.classList.remove("hover:border-red-500","dark:hover:border-red-400"),r.classList.remove("hover:bg-red-50","dark:hover:bg-red-900/40"),r.classList.add("bg-red-200","border-red-500","dark:bg-red-800/40","dark:border-red-400"),r.classList.add("hover:bg-red-300","dark:hover:bg-red-700/40"),s&&(s.src="/assets/icons/erasing.svg")):(r.classList.remove("bg-red-200","border-red-500","dark:bg-red-800/40","dark:border-red-400"),r.classList.remove("hover:bg-red-300","dark:hover:bg-red-700/40"),r.classList.add("border-gray-300","dark:border-gray-700"),r.classList.add("hover:border-red-500","dark:hover:border-red-400"),r.classList.add("hover:bg-red-50","dark:hover:bg-red-900/40"),s&&(s.src="/assets/icons/erase.svg"))})}window.isDesktopEraseMode=()=>Object.values(w).some(e=>e);window.getActiveEraseCategory=()=>{for(const[e,t]of Object.entries(w))if(t)return e;return null};function et(e,t){const{angleKey:o,shape:r}=t,s=r.width||1,n=r.height||1,i=r.cell_orientation,a=`${s}x${n}`,l=P.positioning.joins[a];if(!l)return;const d=l[o]||l.default,c=i.includes("top")?"top":"bottom",u=d[c],m=u.vertical.split(": ");e.style[m[0]]=m[1];const b=i.includes("right")?"right":"left",f=u.horizontal[b].split(": ");e.style[f[0]]=f[1],e.style.transform=""}function W(e,t){const{category:o,angleKey:r,shape:s}=t,n=s.width||1,i=s.height||1,a=s.cell_orientation.split(" "),l=a[0],d=a[1];if(e.style.transform="",o==="joins"&&(n===2||i===2))return et(e,t);if(o==="joins"&&n===1&&i===1){const u=P.positioning.joins["1x1"][r];if(u){const m=a.includes("top")?"top":"bottom",b=u[m];if(b){const f=b.vertical.split(": ");e.style[f[0]]=f[1];const h=a.includes("right")?"right":"left",g=b.horizontal[h].split(": ");e.style[g[0]]=g[1],e.style.transform="";return}}e.style.top="-5%",e.style.left="-5%",e.style.transform="";return}if(o==="bodies"&&(n===2||i===2)){e.style.top="0",e.style.left="0",e.style.transform="";return}if(o==="serifs"){const c=P.positioning.serifs[r];if(!c)return me(e,l,d);if(r==="22_5_deg"){const u=s.shape_name;if(c[u]){const g=c[u];g.left&&(e.style.left=g.left),g.right&&(e.style.right=g.right);const v=g.vertical[l];v&&Object.keys(v).forEach(M=>{e.style[M]=v[M]});return}if(s.cell_orientation.includes("top")||s.cell_orientation.includes("bottom")){const g=c.side,v=g[l]||g.default;Object.keys(v).forEach(A=>{A!=="transform"&&(e.style[A]=v[A])});const M=g.horizontal[d];M&&Object.keys(M).forEach(A=>{e.style[A]=M[A]});return}const b=c.regular,f=b.horizontal[d]||b.horizontal.default,h=b.vertical[l];Object.keys(f).forEach(g=>{e.style[g]=f[g]}),h&&Object.keys(h).forEach(g=>{e.style[g]=h[g]});return}if(r==="45_deg"){const u=s.shape_name,m=c[u];if(m){Object.keys(m).forEach(b=>{e.style[b]=m[b]});return}}}me(e,l,d)}function me(e,t,o){const r=P.positioning.standard,s=r.vertical[t];s&&Object.keys(s).forEach(i=>{if(i==="transform"){const a=s[i];e.style.transform=a[o]||a.default}else e.style[i]=s[i]});const n=r.horizontal[o];n&&(Object.keys(n).forEach(i=>{e.style[i]=n[i]}),o==="center"&&t!=="center"&&(e.style.transform="translateX(-50%)"))}function re(e,t,o=!1){o||(e.innerHTML="");const r="absolute";let s=null;if(window.SVGUtils&&window.SVGUtils.createSVGElement&&(s=window.SVGUtils.createSVGElement(t.category,t.angleKey,t.shape.shape_name,r)),!s){console.warn("Could not create SVG for shape:",t);const i=document.createElement("div");i.textContent=t.shape.shape_name,i.className=r+" text-xs font-mono text-center text-gray-600 dark:text-gray-300",i.style.display="flex",i.style.alignItems="center",i.style.justifyContent="center",e.appendChild(i);return}s.setAttribute("alt",t.shape.shape_name),s.removeAttribute("width"),s.removeAttribute("height");const n=s.getAttribute("viewBox");if(n){const[,,i,a]=n.split(" ").map(Number);s.style.width=`${i}px`,s.style.height=`${a}px`}if(W(s,t),C){const i=ke(s,C);e.appendChild(i)}else e.appendChild(s)}function ke(e,t){if(!e||!t)return e;if(t.type==="color"){const l=e.cloneNode(!0);return l.setAttribute("fill",t.color),l.setAttribute("stroke",t.color),l.querySelectorAll("*[fill], *[stroke]").forEach(c=>{c.getAttribute("fill")&&c.getAttribute("fill")!=="none"&&c.setAttribute("fill",t.color),c.getAttribute("stroke")&&c.getAttribute("stroke")!=="none"&&c.setAttribute("stroke",t.color)}),l.dataset.category=e.dataset.category,l.dataset.angleKey=e.dataset.angleKey,l.dataset.shapeName=e.dataset.shapeName,l.dataset.textured="true",l.dataset.textureId=t.id,l.dataset.textureType="color",l.dataset.textureColor=t.color,l}const o=e.cloneNode(!0);o.style.top="",o.style.bottom="",o.style.left="",o.style.right="",o.style.transform="",o.style.position="",o.setAttribute("fill","black"),o.setAttribute("stroke","black"),o.querySelectorAll("*[fill], *[stroke]").forEach(l=>{l.getAttribute("fill")&&l.getAttribute("fill")!=="none"&&l.setAttribute("fill","black"),l.getAttribute("stroke")&&l.getAttribute("stroke")!=="none"&&l.setAttribute("stroke","black")});const s=new XMLSerializer().serializeToString(o),i=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(s)))}`,a=document.createElement("div");return a.className="absolute",a.style.width=e.style.width,a.style.height=e.style.height,a.style.top=e.style.top||"",a.style.bottom=e.style.bottom||"",a.style.left=e.style.left||"",a.style.right=e.style.right||"",a.style.transform=e.style.transform||"",a.style.backgroundImage=`url('/assets/textures/${t.filename}')`,a.style.backgroundSize="cover",a.style.backgroundPosition="center",a.style.webkitMaskImage=`url('${i}')`,a.style.maskImage=`url('${i}')`,a.style.webkitMaskSize="100% 100%",a.style.maskSize="100% 100%",a.style.webkitMaskRepeat="no-repeat",a.style.maskRepeat="no-repeat",a.style.webkitMaskPosition="0 0",a.style.maskPosition="0 0",a.dataset.category=e.dataset.category,a.dataset.angleKey=e.dataset.angleKey,a.dataset.shapeName=e.dataset.shapeName,a.dataset.textured="true",a.dataset.textureId=t.id,a.dataset.textureType="image",a}function tt(){const e=document.getElementById("bodiesTab"),t=document.getElementById("joinsTab"),o=document.getElementById("texturesTab"),r=document.getElementById("bodiesContent"),s=document.getElementById("joinsContent"),n=document.getElementById("texturesContent");e&&(e.addEventListener("click",()=>{T="bodies",e.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",r.classList.remove("hidden"),s.classList.add("hidden"),n.classList.add("hidden"),S(),O()}),t.addEventListener("click",()=>{T="joins",t.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",o.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 font-medium text-gray-700 dark:text-gray-200",s.classList.remove("hidden"),r.classList.add("hidden"),n.classList.add("hidden"),S(),O()}),o.addEventListener("click",()=>{T="textures",o.className="flex-1 py-3 px-4 bg-white dark:bg-slate-800 font-medium text-gray-900 dark:text-gray-100",e.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",t.className="flex-1 py-3 px-4 bg-gray-200 dark:bg-slate-700 border-r border-gray-300 dark:border-gray-700 font-medium text-gray-700 dark:text-gray-200",n.classList.remove("hidden"),r.classList.add("hidden"),s.classList.add("hidden"),S(),O()}))}function S(){w.serifs=!1,w.bodies=!1,w.joins=!1,_(),xe();const e=document.querySelector(".builder-grids-wrapper");e&&(e.style.cursor="")}function se(e){e.preventDefault();const t=e.currentTarget;t.innerHTML=""}function z(){const e=document.getElementById("selectedShapeDisplay"),t=document.getElementById("selectedShapeInfo");if(p||C){e.classList.remove("hidden");let o="";p&&(o+=`Shape: ${p.category} > ${p.angleKey} > ${p.shape.shape_name}`),C&&(o&&(o+="<br>"),o+=`Texture: ${C.name}`),t.innerHTML=o}else e.classList.add("hidden")}function ot(){document.getElementById("clearSelection")&&document.getElementById("clearSelection").addEventListener("click",()=>{p=null,C=null,document.querySelectorAll(".shape-selected").forEach(t=>{t.classList.remove("shape-selected","bg-blue-200","border-blue-500")}),document.querySelectorAll("#texturesShapes button").forEach(t=>{t.classList.remove("border-blue-500","dark:border-blue-400","bg-blue-50","dark:bg-blue-900"),t.classList.add("border-gray-300","dark:border-gray-600")}),document.querySelectorAll('.mobile-shape-btn[data-category="textures"]').forEach(t=>{t.classList.remove("selected")}),z()})}function rt(){const e=document.getElementById("previewToggle");e&&e.addEventListener("change",o=>{L=o.target.checked,document.body.classList.toggle("preview-mode",L)});const t=document.getElementById("desktopPreviewBtn");t&&t.addEventListener("click",()=>{L=!L,document.body.classList.toggle("preview-mode",L);const o=t.querySelector("span"),r=document.getElementById("desktopPreviewIcon");L?(t.classList.add("bg-blue-100","dark:bg-blue-900"),t.classList.remove("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.add("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-gray-700","dark:text-gray-200"),o.classList.add("text-blue-700","dark:text-blue-300")),r&&(r.src="/assets/icons/eye-slash.svg")):(t.classList.remove("bg-blue-100","dark:bg-blue-900"),t.classList.add("hover:bg-gray-50","dark:hover:bg-slate-700"),t.classList.remove("hover:bg-blue-200","dark:hover:bg-blue-800"),o&&(o.classList.remove("text-blue-700","dark:text-blue-300"),o.classList.add("text-gray-700","dark:text-gray-200")),r&&(r.src="/assets/icons/eye.svg"))})}function O(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");e&&(T==="bodies"?(e.style.zIndex="20",t.style.zIndex="10",e.classList.remove("grid-inactive"),e.classList.add("grid-active"),t.classList.remove("grid-active"),t.classList.add("grid-inactive")):T==="joins"&&(t.style.zIndex="20",e.style.zIndex="10",t.classList.remove("grid-inactive"),t.classList.add("grid-active"),e.classList.remove("grid-active"),e.classList.add("grid-inactive")))}document.addEventListener("DOMContentLoaded",()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()?F():(document.addEventListener("svgSystemReady",F),setTimeout(()=>{window.SVGUtils&&window.SVGUtils.isReady&&window.SVGUtils.isReady()&&(document.removeEventListener("svgSystemReady",F),F())},100))});window.initBuilderCore=Ge;const st="TypographicTinkerer",at=1,B="compositions";let E=null;async function K(){return new Promise((e,t)=>{const o=indexedDB.open(st,at);o.onerror=()=>t(o.error),o.onsuccess=()=>{E=o.result,e(E)},o.onupgradeneeded=r=>{if(E=r.target.result,!E.objectStoreNames.contains(B)){const s=E.createObjectStore(B,{keyPath:"id",autoIncrement:!0});s.createIndex("name","name",{unique:!1}),s.createIndex("created","created",{unique:!1})}}})}async function nt(e){return E||await K(),new Promise((t,o)=>{const s=E.transaction([B],"readwrite").objectStore(B),n={...e,saved:new Date().toISOString()},i=s.add(n);i.onsuccess=()=>{console.log("Composition saved to browser:",n.metadata.name),x(`"${n.metadata.name}" saved to browser`,"success"),t(i.result)},i.onerror=()=>{console.error("Failed to save composition:",i.error),x("Failed to save composition","error"),o(i.error)}})}async function it(e){const t=JSON.stringify(e,null,2),o=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(o),s=document.createElement("a");s.href=r;const n=`${e.metadata.name.replace(/[^a-z0-9]/gi,"_")}.json`;s.download=n,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r),console.log("Composition downloaded:",e.metadata.name),x(`"${e.metadata.name}" downloaded`,"success"),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&await lt(n)}async function lt(e){try{const t=await fetch("./archive/manifest.json");let o;t.ok?o=await t.json():o={files:[],lastUpdated:new Date().toISOString().split("T")[0]},o.files.includes(e)||(o.files.push(e),o.files.sort()),o.lastUpdated=new Date().toISOString().split("T")[0];const r=JSON.stringify(o,null,2),s=new Blob([r],{type:"application/json"}),n=URL.createObjectURL(s),i=document.createElement("a");i.href=n,i.download="manifest.json",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n),console.log("ðŸ“‹ Updated manifest downloaded with",o.files.length,"files"),x("Updated manifest.json also downloaded","info")}catch(t){console.warn("Could not generate updated manifest:",t)}}async function V(){return E||await K(),new Promise((e,t)=>{const s=E.transaction([B],"readonly").objectStore(B).getAll();s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}async function ae(e){return E||await K(),new Promise((t,o)=>{const n=E.transaction([B],"readwrite").objectStore(B).delete(e);n.onsuccess=()=>{console.log("Composition deleted from browser:",e),t()},n.onerror=()=>o(n.error)})}function Ee(e){return{metadata:{name:e||"Untitled",created:new Date().toISOString(),version:"1.0"},grids:{serifs:ge("serifsGrid","serifs"),joins:ge("joinsGrid","joins")}}}function ge(e,t){const o=document.getElementById(e),r=[];console.log(`Extracting data from ${e}:`,o);for(let s=0;s<o.children.length;s++){const n=o.children[s],i=n.querySelectorAll("img"),a=n.querySelectorAll("svg"),l=n.querySelectorAll('[data-textured="true"]');i.forEach(d=>{if(d.src){const c=d.src,u=c.split("/"),m=u[u.length-1].replace(".svg",""),b=u[u.length-2],f=u[u.length-3];console.log(`Found img in cell ${s}:`,{srcPath:c,fileName:m,angleKey:b,category:f}),r.push({index:s,category:f,angleKey:b,shapeName:m,imagePath:`./assets/shapes/${f}/${b}/${m}.svg`})}}),a.forEach(d=>{if(d.dataset.textured==="true")return;console.log(`Found svg in cell ${s}:`,d);const c=d.getAttribute("data-category"),u=d.getAttribute("data-angle-key"),m=d.getAttribute("data-shape-name");c&&u&&m&&r.push({index:s,category:c,angleKey:u,shapeName:m,imagePath:`./assets/shapes/${c}/${u}/${m}.svg`})}),l.forEach(d=>{console.log(`Found textured element in cell ${s}:`,d);const c=d.dataset.category,u=d.dataset.angleKey,m=d.dataset.shapeName,b=d.dataset.textureId,f=d.dataset.textureType,h=d.dataset.textureColor;if(c&&u&&m&&b){const g={id:b,applied:!0};f==="color"&&h&&(g.type="color",g.color=h),r.push({index:s,category:c,angleKey:u,shapeName:m,imagePath:`./assets/shapes/${c}/${u}/${m}.svg`,texture:g})}})}return console.log(`Extracted ${r.length} shapes from ${e}`),{gridType:t,gridSize:t==="serifs"?5:4,shapes:r}}function dt(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=ct,e.click()}function ct(e){const t=e.target.files[0];if(!t)return;const o=new FileReader;o.onload=function(r){var s;try{const n=JSON.parse(r.target.result);ne(n),console.log("Composition loaded from file:",((s=n.metadata)==null?void 0:s.name)||"Unknown")}catch(n){alert("Error loading file: Invalid JSON format"),console.error("Load error:",n)}},o.readAsText(t)}function ne(e){var o,r,s;console.log("Loading composition:",e),Ce(),(o=e.grids)!=null&&o.serifs&&(console.log("Loading serifs grid with",e.grids.serifs.shapes.length,"shapes"),be("serifsGrid",e.grids.serifs)),(r=e.grids)!=null&&r.joins&&(console.log("Loading joins grid with",e.grids.joins.shapes.length,"shapes"),be("joinsGrid",e.grids.joins));const t=((s=e.metadata)==null?void 0:s.name)||"Composition";x(`"${t}" loaded successfully`,"success")}function be(e,t){const o=document.getElementById(e),r={};t.shapes.forEach(s=>{r[s.index]||(r[s.index]=[]),r[s.index].push(s)}),Object.keys(r).forEach(s=>{const n=o.children[s];if(!n)return;r[s].forEach((a,l)=>{var c,u,m;const d={category:a.category,angleKey:a.angleKey,shape:{shape_name:a.shapeName},imagePath:a.imagePath};if((m=(u=(c=window.rulesData)==null?void 0:c.shapes)==null?void 0:u[a.category])!=null&&m[a.angleKey]){const b=window.rulesData.shapes[a.category][a.angleKey].find(f=>f.shape_name===a.shapeName);if(b)if(d.shape=b,window.placeShapeInCell){const f=l>0;if(window.placeShapeInCell(n,d,f),a.texture&&a.texture.applied&&a.texture.id)if(a.texture.type==="color"&&a.texture.color){const h={type:"color",id:a.texture.id,name:a.texture.id==="black"?"Black":a.texture.id==="white"?"White":"Custom Color",color:a.texture.color};if(window.applyTextureToShape){const g=n.querySelector(`svg[data-shape-name="${a.shapeName}"]`);if(g){const v=window.applyTextureToShape(g,h);v&&v!==g&&(g.parentNode.replaceChild(v,g),console.log(`Applied color "${h.color}" to shape "${a.shapeName}"`))}else console.warn("Could not find placed SVG to apply color")}}else if(window.texturesData&&window.applyTextureToShape){const h=window.texturesData.textures.find(g=>g.id===a.texture.id);if(h){const g=n.querySelector(`svg[data-shape-name="${a.shapeName}"]`);if(g){const v=window.applyTextureToShape(g,h);v&&v!==g&&(g.parentNode.replaceChild(v,g),console.log(`Applied texture "${h.name}" to shape "${a.shapeName}"`))}else console.warn("Could not find placed SVG to apply texture")}else console.warn(`Texture not found: ${a.texture.id}`)}else console.warn("Texture system not available")}else console.warn("placeShapeInCell function not available");else console.warn("Shape not found in rulesData:",a.shapeName)}else console.warn("Category/angleKey not found in rulesData:",a.category,a.angleKey)})})}function Ce(){const e=document.getElementById("serifsGrid"),t=document.getElementById("joinsGrid");for(let o=0;o<e.children.length;o++)e.children[o].innerHTML="";for(let o=0;o<t.children.length;o++)t.children[o].innerHTML="";console.log("All grids cleared"),x("Grids cleared","info")}function x(e,t="info"){const o=document.createElement("div");o.className=`fixed top-4 left-1/2 transform -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg text-white text-sm font-medium ${t==="success"?"bg-green-500 dark:bg-green-600":t==="error"?"bg-red-500 dark:bg-red-600":"bg-blue-500 dark:bg-blue-600"}`,o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.parentNode&&o.parentNode.removeChild(o)},3e3)}function Se(e,t,o){const r=document.createElement("div");r.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const s=document.createElement("div");s.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">${e}</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4";const a=document.createElement("input");a.type="text",a.placeholder=t,a.className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-slate-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none",a.value="",i.appendChild(a);const l=document.createElement("div");l.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const d=document.createElement("button");d.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",d.textContent="Cancel",d.onclick=()=>document.body.removeChild(r);const c=document.createElement("button");c.className="px-4 py-2 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded-lg transition-colors",c.textContent="Save";const u=()=>{const m=a.value.trim();m?(document.body.removeChild(r),o(m)):(a.focus(),a.className=a.className+" border-red-500",setTimeout(()=>{a.className=a.className.replace(" border-red-500","")},2e3))};c.onclick=u,a.onkeydown=m=>{m.key==="Enter"?u():m.key==="Escape"&&document.body.removeChild(r)},l.appendChild(d),l.appendChild(c),s.appendChild(n),s.appendChild(i),s.appendChild(l),r.appendChild(s),document.body.appendChild(r),setTimeout(()=>a.focus(),100),r.onclick=m=>{m.target===r&&document.body.removeChild(r)}}async function ut(){Se("Save Composition","Enter composition name...",async e=>{const t=Ee(e);try{await nt(t)}catch(o){console.error("Save failed:",o),x("Failed to save composition","error")}})}async function mt(){Se("Save to Computer","Enter composition name...",async e=>{const t=Ee(e);await it(t)})}async function Le(){try{const e=await V();if(e.length===0){x("No saved compositions found in browser","info");return}bt(e)}catch(e){console.error("Failed to load compositions:",e),x("Failed to load compositions from browser","error")}}function gt(e,t,o){const r=document.createElement("div");r.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const s=document.createElement("div");s.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-sm w-full mx-4";const n=document.createElement("div");n.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",n.innerHTML=`
    <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Delete Composition</h3>
  `;const i=document.createElement("div");i.className="px-6 py-4",i.innerHTML=`
    <p class="text-gray-700 dark:text-gray-200">Are you sure you want to delete <strong>"${e.metadata.name}"</strong>?</p>
    <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">This action cannot be undone.</p>
  `;const a=document.createElement("div");a.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end gap-3";const l=document.createElement("button");l.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-lg transition-colors",l.textContent="Cancel",l.onclick=()=>document.body.removeChild(r);const d=document.createElement("button");d.className="px-4 py-2 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded-lg transition-colors",d.textContent="Delete",d.onclick=async()=>{try{await ae(e.id),x(`"${e.metadata.name}" deleted`,"success"),document.body.removeChild(r),o()}catch(u){console.error("Delete failed:",u),x("Failed to delete composition","error")}},a.appendChild(l),a.appendChild(d),s.appendChild(n),s.appendChild(i),s.appendChild(a),r.appendChild(s),document.body.appendChild(r),r.onclick=u=>{u.target===r&&document.body.removeChild(r)};const c=u=>{u.key==="Escape"&&(document.body.removeChild(r),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c)}function bt(e){const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-96 overflow-hidden";const r=document.createElement("div");r.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",r.innerHTML=`
    <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Load Composition</h3>
    <p class="text-sm text-gray-500 dark:text-gray-400">Choose a composition to load</p>
  `;const s=document.createElement("div");s.className="max-h-64 overflow-y-auto px-6 py-4",e.forEach((a,l)=>{const d=document.createElement("div");d.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const c=new Date(a.saved||a.metadata.created).toLocaleDateString(),u=document.createElement("div");u.className="flex items-center justify-between";const m=document.createElement("button");m.className="flex-1 text-left",m.innerHTML=`
      <div class="font-medium text-gray-900 dark:text-gray-100">${a.metadata.name}</div>
      <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${c}</div>
    `,m.onclick=()=>{ne(a),document.body.removeChild(t)};const b=document.createElement("button");b.className="ml-3 px-2 py-1 text-red-600 hover:bg-red-100 dark:hover:bg-slate-800 rounded transition-colors text-sm",b.innerHTML="ðŸ—‘ï¸",b.title="Delete composition",b.onclick=f=>{f.stopPropagation(),gt(a,t,()=>{document.body.removeChild(t),Le()})},u.appendChild(m),u.appendChild(b),d.appendChild(u),s.appendChild(d)});const n=document.createElement("div");n.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const i=document.createElement("button");i.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",i.textContent="Cancel",i.onclick=()=>document.body.removeChild(t),n.appendChild(i),o.appendChild(r),o.appendChild(s),o.appendChild(n),t.appendChild(o),document.body.appendChild(t),t.onclick=a=>{a.target===t&&document.body.removeChild(t)}}async function ft(){try{if((await V()).length===0){x("No saved compositions found in browser","info");return}const t=document.createElement("div");t.className="fixed inset-0 bg-black/50 dark:bg-black/60 z-50 flex items-center justify-center";const o=document.createElement("div");o.className="bg-white dark:bg-slate-800 border border-gray-300 dark:border-gray-700 rounded-lg shadow-xl max-w-md w-full mx-4 max-h-108 overflow-hidden";const r=document.createElement("div");r.className="px-6 py-4 border-b border-gray-200 dark:border-gray-700",r.innerHTML=`
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Manage Saved Compositions</h3>
      <p class="text-sm text-gray-500 dark:text-gray-400">Load or delete your saved compositions</p>
    `;const s=document.createElement("div");s.className="max-h-64 overflow-y-auto px-6 py-4";const n=async()=>{const l=await V();if(s.innerHTML="",l.length===0){s.innerHTML='<p class="text-gray-500 dark:text-gray-400 text-center py-8">No compositions saved</p>';return}l.forEach(d=>{const c=document.createElement("div");c.className="border border-gray-200 dark:border-gray-700 rounded mb-2 p-3 hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors";const u=new Date(d.saved||d.metadata.created).toLocaleDateString(),m=document.createElement("div");m.className="flex items-center justify-between";const b=document.createElement("div");b.className="flex-1",b.innerHTML=`
          <div class="font-medium text-gray-900 dark:text-gray-100">${d.metadata.name}</div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Saved: ${u}</div>
        `;const f=document.createElement("div");f.className="flex gap-2 ml-3";const h=document.createElement("button");h.className="px-3 py-1 bg-blue-600 hover:bg-blue-700 dark:bg-blue-500 dark:hover:bg-blue-600 text-white rounded text-sm transition-colors",h.textContent="Load",h.onclick=()=>{ne(d),document.body.removeChild(t)};const g=document.createElement("button");g.className="px-3 py-1 bg-red-600 hover:bg-red-700 dark:bg-red-500 dark:hover:bg-red-600 text-white rounded text-sm transition-colors",g.textContent="Delete",g.onclick=async()=>{if(confirm(`Delete "${d.metadata.name}"?`))try{await ae(d.id),x(`"${d.metadata.name}" deleted`,"success"),n()}catch(v){console.error("Delete failed:",v),x("Failed to delete composition","error")}},f.appendChild(h),f.appendChild(g),m.appendChild(b),m.appendChild(f),c.appendChild(m),s.appendChild(c)})};await n();const i=document.createElement("div");i.className="px-6 py-4 border-t border-gray-200 dark:border-gray-700 flex justify-end";const a=document.createElement("button");a.className="px-4 py-2 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-800 rounded transition-colors",a.textContent="Close",a.onclick=()=>document.body.removeChild(t),i.appendChild(a),o.appendChild(r),o.appendChild(s),o.appendChild(i),t.appendChild(o),document.body.appendChild(t),t.onclick=l=>{l.target===t&&document.body.removeChild(t)}}catch(e){console.error("Failed to load compositions:",e),x("Failed to load compositions from browser","error")}}function pt(){dt()}document.addEventListener("DOMContentLoaded",()=>{K().catch(console.error),window.saveComposition=ut,window.saveCompositionToComputer=mt,window.loadComposition=pt,window.loadFromBrowser=Le,window.manageCompositions=ft,window.clearAllGrids=Ce,window.getAllCompositions=V,window.deleteFromBrowser=ae,window.showNotification=x,console.log("Storage functionality initialized")});console.log("Storage module loaded");
